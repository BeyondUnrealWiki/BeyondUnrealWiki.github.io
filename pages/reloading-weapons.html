<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  "http://www.w3.org/TR/html4/loose.dtd">

<html>
<head lang="en">
	<title>UnrealWiki: Reloading Weapons</title>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
	<link rel="stylesheet" type="text/css" media="screen, print"
		href="shared/stylebase.structural.css">	
	<link rel="stylesheet" type="text/css" media="screen"
		href="shared/template-default.css">
	<link rel="stylesheet" type="text/css" media="screen"
		href="shared/styles.chblue.css">
	<link rel="stylesheet" type="text/css" media="print"
		href="shared/template-default-print.css">
	<!--[if IE 6]>
			<style>
			/* dirty hack for IE6. */
			#quickbar {
				position: absolute;
				}
			</style>
	<![endif]-->
  <link rel="start" href="http://wiki.beyondunreal.com/">
  <link rel="glossary"  href="http://wiki.beyondunreal.com/wiki/Terminology">
  <link rel="help"  href="http://wiki.beyondunreal.com/wiki/Using_The_Wiki">
<script type="text/javascript" src="shared/dhtml.js"></script>
<script type="text/javascript" src="shared/dhtml-menu.js"></script>
<style type="text/css">#dhtml-menu    { background: #eee; padding: 5px 0px; margin-right: -20px; border: 1px solid #888; border-left: 1px solid #ccc; border-top: 1px solid #ccc;  border-right: 1px solid #888; border-bottom: 1px solid #888 }
#dhtml-menu td { color: #000; font-family: Arial,Helvetica,sans-serif; font-size: 9pt; line-height: 13pt; padding: 1px 10px; cursor: default }
#dhtml-menu a  { color: #000; font-family: Arial,Helvetica,sans-serif; font-size: 9pt; line-height: 13pt; text-decoration: none }
#dhtml-menu tt { font-family: monospace; font-size: 9pt }
#dhtml-menu-separator { height: 1px; background: red }
#dhtml-menu-anchor { cursor: default }
</style>
<script type="text/javascript" src="shared/expandable.js"></script>
</head>
<body onLoad="menuInit(); document.cookie='page=Reloading_Weapons; path=/'" class="default">
<div id="scrolling"><!-- contains all except the fixed sidebar -->
<div id="topbar"  class="bar">
	<div class="righthalf">
		<form class="inline" method="post" action="/wiki" enctype="application/x-www-form-urlencoded"><input type="text" name="search"  size="20" /> <input type="submit" name="search" value="search" /></form>
	</div>
	<div class="lefthalf">
		<script type="text/javascript"><!--
			menuAlignRight = false;
		//--></script>
		<span><script type="text/javascript"><!--
 menuWriteAnchor("Quick Navigation") //--></script></span> | <a href="../index.html">Home Page</a> | <a href="recent-changes.html">Recent Changes</a>
	</div>
</div>

<div id="content"><!-- contains the title and article -->
	<h1 class='pagetitle'><a href="http://wiki.beyondunreal.com/wiki?back=Reloading Weapons">Reloading Weapons</a></h1>
	<div class="wiki"><p><em class="em1">This tutorial does NOT work in UT2004.</em></p>
<p><em class="em1">Attempted offline fix. No test, just using my memory... -Solid Snake</em></p>
<h2><a name="0.1"></a>Reloading Weapons.</h2>
<p>I've put quite a bit of effort in to making robust reloading code for the <a href="weapon.html">Weapon</a>s in the LawDogs mod. Since reloading is something that is potentially useful to everyone, I have made the code available here (minus all the stuff that doesn't relate to reloading).</p>
<p>It is complete with features allowing for sounds, animations and other effects, it works on-line and as far as I can tell it is virtually free of bugs. All the main code is contained in a weapon class. It is an abstract class, the actual weapons are subclasses of it.</p>
<pre class="uscript"><span class="uscript-keyword">class</span> ReloadingWeapon <span class="uscript-keyword">extends</span> Weapon
    <span class="uscript-keyword">abstract</span><span class="uscript-operator">;</span>

<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">int</span> ClipCount<span class="uscript-operator">;</span> <span class="uscript-comment">//What's that you say? Clip is not a technically correct term? Do I care?</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span> ReloadRate<span class="uscript-operator">;</span> <span class="uscript-comment">//Time it takes to insert one bullet.</span>
<span class="uscript-keyword">var</span> <span class="uscript-type">float</span> ReloadTimer<span class="uscript-operator">;</span>

<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> sound ReloadBeginSound<span class="uscript-operator">,</span> ReloadSound<span class="uscript-operator">,</span> ReloadEndSound<span class="uscript-operator">;</span> <span class="uscript-comment">//Sounds played when start to reload, on insertion of each bullet, and when reloading has ended.</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">name</span> ReloadAnim<span class="uscript-operator">;</span> <span class="uscript-comment">//Animation to play when reloading is started.</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span> ReloadAnimRate<span class="uscript-operator">;</span>

<span class="uscript-keyword">var</span> <span class="uscript-type">bool</span> bIsReloading<span class="uscript-operator">,</span> bReloadEffectDone<span class="uscript-operator">;</span>

<span class="uscript-keyword">replication</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">reliable</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Role <span class="uscript-operator">==</span> ROLE_Authority<span class="uscript-operator">)</span>
        ClipCount<span class="uscript-operator">;</span>

    <span class="uscript-comment">//Functions called on the server from the client.</span>
    <span class="uscript-keyword">reliable</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Role <span class="uscript-operator">&lt;</span> ROLE_Authority<span class="uscript-operator">)</span>
        ReloadMeNow<span class="uscript-operator">,</span> FinishReloading<span class="uscript-operator">;</span>

    <span class="uscript-comment">//Functions called on the client from the server.</span>
    <span class="uscript-keyword">reliable</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Role <span class="uscript-operator">==</span> ROLE_Authority<span class="uscript-operator">)</span>
        ClientReload<span class="uscript-operator">,</span> ClientFinishReloading<span class="uscript-operator">,</span> ClientReloadEffects<span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-comment">//So reloading can be bound to a key. Exec functions in weapons can only be called for the currently held weapon, which is perfect for this purpose.</span>
<span class="uscript-keyword">exec</span> <span class="uscript-keyword">function</span> ReloadMeNow<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>AllowReload<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">)</span>
        <span class="uscript-keyword">return</span><span class="uscript-operator">;</span>

    bIsReloading <span class="uscript-operator">=</span> <span class="uscript-keyword">true</span><span class="uscript-operator">;</span>
    ReloadTimer <span class="uscript-operator">=</span> Level<span class="uscript-operator">.</span>TimeSeconds<span class="uscript-operator">;</span>
    PlaySound<span class="uscript-operator">(</span>ReloadBeginSound<span class="uscript-operator">,</span> SLOT_Misc<span class="uscript-operator">,</span> TransientSoundVolume<span class="uscript-operator">,</span><span class="uscript-operator">,</span><span class="uscript-operator">,</span><span class="uscript-operator">,</span> <span class="uscript-keyword">false</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    ClientReload<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-comment">//Called on the client when reloading starts.</span>
<span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> ClientReload<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    bIsReloading <span class="uscript-operator">=</span> <span class="uscript-keyword">true</span><span class="uscript-operator">;</span>
    PlayAnim<span class="uscript-operator">(</span>ReloadAnim<span class="uscript-operator">,</span> ReloadAnimRate<span class="uscript-operator">,</span> <span class="uscript-number">0.1</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-comment">//For effects during reloading, like smoke or shells ejected from the breech.</span>
<span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> ClientReloadEffects<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">{</span><span class="uscript-operator">}</span>

<span class="uscript-comment">//Reloading ends when the key is released.</span>
<span class="uscript-keyword">exec</span> <span class="uscript-keyword">function</span> FinishReloading<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bIsReloading<span class="uscript-operator">)</span>
        <span class="uscript-keyword">return</span><span class="uscript-operator">;</span>

    PlaySound<span class="uscript-operator">(</span>ReloadEndSound<span class="uscript-operator">,</span> SLOT_Misc<span class="uscript-operator">,</span> TransientSoundVolume<span class="uscript-operator">,</span><span class="uscript-operator">,</span><span class="uscript-operator">,</span><span class="uscript-operator">,</span> <span class="uscript-keyword">false</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    ClientFinishReloading<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    bIsReloading <span class="uscript-operator">=</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
    bReloadEffectDone <span class="uscript-operator">=</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-comment">//Called on the client when reloading ends.</span>
<span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> ClientFinishReloading<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    bIsReloading <span class="uscript-operator">=</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
    PlayIdle<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Instigator<span class="uscript-operator">.</span>PendingWeapon <span class="uscript-operator">!=</span> <span class="uscript-keyword">None</span> <span class="uscript-operator">&amp;&amp;</span> Instigator<span class="uscript-operator">.</span>PendingWeapon <span class="uscript-operator">!=</span> <span class="uscript-keyword">self</span><span class="uscript-operator">)</span>
        Instigator<span class="uscript-operator">.</span>Controller<span class="uscript-operator">.</span>ClientSwitchToBestWeapon<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-comment">//I compressed this to make it a little tider. I have no idea why I do this... is it harder to read or </span>
<span class="uscript-comment">//do I just like smaller UC files...</span>
<span class="uscript-keyword">function</span> <span class="uscript-type">bool</span> AllowReload<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-comment">//Can't reload whilst firing, reloading, if the clip is full or if we don't have enough ammo.</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">(</span>FireMode<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">.</span>IsFiring<span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-operator">||</span> FireMode<span class="uscript-operator">[</span><span class="uscript-number">1</span><span class="uscript-operator">]</span><span class="uscript-operator">.</span>IsFiring<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">)</span> <span class="uscript-operator">&amp;&amp;</span> 
           bIsReloading <span class="uscript-operator">&amp;&amp;</span> ClipCount <span class="uscript-operator">&gt;=</span> <span class="uscript-keyword">Default</span><span class="uscript-operator">.</span>ClipCount <span class="uscript-operator">&amp;&amp;</span> 
           <span class="uscript-operator">(</span>Ammo<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span> <span class="uscript-operator">==</span> <span class="uscript-keyword">None</span> <span class="uscript-operator">||</span> Ammo<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">.</span>AmmoAmount <span class="uscript-operator">&lt;=</span> ClipCount<span class="uscript-operator">)</span><span class="uscript-operator">)</span>
        <span class="uscript-keyword">return</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
    <span class="uscript-keyword">return</span> <span class="uscript-keyword">true</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-comment">//Don't allow weapon switching whilst reloading.</span>
<span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> <span class="uscript-type">bool</span> PutDown<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bIsReloading<span class="uscript-operator">)</span>
        <span class="uscript-keyword">return</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>

    <span class="uscript-keyword">return</span> <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>PutDown<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> BringUp<span class="uscript-operator">(</span><span class="uscript-keyword">optional</span> Weapon PrevWeapon<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>BringUp<span class="uscript-operator">(</span>PrevWeapon<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    bIsReloading <span class="uscript-operator">=</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-comment">//Reduce ClipCount every time a bullet is fired.</span>
<span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> <span class="uscript-type">bool</span> ConsumeAmmo<span class="uscript-operator">(</span><span class="uscript-type">int</span> Mode<span class="uscript-operator">,</span> <span class="uscript-type">float</span> load<span class="uscript-operator">,</span> <span class="uscript-keyword">optional</span> <span class="uscript-type">bool</span> bAmountNeededIsMax<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Ammo<span class="uscript-operator">[</span>Mode<span class="uscript-operator">]</span> <span class="uscript-operator">!=</span> <span class="uscript-keyword">None</span><span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Ammo<span class="uscript-operator">[</span>Mode<span class="uscript-operator">]</span><span class="uscript-operator">.</span>UseAmmo<span class="uscript-operator">(</span><span class="uscript-type">int</span><span class="uscript-operator">(</span>load<span class="uscript-operator">)</span><span class="uscript-operator">)</span> <span class="uscript-operator">&amp;&amp;</span> load <span class="uscript-operator">&gt;</span> <span class="uscript-number">0</span><span class="uscript-operator">)</span>
            ClipCount<span class="uscript-operator">--</span><span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>
<span class="uscript-operator">}</span>

<span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> <span class="uscript-type">bool</span> HasAmmo<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-comment">//Ignore FireMode[1] which doesn't use any ammo.</span>
    <span class="uscript-keyword">return</span> <span class="uscript-operator">(</span>Ammo<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span> <span class="uscript-operator">!=</span> <span class="uscript-keyword">None</span> <span class="uscript-operator">&amp;&amp;</span> FireMode<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span> <span class="uscript-operator">!=</span> <span class="uscript-keyword">None</span> <span class="uscript-operator">&amp;&amp;</span> Ammo<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">.</span>AmmoAmount <span class="uscript-operator">&gt;=</span> FireMode<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">.</span>AmmoPerFire<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-keyword">event</span> WeaponTick<span class="uscript-operator">(</span><span class="uscript-type">float</span> dt<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bIsReloading<span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-comment">//Stupid bots like to run around with an empty weapon, so force them to reload when appropriate.</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>Instigator<span class="uscript-operator">.</span>IsHumanControlled<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
            <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Level<span class="uscript-operator">.</span>TimeSeconds <span class="uscript-operator">-</span> Instigator<span class="uscript-operator">.</span>Controller<span class="uscript-operator">.</span>LastSeenTime <span class="uscript-operator">&gt;</span> ClipCount<span class="uscript-operator">)</span>
                ReloadMeNow<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>
    <span class="uscript-operator">}</span>
    <span class="uscript-keyword">else</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-comment">//Add one bullet at a time as long as reloading key is held down.</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Level<span class="uscript-operator">.</span>TimeSeconds <span class="uscript-operator">-</span> ReloadTimer <span class="uscript-operator">&gt;=</span> ReloadRate<span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
            <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>ClipCount <span class="uscript-operator">&gt;=</span> <span class="uscript-keyword">Default</span><span class="uscript-operator">.</span>ClipCount<span class="uscript-operator">)</span> <span class="uscript-comment">//Full.</span>
            <span class="uscript-operator">{</span>
                ClipCount <span class="uscript-operator">=</span> <span class="uscript-keyword">Default</span><span class="uscript-operator">.</span>ClipCount<span class="uscript-operator">;</span>
                FinishReloading<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
            <span class="uscript-operator">}</span>
            <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Ammo<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">.</span>AmmoAmount <span class="uscript-operator">&lt;=</span> ClipCount<span class="uscript-operator">)</span> <span class="uscript-comment">//Out of ammo.</span>
            <span class="uscript-operator">{</span>
                ClipCount <span class="uscript-operator">=</span> Ammo<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">.</span>AmmoAmount<span class="uscript-operator">;</span>
                FinishReloading<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
            <span class="uscript-operator">}</span>
            <span class="uscript-keyword">else</span> <span class="uscript-comment">//Add another bullet.</span>
            <span class="uscript-operator">{</span>
                PlaySound<span class="uscript-operator">(</span>ReloadSound<span class="uscript-operator">,</span> SLOT_Misc<span class="uscript-operator">,</span> TransientSoundVolume<span class="uscript-operator">,</span><span class="uscript-operator">,</span><span class="uscript-operator">,</span><span class="uscript-operator">,</span> <span class="uscript-keyword">false</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                InsertBullet<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

                <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>ClipCount <span class="uscript-operator">&gt;=</span> <span class="uscript-keyword">Default</span><span class="uscript-operator">.</span>ClipCount<span class="uscript-operator">)</span>
                <span class="uscript-operator">{</span>
                    ReloadTimer <span class="uscript-operator">=</span> Level<span class="uscript-operator">.</span>TimeSeconds <span class="uscript-operator">-</span> <span class="uscript-operator">(</span>ReloadRate <span class="uscript-operator">/</span> <span class="uscript-number">2</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                <span class="uscript-operator">}</span>
                <span class="uscript-keyword">else</span>
                    ReloadTimer <span class="uscript-operator">=</span> Level<span class="uscript-operator">.</span>TimeSeconds<span class="uscript-operator">;</span>
            <span class="uscript-operator">}</span>
        <span class="uscript-operator">}</span>
        <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bReloadEffectDone <span class="uscript-operator">&amp;&amp;</span> Level<span class="uscript-operator">.</span>TimeSeconds <span class="uscript-operator">-</span> ReloadTimer <span class="uscript-operator">&gt;=</span> ReloadRate <span class="uscript-operator">/</span> <span class="uscript-number">2</span><span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
            bReloadEffectDone <span class="uscript-operator">=</span> <span class="uscript-keyword">true</span><span class="uscript-operator">;</span>
            ClientReloadEffects<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>
    <span class="uscript-operator">}</span>
<span class="uscript-operator">}</span>

<span class="uscript-comment">//Can play animations for inserting individual bullets here, or other effects. </span>
<span class="uscript-comment">//Server-side only, so should call a replicated function here and play animations in it, </span>
<span class="uscript-comment">//rather than in this function itself.</span>
<span class="uscript-keyword">function</span> InsertBullet<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    ClipCount<span class="uscript-operator">++</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-comment">//Show how many bullets left until reload.</span>
<span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> <span class="uscript-type">float</span> ChargeBar<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">local</span> <span class="uscript-type">float</span> CurrentClip<span class="uscript-operator">,</span> MaxClip<span class="uscript-operator">;</span>

    <span class="uscript-comment">//Store the int values as floats to avoid rounding errors.</span>
    CurrentClip <span class="uscript-operator">=</span> ClipCount<span class="uscript-operator">;</span>
    MaxClip <span class="uscript-operator">=</span> <span class="uscript-keyword">Default</span><span class="uscript-operator">.</span>ClipCount<span class="uscript-operator">;</span>

    <span class="uscript-keyword">return</span> FMin<span class="uscript-operator">(</span><span class="uscript-number">1</span><span class="uscript-operator">,</span> CurrentClip<span class="uscript-operator">/</span>MaxClip<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-keyword">function</span> <span class="uscript-type">byte</span> BestMode<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>ClipCount <span class="uscript-operator">&gt;</span> <span class="uscript-number">0</span><span class="uscript-operator">)</span>
        <span class="uscript-keyword">return</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>

    <span class="uscript-keyword">return</span> <span class="uscript-number">1</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-keyword">defaultproperties</span>
<span class="uscript-operator">{</span>
    ClipCount<span class="uscript-operator">=</span><span class="uscript-number">6</span>
    ReloadRate<span class="uscript-operator">=</span><span class="uscript-number">1.0</span>
    ReloadAnim<span class="uscript-operator">=</span>Reload
    ReloadAnimRate<span class="uscript-operator">=</span><span class="uscript-number">1.0</span>

    bShowChargingBar<span class="uscript-operator">=</span><span class="uscript-keyword">True</span>
<span class="uscript-operator">}</span></pre><p>Bullets are inserted one at a time. If you wanted to completely fill the weapon in one go (as would be the case with most modern-style weapons) then change the bit in the InsertBullet function to <em class="em2">ClipCount = Default.ClipCount</em></p>
<p>To have reloading triggered from a key press, two functions need to be bound to one key. For example, in User.ini:</p>
<p><em class="em2">E=ReloadMeNow | OnRelease FinishReloading</em></p>
<p>To make it easier to bind for end-users, you can make a custom <a href="guiuserkeybinding.html">GUIUserKeyBinding</a>, which will make the bind show up in the controls menu. Here is an example:</p>
<pre class="uscript"><span class="uscript-keyword">class</span> ReloadBinding <span class="uscript-keyword">extends</span> GUIUserKeyBinding<span class="uscript-operator">;</span>

<span class="uscript-keyword">defaultproperties</span>
<span class="uscript-operator">{</span>
    KeyData<span class="uscript-operator">(</span><span class="uscript-number">0</span><span class="uscript-operator">)</span><span class="uscript-operator">=</span><span class="uscript-operator">(</span>KeyLabel<span class="uscript-operator">=</span><span class="uscript-string">"YourMod"</span><span class="uscript-operator">,</span>bIsSection<span class="uscript-operator">=</span><span class="uscript-keyword">True</span><span class="uscript-operator">)</span>
    KeyData<span class="uscript-operator">(</span><span class="uscript-number">1</span><span class="uscript-operator">)</span><span class="uscript-operator">=</span><span class="uscript-operator">(</span>Alias<span class="uscript-operator">=</span><span class="uscript-string">"ReloadMeNow | OnRelease FinishReloading"</span><span class="uscript-operator">,</span>KeyLabel<span class="uscript-operator">=</span><span class="uscript-string">"Reload"</span><span class="uscript-operator">)</span>
<span class="uscript-operator">}</span></pre><p>As well as reloading from a key, it can also be done from alt-fire, like this:</p>
<pre class="uscript"><span class="uscript-keyword">class</span> ReloadFire <span class="uscript-keyword">extends</span> WeaponFire<span class="uscript-operator">;</span>

<span class="uscript-keyword">event</span> ModeDoFire<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    ReloadingWeapon<span class="uscript-operator">(</span>Weapon<span class="uscript-operator">)</span><span class="uscript-operator">.</span>ReloadMeNow<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-keyword">function</span> StopFiring<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    ReloadingWeapon<span class="uscript-operator">(</span>Weapon<span class="uscript-operator">)</span><span class="uscript-operator">.</span>FinishReloading<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-keyword">function</span> <span class="uscript-type">bool</span> IsFiring<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">return</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span>

<span class="uscript-keyword">defaultproperties</span>
<span class="uscript-operator">{</span>
    bModeExclusive<span class="uscript-operator">=</span><span class="uscript-keyword">true</span>
    bWaitForRelease<span class="uscript-operator">=</span><span class="uscript-keyword">true</span>
    FireRate<span class="uscript-operator">=</span><span class="uscript-number">0.2</span>
    BotRefireRate<span class="uscript-operator">=</span><span class="uscript-number">1.0</span>
    AmmoClass<span class="uscript-operator">=</span><span class="uscript-keyword">class</span><span class="uscript-name">'BallAmmo'</span>
<span class="uscript-operator">}</span></pre><p>Last but not least, to ensure that the firemode(s) can only fire whilst there is ammo in the clip:</p>
<pre class="uscript"><span class="uscript-keyword">class</span> ReloadFire <span class="uscript-keyword">extends</span> ProjectileFire
    <span class="uscript-keyword">abstract</span><span class="uscript-operator">;</span>

<span class="uscript-keyword">var</span> <span class="uscript-type">float</span> LastClickTime<span class="uscript-operator">;</span>

<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">Name</span> EmptyAnim<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span> EmptyAnimRate<span class="uscript-operator">;</span>

<span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> <span class="uscript-type">bool</span> AllowFire<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>ReloadingWeapon<span class="uscript-operator">(</span>Weapon<span class="uscript-operator">)</span><span class="uscript-operator">.</span>bIsReloading<span class="uscript-operator">)</span>
        <span class="uscript-keyword">return</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>

    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>ReloadingWeapon<span class="uscript-operator">(</span>Weapon<span class="uscript-operator">)</span><span class="uscript-operator">.</span>ClipCount <span class="uscript-operator">&lt;</span> <span class="uscript-number">1</span><span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Level<span class="uscript-operator">.</span>TimeSeconds <span class="uscript-operator">-</span> LastClickTime <span class="uscript-operator">&gt;</span> FireRate<span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
            Weapon<span class="uscript-operator">.</span>PlayOwnedSound<span class="uscript-operator">(</span>NoAmmoSound<span class="uscript-operator">,</span> SLOT_Interact<span class="uscript-operator">,</span> TransientSoundVolume<span class="uscript-operator">,</span><span class="uscript-operator">,</span><span class="uscript-operator">,</span><span class="uscript-operator">,</span> <span class="uscript-keyword">false</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
            LastClickTime <span class="uscript-operator">=</span> Level<span class="uscript-operator">.</span>TimeSeconds<span class="uscript-operator">;</span>

            <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Weapon<span class="uscript-operator">.</span>HasAnim<span class="uscript-operator">(</span>EmptyAnim<span class="uscript-operator">)</span><span class="uscript-operator">)</span>
                weapon<span class="uscript-operator">.</span>PlayAnim<span class="uscript-operator">(</span>EmptyAnim<span class="uscript-operator">,</span> EmptyAnimRate<span class="uscript-operator">,</span> <span class="uscript-number">0.0</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>

        <span class="uscript-keyword">return</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>

    LastClickTime <span class="uscript-operator">=</span> Level<span class="uscript-operator">.</span>TimeSeconds<span class="uscript-operator">;</span>

    <span class="uscript-keyword">return</span> <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>AllowFire<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

<span class="uscript-operator">}</span></pre><p>In this case it is a <a href="projectilefire.html">ProjectileFire</a>, but it applies exactly the same for <a href="instantfire.html">InstantFire</a> classes.</p>
<p><a href="category-tutorial.html">Category Tutorial</a></p>
<p><em class="em2">Stagger:</em> Does not seem to like UT2004 or vice versa. Does not compile as-is, spits out error over difference between consumeammo in reloadingweapon and weapon classes. Tried simply renaming consumeammo function, compiled successfully, but cannot select reloading weapon in game, gives the "(weapon name) is out of ammo" message, even if you enter allammo code.</p>
<p><em class="em2">Tarquin:</em> Do you people not LOOK at what happens after you have posted? Please reformat your text, it is currently unreadable.</p>
<p><em class="em2">Tarquin:</em> see <a href="http://forums.beyondunreal.com/showthread.php?t=141177">http://forums.beyondunreal.com/showthread.php?t=141177</a>  seems the code for this tute has a problem.</p>
<p><em class="em2">Solid Snake:</em> I wonder if that works. I doubt it...</p>
<p><em class="em2">MythOpus:</em> Stagger:  It keeps saying the out of ammo message because you don't have a proper AmmoClass in the default properties of the weapon fire...  If you subclass your weapons from the custom code above and add an ammo class it should work. Solid Snake:  This code DOES work... just not too well <img alt=":)" src="emoticons/smile.gif" align="middle">  </p>
<p><em class="em2">Solid Snake:</em> Great, I just did some syntax fixes. When I whack in my own reloading code, I'll post it here as well. This one is a shotgun type reloading I think, a bullet at a time. I'll be doing both methods I think.</p>
<p><em class="em2">MythOpus:</em> That explains a whole lot.  I tried using this code for one of my mods awhile back... I used it for an assault rifle and it didn't work too well... I guess I know why now... Didn't think about it being for a shotgun <img alt=":(" src="emoticons/sad.gif" align="middle">.  I cant wait for YOUR reloading code Though <img alt=":D" src="emoticons/biggrin.gif" align="middle"></p>
<p><em class="em2">Benoît</em> Ce tut est vraiment sympa, ca fait un bout de temps que je cherche de la doc sur les replications. Merci. / This tut's really great. I've been looking for good tuts about replications for a while. Thanks.</p>
<p><em class="em2">Benoît</em> : Are you sure about the declaration 'simulated function bool ConsumeAmmo(int Mode, float load, optional bool bAmountNeededIsMax)' (signature needed : function ConsumeAmmo(int Mode, float load)) ? I had a compilation error and had to modify a bit, but the rest works fine <img alt=":)" src="emoticons/smile.gif" align="middle"></p>
<p><em class="em2">Switch`:</em> To make it work with UT2004's bNoAmmoInstances feature you may try following changes: (untested!)</p>
<ol><li>Replace all instances of <tt>Ammo[0].AmmoAmount</tt> with <tt>AmmoAmount(0)</tt></li>
<li>Replace all instances of <tt>Ammo[0]==None</tt> with <tt>AmmoAmount(0)==0</tt></li>
<li>Remove the overloaded HasAmmo() function from ReloadingWeapon source, in FireMode[1] set AmmoPerFire=0 in defaultproperties  </li>
<li>Use Super.ConsumeAmmo()</li>
</ol>
<pre class="uscript"><span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> <span class="uscript-type">bool</span> ConsumeAmmo<span class="uscript-operator">(</span> <span class="uscript-type">int</span> Mode<span class="uscript-operator">,</span> <span class="uscript-type">float</span> Load<span class="uscript-operator">,</span> <span class="uscript-keyword">optional</span> <span class="uscript-type">bool</span> bAmountNeededIsMax <span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span> <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>ConsumeAmmo<span class="uscript-operator">(</span>Mode<span class="uscript-operator">,</span> Load<span class="uscript-operator">,</span> bAmountNeededIsMax<span class="uscript-operator">)</span> <span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span> Load <span class="uscript-operator">&gt;</span> <span class="uscript-number">0</span> <span class="uscript-operator">)</span>
            ClipCount<span class="uscript-operator">--</span><span class="uscript-operator">;</span>
        <span class="uscript-keyword">return</span> <span class="uscript-keyword">true</span><span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>
    <span class="uscript-keyword">return</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><p><em class="em2">Kohan:</em> Bleh, it's not a magazine-based one.  Can I warp some of your code to make it magazine-based?  I'd put it in a separate tutorial, of course.</p>
<p><em class="em2">OlympusMons:</em> Yeah clipcount is alittle misleading as it is actually the amount of ammo in the clip, a quick fix would be to do this so when you reload the complete ammo is added in one hit. This is untested but you could try...</p>
<pre class="uscript"><span class="uscript-keyword">function</span> InsertBullet<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">{</span>
    ClipCount<span class="uscript-operator">=</span><span class="uscript-keyword">Default</span><span class="uscript-operator">.</span>ClipCount<span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><p>For a better version you could make clipcount the amount of clips by doing ammo amount x ammo per clip, which should give you the amount of clips. Then you can make a ammo in clip variable which would replace the old clipcount, Im kinda thinking out loud here so you'll have to work it out alittle more perhaps. Im pretty sure Im going in the right direction, there is replication to take into consideration as well I think.</p>
<script type="text/javascript"><!--
 menuItemAdd("Reloading Weapons.", "#0.1");
 menuWrite() //--></script></div>
</div>

<div id="footer" class="bar">
	<p><form method="post" action="http://wiki.beyondunreal.com/wiki" enctype="application/x-www-form-urlencoded">
<a href="../index.html">Home Page</a> | <a href="recent-changes.html">Recent Changes</a><br>
Last edited August 24, 2006 12:29 <a href="http://wiki.beyondunreal.com/wiki?action=browse&diff=1&id=Reloading_Weapons">(diff)</a><br>Search: <input type="text" name="search"  size="20" /><input type="hidden" name="dosearch" value="1"  /><br><br><small><a href="http://wiki.beyondunreal.com/wiki/Reloading_Weapons">Original page</a> &#150; copy created Sat, Jun 23, 2007</small><div></div>
</form>
	</p>
	<p>Gah - a solution with more questions. (EntropicLqd)
</p>
</div>
</div><!-- close of "scrolling" div -->

<div id="quickbar">
	<div id="logo"><a href="../index.html"><img src="shared/wikilogo.jpg" width="143" height="100" border="0"></a>
		</div>
	<div class="qbsitename">
		<p>The Unreal Engine Documentation Site</p>
	</div>
	<div class="qbsection">
<p><a href="metatopics.html">Wiki Community</a></p>
<p><a href="category-category.html">Topic Categories</a></p>


<p><a href="recent-changes.html">Recent Changes</a></p>
<p><a href="offline-wiki.html">Offline Wiki</a></p>
</div><div class="qbsection">
<p><a href="unreal-engine.html">Unreal Engine</a></p>
<p><a href="console-commands.html">Console Commands</a></p>
<p><a href="terminology.html">Terminology</a></p>
<p><a href="category-faq.html">FAQs</a></p>
<p><a href="help-desk.html">Help Desk</a></p>
</div><div class="qbsection">
<p><a href="topics-on-mapping.html">Mapping Topics</a></p>
<p><a href="mapping-lessons.html">Mapping Lessons</a></p>
<p><a href="unrealed-3.html">UnrealEd Interface</a></p>
</div><div class="qbsection">
<p><a href="unrealscript.html">UnrealScript Topics</a></p>
<p><a href="unrealscript-lessons.html">UnrealScript Lessons</a></p>
<p><a href="making-mods.html">Making Mods</a></p>
<p><a href="class-tree.html">Class Tree</a></p>
</div><div class="qbsection">
<p><a href="topics-on-modeling.html">Modeling Topics</a></p>
</div><div class="qbsection">
<p><a href="chongqing-page.html">Chongqing Page</a></p>
<p><a href="log-in.html">Log In</a></p></div>
</div>

</body></html>
