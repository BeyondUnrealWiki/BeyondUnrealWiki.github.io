<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  "http://www.w3.org/TR/html4/loose.dtd">

<html>
<head lang="en">
	<title>UnrealWiki: Manual Shift Car/CPlusPlus Version</title>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
	<link rel="stylesheet" type="text/css" media="screen, print"
		href="shared/stylebase.structural.css">	
	<link rel="stylesheet" type="text/css" media="screen"
		href="shared/template-default.css">
	<link rel="stylesheet" type="text/css" media="screen"
		href="shared/styles.chblue.css">
	<link rel="stylesheet" type="text/css" media="print"
		href="shared/template-default-print.css">
	<!--[if IE 6]>
			<style>
			/* dirty hack for IE6. */
			#quickbar {
				position: absolute;
				}
			</style>
	<![endif]-->
  <link rel="start" href="http://wiki.beyondunreal.com/">
  <link rel="glossary"  href="http://wiki.beyondunreal.com/wiki/Terminology">
  <link rel="help"  href="http://wiki.beyondunreal.com/wiki/Using_The_Wiki">
<script type="text/javascript" src="shared/dhtml.js"></script>
<script type="text/javascript" src="shared/dhtml-menu.js"></script>
<style type="text/css">#dhtml-menu    { background: #eee; padding: 5px 0px; margin-right: -20px; border: 1px solid #888; border-left: 1px solid #ccc; border-top: 1px solid #ccc;  border-right: 1px solid #888; border-bottom: 1px solid #888 }
#dhtml-menu td { color: #000; font-family: Arial,Helvetica,sans-serif; font-size: 9pt; line-height: 13pt; padding: 1px 10px; cursor: default }
#dhtml-menu a  { color: #000; font-family: Arial,Helvetica,sans-serif; font-size: 9pt; line-height: 13pt; text-decoration: none }
#dhtml-menu tt { font-family: monospace; font-size: 9pt }
#dhtml-menu-separator { height: 1px; background: red }
#dhtml-menu-anchor { cursor: default }
</style>
<script type="text/javascript" src="shared/expandable.js"></script>
</head>
<body onLoad="menuInit(); document.cookie='page=Manual_Shift_Car/CPlusPlus_Version; path=/'" class="default">
<div id="scrolling"><!-- contains all except the fixed sidebar -->
<div id="topbar"  class="bar">
	<div class="righthalf">
		<form class="inline" method="post" action="/wiki" enctype="application/x-www-form-urlencoded"><input type="text" name="search"  size="20" /> <input type="submit" name="search" value="search" /></form>
	</div>
	<div class="lefthalf">
		<script type="text/javascript"><!--
			menuAlignRight = false;
		//--></script>
		<span><script type="text/javascript"><!--
 menuWriteAnchor("Quick Navigation") //--></script></span> | <a href="(start).html">Home Page</a> | <a href="recent-changes.html">Recent Changes</a> | <a href="http://wiki.beyondunreal.com/wiki?action=editprefs">Preferences</a>
	</div>
</div>

<div id="content"><!-- contains the title and article -->
	<h1 class='pagetitle'><a href="manual-shift-car.html">Manual Shift Car</a>/<a href="http://wiki.beyondunreal.com/wiki?back=Manual+Shift+Car/CPlusPlus+Version">CPlusPlus Version</a></h1>
	<div class="wiki"><h4><a name="0.0.0.1"></a>UpdateVehicle</h4>
<ul><li>This is so you can see what I started with in hopes you can derive something better someday <img alt=":)" src="emoticons/smile.gif" align="middle"></li>
</ul>
<pre class="uscript">void AONSWheeledCraft::UpdateVehicle<span class="uscript-operator">(</span><span class="uscript-type">FLOAT</span> DeltaTime<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    guard<span class="uscript-operator">(</span>AONSWheeledCraft::UpdateVehicle<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    <span class="uscript-comment">/////////// STEERING ///////////</span>

    <span class="uscript-type">FLOAT</span> maxSteerAngle <span class="uscript-operator">=</span> MaxSteerAngleCurve<span class="uscript-operator">.</span>Eval<span class="uscript-operator">(</span>Velocity<span class="uscript-operator">.</span>Size<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

#<span class="uscript-keyword">if</span> <span class="uscript-number">0</span>
    <span class="uscript-type">FLOAT</span> maxSteer <span class="uscript-operator">=</span> DeltaTime <span class="uscript-operator">*</span> SteerSpeed <span class="uscript-operator">*</span> maxSteerAngle<span class="uscript-operator">;</span>
#<span class="uscript-keyword">else</span>
    <span class="uscript-type">FLOAT</span> maxSteer <span class="uscript-operator">=</span> DeltaTime <span class="uscript-operator">*</span> SteerSpeed<span class="uscript-operator">;</span>
#endif

    <span class="uscript-type">FLOAT</span> deltaSteer<span class="uscript-operator">;</span>
    
    <span class="uscript-comment">// When using Jumping Vehicle mutator and holding down to jump, always steer straight.</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bPushDown<span class="uscript-operator">)</span>
        deltaSteer <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-operator">-</span>Steering <span class="uscript-operator">*</span> maxSteerAngle<span class="uscript-operator">)</span> <span class="uscript-operator">-</span> ActualSteering<span class="uscript-operator">;</span> <span class="uscript-comment">// Amount we want to move (target - current)</span>
    <span class="uscript-keyword">else</span>
        deltaSteer <span class="uscript-operator">=</span> <span class="uscript-operator">-</span>ActualSteering<span class="uscript-operator">;</span> 

    deltaSteer <span class="uscript-operator">=</span> Clamp<span class="uscript-operator">&lt;</span><span class="uscript-type">FLOAT</span><span class="uscript-operator">&gt;</span><span class="uscript-operator">(</span>deltaSteer<span class="uscript-operator">,</span> <span class="uscript-operator">-</span>maxSteer<span class="uscript-operator">,</span> maxSteer<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    ActualSteering <span class="uscript-operator">+=</span> deltaSteer<span class="uscript-operator">;</span>

    <span class="uscript-comment">/////////// ENGINE ///////////</span>

    <span class="uscript-comment">// Calculate torque at output of engine. Combination of throttle, current RPM and engine braaking.</span>
    <span class="uscript-type">FLOAT</span> EngineTorque <span class="uscript-operator">=</span> OutputGas <span class="uscript-operator">*</span> TorqueCurve<span class="uscript-operator">.</span>Eval<span class="uscript-operator">(</span> EngineRPM <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    <span class="uscript-type">FLOAT</span> EngineBraking <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-number">1</span><span class="uscript-operator">.</span>0f <span class="uscript-operator">-</span> OutputGas<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> <span class="uscript-operator">(</span>EngineBrakeRPMScale<span class="uscript-operator">*</span>EngineRPM <span class="uscript-operator">*</span> EngineBrakeRPMScale<span class="uscript-operator">*</span>EngineRPM <span class="uscript-operator">*</span> EngineBrakeFactor<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    EngineTorque <span class="uscript-operator">-=</span> EngineBraking<span class="uscript-operator">;</span>

    DebugInfo <span class="uscript-operator">=</span> FString::Printf<span class="uscript-operator">(</span>TEXT<span class="uscript-operator">(</span><span class="uscript-string">"OutputBrake: %f   EngineRPM: %f    EngineTorque: %f"</span><span class="uscript-operator">)</span><span class="uscript-operator">,</span> OutputBrake<span class="uscript-operator">,</span> EngineRPM<span class="uscript-operator">,</span> EngineTorque<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    <span class="uscript-comment">// Total gear ratio between engine and differential (ie before being split between wheels).</span>
    <span class="uscript-comment">// A higher gear ratio and the torque at the wheels is reduced.</span>
    <span class="uscript-type">FLOAT</span> EngineWheelRatio <span class="uscript-operator">=</span> GearRatios<span class="uscript-operator">[</span>Gear<span class="uscript-operator">]</span> <span class="uscript-operator">*</span> TransRatio<span class="uscript-operator">;</span>

    <span class="uscript-comment">// Reset engine RPM. We calculate this by adding the component of each wheel spinning.</span>
    <span class="uscript-type">FLOAT</span> NewTotalSpinVel<span class="uscript-operator">=</span><span class="uscript-number">0</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">;</span>
    EngineRPM <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">;</span>

    <span class="uscript-comment">// Do model for each wheel.</span>
    <span class="uscript-keyword">for</span><span class="uscript-operator">(</span><span class="uscript-type">INT</span> i<span class="uscript-operator">=</span><span class="uscript-number">0</span><span class="uscript-operator">;</span> i<span class="uscript-operator">&lt;</span>Wheels<span class="uscript-operator">.</span>Num<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span> i<span class="uscript-operator">++</span><span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        USVehicleWheel<span class="uscript-operator">*</span> vw <span class="uscript-operator">=</span> Wheels<span class="uscript-operator">(</span>i<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

        <span class="uscript-comment">/////////// DRIVE ///////////</span>

        <span class="uscript-comment">// Heuristic to divide torque up so that the wheels that are spinning slower get more of it.</span>
        <span class="uscript-comment">// Sum of LSDFactor across all wheels should be 1.</span>
        <span class="uscript-comment">// JTODO: Do we need to handle the case of vehicles with different size wheels?</span>
        <span class="uscript-type">FLOAT</span> LSDSplit<span class="uscript-operator">,</span> EvenSplit<span class="uscript-operator">,</span> UseSplit<span class="uscript-operator">;</span>

        EvenSplit <span class="uscript-operator">=</span> <span class="uscript-number">1</span><span class="uscript-operator">/</span>NumPoweredWheels<span class="uscript-operator">;</span>

        <span class="uscript-comment">// If no wheels are spinning, just do an even split.</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>TotalSpinVel <span class="uscript-operator">&gt;</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>1f<span class="uscript-operator">)</span>
            LSDSplit <span class="uscript-operator">=</span> <span class="uscript-operator">(</span>TotalSpinVel <span class="uscript-operator">-</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SpinVel<span class="uscript-operator">)</span><span class="uscript-operator">/</span><span class="uscript-operator">(</span><span class="uscript-operator">(</span>NumPoweredWheels<span class="uscript-number">-1</span><span class="uscript-operator">)</span> <span class="uscript-operator">*</span> TotalSpinVel<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        <span class="uscript-keyword">else</span>
            LSDSplit <span class="uscript-operator">=</span> EvenSplit<span class="uscript-operator">;</span>

        UseSplit <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-operator">(</span><span class="uscript-number">1</span><span class="uscript-operator">-</span>LSDFactor<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> EvenSplit<span class="uscript-operator">)</span> <span class="uscript-operator">+</span> <span class="uscript-operator">(</span>LSDFactor <span class="uscript-operator">*</span> LSDSplit<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

        <span class="uscript-comment">// Calculate Drive Torque : applied at wheels (ie after gearbox and differential)</span>
        <span class="uscript-comment">// This is an 'open differential' ie. equal torque to each wheel</span>
        <span class="uscript-type">FLOAT</span> DriveTorque <span class="uscript-operator">=</span> UseSplit <span class="uscript-operator">*</span> <span class="uscript-operator">(</span>EngineTorque <span class="uscript-operator">/</span> EngineWheelRatio<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

        <span class="uscript-comment">/////////// LONGITUDINAL ///////////</span>

        <span class="uscript-comment">// Calculate Grip Torque : longitudinal force against ground * distance of action (radius of tyre)</span>
        <span class="uscript-comment">// LongFrictionFunc is assumed to be reflected for negative Slip Ratio</span>
        <span class="uscript-type">FLOAT</span> GripTorque <span class="uscript-operator">=</span> FTScale <span class="uscript-operator">*</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>WheelRadius <span class="uscript-operator">*</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>TireLoad <span class="uscript-operator">*</span> WheelLongFrictionScale <span class="uscript-operator">*</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>LongFrictionFunc<span class="uscript-operator">.</span>Eval<span class="uscript-operator">(</span> Abs<span class="uscript-operator">(</span>vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SlipVel<span class="uscript-operator">)</span> <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SlipVel <span class="uscript-operator">&lt;</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">)</span>
            GripTorque <span class="uscript-operator">*=</span> <span class="uscript-operator">-</span><span class="uscript-number">1</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">;</span>

        <span class="uscript-comment">// GripTorque can't be more than the torque needed to invert slip ratio.</span>
        <span class="uscript-type">FLOAT</span> TransInertia <span class="uscript-operator">=</span> <span class="uscript-operator">(</span>EngineInertia <span class="uscript-operator">/</span> Abs<span class="uscript-operator">(</span>GearRatios<span class="uscript-operator">[</span>Gear<span class="uscript-operator">]</span> <span class="uscript-operator">*</span> TransRatio<span class="uscript-operator">)</span><span class="uscript-operator">)</span> <span class="uscript-operator">+</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>WheelInertia<span class="uscript-operator">;</span>
        <span class="uscript-comment">//FLOAT SlipAngVel = vw-&gt;SlipVel/vw-&gt;WheelRadius;</span>

        <span class="uscript-comment">// Brake torque acts to stop wheels (ie against direction of motion)</span>
        <span class="uscript-type">FLOAT</span> BrakeTorque <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">;</span>

        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SpinVel <span class="uscript-operator">&gt;</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">)</span>
            BrakeTorque <span class="uscript-operator">=</span> <span class="uscript-operator">-</span>OutputBrake <span class="uscript-operator">*</span> MaxBrakeTorque<span class="uscript-operator">;</span>
        <span class="uscript-keyword">else</span>
            BrakeTorque <span class="uscript-operator">=</span> OutputBrake <span class="uscript-operator">*</span> MaxBrakeTorque<span class="uscript-operator">;</span>

        <span class="uscript-type">FLOAT</span> LimitBrakeTorque <span class="uscript-operator">=</span> <span class="uscript-operator">(</span> Abs<span class="uscript-operator">(</span>vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SpinVel<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> TransInertia <span class="uscript-operator">)</span> <span class="uscript-operator">/</span> DeltaTime<span class="uscript-operator">;</span> <span class="uscript-comment">// Size of torque needed to completely stop wheel spinning.</span>
        BrakeTorque <span class="uscript-operator">=</span> Clamp<span class="uscript-operator">(</span>BrakeTorque<span class="uscript-operator">,</span> <span class="uscript-operator">-</span>LimitBrakeTorque<span class="uscript-operator">,</span> LimitBrakeTorque<span class="uscript-operator">)</span><span class="uscript-operator">;</span> <span class="uscript-comment">// Never apply more than this!</span>

        <span class="uscript-comment">// Resultant torque at wheel : torque applied from engine + brakes + equal-and-opposite from tire-road interaction.</span>
        <span class="uscript-type">FLOAT</span> WheelTorque <span class="uscript-operator">=</span> DriveTorque <span class="uscript-operator">+</span> BrakeTorque <span class="uscript-operator">-</span> GripTorque<span class="uscript-operator">;</span>
    
        <span class="uscript-comment">// Resultant linear force applied to car. (GripTorque applied at road)</span>
        <span class="uscript-type">FLOAT</span> VehicleForce <span class="uscript-operator">=</span> GripTorque <span class="uscript-operator">/</span> <span class="uscript-operator">(</span>FTScale <span class="uscript-operator">*</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>WheelRadius<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

        <span class="uscript-comment">// If the wheel torque is opposing the direction of spin (ie braking) we use friction to apply it.</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span> OutputBrake <span class="uscript-operator">&gt;</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>0f <span class="uscript-operator">||</span>  <span class="uscript-operator">(</span>DriveTorque <span class="uscript-operator">+</span> BrakeTorque<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SpinVel <span class="uscript-operator">&lt;</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
            vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>DriveForce <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">;</span>
            vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>LongFriction <span class="uscript-operator">=</span> Abs<span class="uscript-operator">(</span>VehicleForce<span class="uscript-operator">)</span> <span class="uscript-operator">+</span> <span class="uscript-operator">(</span>OutputBrake <span class="uscript-operator">*</span> MinBrakeFriction<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>
        <span class="uscript-keyword">else</span>
        <span class="uscript-operator">{</span>
            vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>DriveForce <span class="uscript-operator">=</span> VehicleForce<span class="uscript-operator">;</span>
            vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>LongFriction <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>

        <span class="uscript-comment">// Calculate torque applied back to chassis if wheel is on the ground</span>
        <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>bWheelOnGround<span class="uscript-operator">)</span>
            vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>ChassisTorque <span class="uscript-operator">=</span> <span class="uscript-operator">-</span><span class="uscript-number">1</span><span class="uscript-operator">.</span>0f <span class="uscript-operator">*</span> <span class="uscript-operator">(</span>DriveTorque <span class="uscript-operator">+</span> BrakeTorque<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> ChassisTorqueScale<span class="uscript-operator">;</span>
        <span class="uscript-keyword">else</span>
            vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>ChassisTorque <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">;</span>

        <span class="uscript-comment">// Calculate new wheel speed. </span>
        <span class="uscript-comment">// The lower the gear ratio, the harder it is to accelerate the engine.</span>
        <span class="uscript-type">FLOAT</span> TransAcc <span class="uscript-operator">=</span> WheelTorque <span class="uscript-operator">/</span> TransInertia<span class="uscript-operator">;</span>
        vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SpinVel <span class="uscript-operator">+=</span> TransAcc <span class="uscript-operator">*</span> DeltaTime<span class="uscript-operator">;</span>

        <span class="uscript-comment">// Make sure the wheel can't spin in the wrong direction for the current gear.</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Gear <span class="uscript-operator">==</span> <span class="uscript-number">0</span> <span class="uscript-operator">&amp;&amp;</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SpinVel <span class="uscript-operator">&gt;</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">)</span>
            vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SpinVel <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">;</span>
        <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Gear <span class="uscript-operator">&gt;</span> <span class="uscript-number">0</span> <span class="uscript-operator">&amp;&amp;</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SpinVel <span class="uscript-operator">&lt;</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">)</span>
            vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SpinVel <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">;</span>

        <span class="uscript-comment">// Accumulate wheel spin speeds to find engine RPM. </span>
        <span class="uscript-comment">// The lower the gear ratio, the faster the engine spins for a given wheel speed.</span>
        NewTotalSpinVel <span class="uscript-operator">+=</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SpinVel<span class="uscript-operator">;</span>
        EngineRPM <span class="uscript-operator">+=</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SpinVel <span class="uscript-operator">/</span> EngineWheelRatio<span class="uscript-operator">;</span>

        <span class="uscript-comment">/////////// LATERAL ///////////</span>

        vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>LatFriction <span class="uscript-operator">=</span> WheelLatFrictionScale <span class="uscript-operator">*</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>TireLoad<span class="uscript-operator">;</span>
        vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>LatSlip <span class="uscript-operator">=</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>LatSlipFunc<span class="uscript-operator">.</span>Eval<span class="uscript-operator">(</span>vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SlipAngle<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>OutputHandbrake <span class="uscript-operator">&amp;&amp;</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>bHandbrakeWheel<span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
            vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>LatFriction <span class="uscript-operator">*=</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>HandbrakeFrictionFactor<span class="uscript-operator">;</span>
            vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>LatSlip <span class="uscript-operator">*=</span> vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>HandbrakeSlipFactor<span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>

        <span class="uscript-comment">/////////// STEERING  ///////////</span>

        <span class="uscript-comment">// Pass on steering to wheels that want it.</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SteerType <span class="uscript-operator">==</span> VST_Steered<span class="uscript-operator">)</span>
            vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>Steer <span class="uscript-operator">=</span> ActualSteering<span class="uscript-operator">;</span>
        <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>SteerType <span class="uscript-operator">==</span> VST_Inverted<span class="uscript-operator">)</span>
            vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>Steer <span class="uscript-operator">=</span> <span class="uscript-operator">-</span>ActualSteering<span class="uscript-operator">;</span>
        <span class="uscript-keyword">else</span>
            vw<span class="uscript-operator">-</span><span class="uscript-operator">&gt;</span>Steer <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>

    <span class="uscript-comment">// EngineRPM is in radians per second, want in revolutions per minute</span>
    EngineRPM <span class="uscript-operator">/=</span> NumPoweredWheels<span class="uscript-operator">;</span>
    EngineRPM <span class="uscript-operator">/=</span> <span class="uscript-number">2</span><span class="uscript-operator">.</span>0f <span class="uscript-operator">*</span> <span class="uscript-operator">(</span><span class="uscript-type">FLOAT</span><span class="uscript-operator">)</span>PI<span class="uscript-operator">;</span> <span class="uscript-comment">// revs per sec</span>
    EngineRPM <span class="uscript-operator">*=</span> <span class="uscript-number">60</span><span class="uscript-operator">;</span>
    EngineRPM <span class="uscript-operator">=</span> Max<span class="uscript-operator">(</span> EngineRPM<span class="uscript-operator">,</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>01f <span class="uscript-operator">)</span><span class="uscript-operator">;</span> <span class="uscript-comment">// ensure always positive!</span>

    <span class="uscript-comment">// Update total wheel spin vel</span>
    TotalSpinVel <span class="uscript-operator">=</span> NewTotalSpinVel<span class="uscript-operator">;</span>

    <span class="uscript-comment">// Turn (yaw) damping.</span>
    FMatrix carTM <span class="uscript-operator">=</span> LocalToWorld<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    FVector worldUp<span class="uscript-operator">(</span>carTM<span class="uscript-operator">.</span>M<span class="uscript-operator">[</span><span class="uscript-number">2</span><span class="uscript-operator">]</span><span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">,</span> carTM<span class="uscript-operator">.</span>M<span class="uscript-operator">[</span><span class="uscript-number">2</span><span class="uscript-operator">]</span><span class="uscript-operator">[</span><span class="uscript-number">1</span><span class="uscript-operator">]</span><span class="uscript-operator">,</span> carTM<span class="uscript-operator">.</span>M<span class="uscript-operator">[</span><span class="uscript-number">2</span><span class="uscript-operator">]</span><span class="uscript-operator">[</span><span class="uscript-number">2</span><span class="uscript-operator">]</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    FVector worldRight<span class="uscript-operator">(</span>carTM<span class="uscript-operator">.</span>M<span class="uscript-operator">[</span><span class="uscript-number">1</span><span class="uscript-operator">]</span><span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">,</span> carTM<span class="uscript-operator">.</span>M<span class="uscript-operator">[</span><span class="uscript-number">1</span><span class="uscript-operator">]</span><span class="uscript-operator">[</span><span class="uscript-number">1</span><span class="uscript-operator">]</span><span class="uscript-operator">,</span> carTM<span class="uscript-operator">.</span>M<span class="uscript-operator">[</span><span class="uscript-number">1</span><span class="uscript-operator">]</span><span class="uscript-operator">[</span><span class="uscript-number">2</span><span class="uscript-operator">]</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    FVector worldForward<span class="uscript-operator">(</span>carTM<span class="uscript-operator">.</span>M<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">,</span> carTM<span class="uscript-operator">.</span>M<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">[</span><span class="uscript-number">1</span><span class="uscript-operator">]</span><span class="uscript-operator">,</span> carTM<span class="uscript-operator">.</span>M<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">[</span><span class="uscript-number">2</span><span class="uscript-operator">]</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    FKRigidBodyState rbState<span class="uscript-operator">;</span>
    KGetRigidBodyState<span class="uscript-operator">(</span><span class="uscript-operator">&amp;</span>rbState<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    FVector AngVel<span class="uscript-operator">(</span>rbState<span class="uscript-operator">.</span>AngVel<span class="uscript-operator">.</span>X<span class="uscript-operator">,</span> rbState<span class="uscript-operator">.</span>AngVel<span class="uscript-operator">.</span>Y<span class="uscript-operator">,</span> rbState<span class="uscript-operator">.</span>AngVel<span class="uscript-operator">.</span>Z<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    <span class="uscript-type">FLOAT</span> TurnAngVel <span class="uscript-operator">=</span> AngVel <span class="uscript-operator">|</span> worldUp<span class="uscript-operator">;</span>

    <span class="uscript-type">FLOAT</span> DampingScale <span class="uscript-operator">=</span> <span class="uscript-number">1</span><span class="uscript-operator">.</span>0f <span class="uscript-operator">-</span> MinAirControlDamping<span class="uscript-operator">;</span>

    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bAllowAirControl <span class="uscript-operator">&amp;&amp;</span> <span class="uscript-operator">!</span>bVehicleOnGround<span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-type">FLOAT</span> TurnDampingMag <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-number">1</span><span class="uscript-operator">.</span>0f <span class="uscript-operator">-</span> DampingScale<span class="uscript-operator">*</span>Abs<span class="uscript-operator">(</span>Steering<span class="uscript-operator">)</span><span class="uscript-operator">)</span> <span class="uscript-operator">*</span> TurnDamping <span class="uscript-operator">*</span> TurnAngVel<span class="uscript-operator">;</span>
        KAddForces<span class="uscript-operator">(</span> FVector<span class="uscript-operator">(</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">)</span><span class="uscript-operator">,</span> <span class="uscript-operator">-</span>TurnDampingMag <span class="uscript-operator">*</span> worldUp <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>
    <span class="uscript-keyword">else</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-type">FLOAT</span> TurnDampingMag <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-number">1</span><span class="uscript-operator">.</span>0f <span class="uscript-operator">-</span> Abs<span class="uscript-operator">(</span>Steering<span class="uscript-operator">)</span><span class="uscript-operator">)</span> <span class="uscript-operator">*</span> TurnDamping <span class="uscript-operator">*</span> TurnAngVel<span class="uscript-operator">;</span>
        KAddForces<span class="uscript-operator">(</span> FVector<span class="uscript-operator">(</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">)</span><span class="uscript-operator">,</span> <span class="uscript-operator">-</span>TurnDampingMag <span class="uscript-operator">*</span> worldUp <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>

    <span class="uscript-comment">// If vehicle is in the air and we are allowing air control...</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bVehicleOnGround<span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-type">FLOAT</span> PitchAngVel <span class="uscript-operator">=</span> AngVel <span class="uscript-operator">|</span> worldRight<span class="uscript-operator">;</span>
        <span class="uscript-type">FLOAT</span> RollAngVel <span class="uscript-operator">=</span> AngVel <span class="uscript-operator">|</span> worldForward<span class="uscript-operator">;</span>

        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bAllowAirControl<span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
            FVector AirControlTorque <span class="uscript-operator">=</span> worldRight <span class="uscript-operator">*</span> OutputPitch <span class="uscript-operator">*</span> <span class="uscript-operator">-</span>AirPitchTorque<span class="uscript-operator">;</span>

            <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bIsWalking<span class="uscript-operator">)</span>
                AirControlTorque <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span>worldForward <span class="uscript-operator">*</span> Steering <span class="uscript-operator">*</span> <span class="uscript-operator">-</span>AirRollTorque<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
            <span class="uscript-keyword">else</span>
                AirControlTorque <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span>worldUp <span class="uscript-operator">*</span> Steering <span class="uscript-operator">*</span> <span class="uscript-operator">-</span>AirTurnTorque<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

            KAddForces<span class="uscript-operator">(</span> FVector<span class="uscript-operator">(</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">)</span><span class="uscript-operator">,</span> AirControlTorque <span class="uscript-operator">)</span><span class="uscript-operator">;</span>

            <span class="uscript-comment">// Damping forces</span>
            <span class="uscript-type">FLOAT</span> PitchDampingMag <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-number">1</span><span class="uscript-operator">.</span>0f <span class="uscript-operator">-</span> DampingScale<span class="uscript-operator">*</span>Abs<span class="uscript-operator">(</span>OutputPitch<span class="uscript-operator">)</span><span class="uscript-operator">)</span> <span class="uscript-operator">*</span> AirPitchDamping <span class="uscript-operator">*</span> PitchAngVel<span class="uscript-operator">;</span>
            <span class="uscript-type">FLOAT</span> RollDampingMag <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-number">1</span><span class="uscript-operator">.</span>0f <span class="uscript-operator">-</span> DampingScale<span class="uscript-operator">*</span>Abs<span class="uscript-operator">(</span>Steering<span class="uscript-operator">)</span><span class="uscript-operator">)</span> <span class="uscript-operator">*</span> AirRollDamping <span class="uscript-operator">*</span> RollAngVel<span class="uscript-operator">;</span>

            KAddForces<span class="uscript-operator">(</span> FVector<span class="uscript-operator">(</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">)</span><span class="uscript-operator">,</span> <span class="uscript-operator">(</span><span class="uscript-operator">-</span>PitchDampingMag <span class="uscript-operator">*</span> worldRight<span class="uscript-operator">)</span> <span class="uscript-operator">+</span> <span class="uscript-operator">(</span><span class="uscript-operator">-</span>RollDampingMag <span class="uscript-operator">*</span> worldForward<span class="uscript-operator">)</span> <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>
        <span class="uscript-keyword">else</span>
        <span class="uscript-operator">{</span>
            <span class="uscript-type">FLOAT</span> PitchDampingMag <span class="uscript-operator">=</span> AirPitchDamping <span class="uscript-operator">*</span> PitchAngVel<span class="uscript-operator">;</span>
            KAddForces<span class="uscript-operator">(</span> FVector<span class="uscript-operator">(</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">)</span><span class="uscript-operator">,</span> <span class="uscript-operator">-</span>PitchDampingMag <span class="uscript-operator">*</span> worldRight <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>

    <span class="uscript-operator">}</span>

    unguard<span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><hr class="thin"><p><em class="em2">Foxpaw:</em> The title of this page is a little misleading. It should perhaps be a subpage of your manual shifting vehicle page.</p>
<p>Also I'm a bit confused. You made a C++ version before making an Unrealscript version? Does this mean you have the native headers for UT2004?</p>
<p><em class="em2">CIpen:</em> Sorry about that one <img alt=":)" src="emoticons/smile.gif" align="middle">.  No, the code here is from <a href="http://www.psyonix.com/">http://www.psyonix.com/</a> and no, I do not have the native headers.  Even if I did have the headers, would it be good to have everything in script?  No, I don't think you want to be doing second order derivatives in script to calculate suspension/chassy movement.</p>
<p><em class="em2">Foxpaw:</em> I don't see any reason why UScript couldn't handle that, as it is quite fast for an interpreted language. I also don't see any derivatives being calculated at all in that source.</p>
<p>Anyways, that's slightly besides the point. I see now that this is the C++ code for an onslaught wheeled vehicle, not the C++ code for the "manual shift car" that you created. The name somewhat implied that this was a C++ version of the UScript car detailed on it's parent page, which would have required the native headers to get into the game. (If you had made the "manual shift car" in C++, that is.)</p>
<p><em class="em2">CIpen:</em>  Hey Foxpaw, that's nice you are pointing this out.  I'll remember you for the next time I need someone to show me that I'm not half way through writing my page(the obvious).</p>
<p>Ya, double briliant, unreal script can not even handle simple rotations per min to radians per min convertion and you are claiming it can calculate second order derivatives on the fly?  Where is this script at?  Foxpaw show me were your unreal script is that will calculate the spring motion of a car tire + spring + shock + engine torque in unreal script on the fly. </p>
<p><em class="em2">Foxpaw:</em> Err, that was a bit rude, but anyway, I'm not sure where you got your ideas about what Unrealscript can handle. RPM can be easily converted to radians per minute with one line: RadiansPerMinute = RPM * 2 * Pi; Unrealscript is a more-or-less full featured programming language: except for a few things that are restricted for security purposes, Unrealscript can do everything that C++ can do.</p>
<p>I don't have any code to calculate motion of tires since I haven't coded any land vehicles, but my mod handles hundreds, if not thousands of coordinate rotation and other matrix operations every tick, and still runs at over 200 fps - so I'm sure that it has the capability to handle calculating a few derivatives at acceptable speed.</p>
<p><em class="em2">CIpen:</em>  I made this page to show the native function UpdateState().  Foxpaw, did you have a question about the function or did you come to boast about your mod?  Please Foxpaw, if it isn't about the code above please discuss it in the forums.</p>
<p><em class="em2">Foxpaw:</em> Errr, I made a comment regarding the title of this page, and asked what this was since there was very little other than the code and a short note at the top stating that this is what you started with. You responded saying that you got the code from Psyonix at which point I realized what this was. You also said that you wouldn't want to do second order derivatives in Unrealscript. I said that I now realized what this was but said that I saw no reason why you couldn't do derivatives in UnrealScript. Then you responded defensively and made a remark about the capability (or lack thereof) of Unrealscript to perform even a simple calculation, let alone a complex one. I refuted that statement with an example of complex calculations being performed in Unrealscript. (my mod)</p>
<p>So, I don't see why "now I see what this page is about" prompted the rude response: " Hey Foxpaw, that's nice you are pointing this out.  I'll remember you for the next time I need someone to show me that I'm not half way through writing my page(the obvious)." I also don't see why me showing you that you can in fact perform an operation you claimed impossible offends you.</p>
<p><em class="em2">CIpen:</em> "I'm not half way through writing my page", did you miss this part of the sentence? <img alt=":D" src="emoticons/biggrin.gif" align="middle">  </p>
<p>Okay, yes, you can do complex calculations.  You win.  I do not have the time to answer this, so, you're right.  And when you're right, you're right.  But why even convert rotations per min to radians per min if you don't have to?  And what if there is already a lot eye candy?  Yes you're right, it is optional to optimize your code/map/whatever.</p>
<script type="text/javascript"><!--
 menuItemAdd("UpdateVehicle", "#0.0.0.1");
 menuWrite() //--></script></div>
</div>

<div id="footer" class="bar">
	<p><form method="post" action="http://wiki.beyondunreal.com/wiki" enctype="application/x-www-form-urlencoded">
<a href="(start).html">Home Page</a> | <a href="manual-shift-car.html">Manual Shift Car</a> | <a href="recent-changes.html">Recent Changes</a> | <a href="http://wiki.beyondunreal.com/wiki?action=editprefs">Preferences</a><br>
<a href="http://wiki.beyondunreal.com/wiki?action=edit&id=Manual_Shift_Car/CPlusPlus_Version">Edit text of this page</a> | <a href="http://wiki.beyondunreal.com/wiki?action=history&id=Manual_Shift_Car/CPlusPlus_Version">View other revisions</a><br>Last edited October 1, 2004 18:10 <a href="http://wiki.beyondunreal.com/wiki?action=browse&diff=1&id=Manual_Shift_Car/CPlusPlus_Version">(diff)</a><br>Search: <input type="text" name="search"  size="20" /><input type="hidden" name="dosearch" value="1"  /><br><br><small><a href="http://wiki.beyondunreal.com/wiki/Manual_Shift_Car/CPlusPlus_Version">Original page</a> &#150; copy created Sat, Jun 23, 2007</small><div></div>
</form>
	</p>
	<p>Mostly Harmless
</p>
</div>
</div><!-- close of "scrolling" div -->

<div id="quickbar">
	<div id="logo"><a href="http://wiki.beyondunreal.com/"><img src="shared/wikilogo.jpg" width="143" height="100" border="0"></a>
		</div>
	<div class="qbsitename">
		<p>The Unreal Engine Documentation Site</p>
	</div>
	<div class="qbsection">
<p><a href="metatopics.html">Wiki Community</a></p>
<p><a href="category-category.html">Topic Categories</a></p>
<p><a href="/cgi-bin/imageupload.cgi/wiki-ext/imageupload.htt" target="_blank ">Image Uploads</a></p>
<p><a href="http://wiki.beyondunreal.com/wiki?action=random">Random Page</a></p>
<p><a href="recent-changes.html">Recent Changes</a></p>
<p><a href="offline-wiki.html">Offline Wiki</a></p>
</div><div class="qbsection">
<p><a href="unreal-engine.html">Unreal Engine</a></p>
<p><a href="console-commands.html">Console Commands</a></p>
<p><a href="terminology.html">Terminology</a></p>
<p><a href="category-faq.html">FAQs</a></p>
<p><a href="help-desk.html">Help Desk</a></p>
</div><div class="qbsection">
<p><a href="topics-on-mapping.html">Mapping Topics</a></p>
<p><a href="mapping-lessons.html">Mapping Lessons</a></p>
<p><a href="unrealed-3.html">UnrealEd Interface</a></p>
</div><div class="qbsection">
<p><a href="unrealscript.html">UnrealScript Topics</a></p>
<p><a href="unrealscript-lessons.html">UnrealScript Lessons</a></p>
<p><a href="making-mods.html">Making Mods</a></p>
<p><a href="class-tree.html">Class Tree</a></p>
</div><div class="qbsection">
<p><a href="topics-on-modeling.html">Modeling Topics</a></p>
</div><div class="qbsection">
<p><a href="chongqing-page.html">Chongqing Page</a></p>
<p><a href="log-in.html">Log In</a></p></div>
</div>

</body></html>
