<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  "http://www.w3.org/TR/html4/loose.dtd">

<html>
<head lang="en">
	<title>UnrealWiki: Manual Shift Car</title>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
	<link rel="stylesheet" type="text/css" media="screen, print"
		href="shared/stylebase.structural.css">	
	<link rel="stylesheet" type="text/css" media="screen"
		href="shared/template-default.css">
	<link rel="stylesheet" type="text/css" media="screen"
		href="shared/styles.chblue.css">
	<link rel="stylesheet" type="text/css" media="print"
		href="shared/template-default-print.css">
	<!--[if IE 6]>
			<style>
			/* dirty hack for IE6. */
			#quickbar {
				position: absolute;
				}
			</style>
	<![endif]-->
  <link rel="start" href="http://wiki.beyondunreal.com/">
  <link rel="glossary"  href="http://wiki.beyondunreal.com/wiki/Terminology">
  <link rel="help"  href="http://wiki.beyondunreal.com/wiki/Using_The_Wiki">
<script type="text/javascript" src="shared/dhtml.js"></script>
<script type="text/javascript" src="shared/dhtml-menu.js"></script>
<style type="text/css">#dhtml-menu    { background: #eee; padding: 5px 0px; margin-right: -20px; border: 1px solid #888; border-left: 1px solid #ccc; border-top: 1px solid #ccc;  border-right: 1px solid #888; border-bottom: 1px solid #888 }
#dhtml-menu td { color: #000; font-family: Arial,Helvetica,sans-serif; font-size: 9pt; line-height: 13pt; padding: 1px 10px; cursor: default }
#dhtml-menu a  { color: #000; font-family: Arial,Helvetica,sans-serif; font-size: 9pt; line-height: 13pt; text-decoration: none }
#dhtml-menu tt { font-family: monospace; font-size: 9pt }
#dhtml-menu-separator { height: 1px; background: red }
#dhtml-menu-anchor { cursor: default }
</style>
<script type="text/javascript" src="shared/expandable.js"></script>
</head>
<body onLoad="menuInit(); document.cookie='page=Manual_Shift_Car; path=/'" class="default">
<div id="scrolling"><!-- contains all except the fixed sidebar -->
<div id="topbar"  class="bar">
	<div class="righthalf">
		<form class="inline" method="post" action="/wiki" enctype="application/x-www-form-urlencoded"><input type="text" name="search"  size="20" /> <input type="submit" name="search" value="search" /></form>
	</div>
	<div class="lefthalf">
		<script type="text/javascript"><!--
			menuAlignRight = false;
		//--></script>
		<span><script type="text/javascript"><!--
 menuWriteAnchor("Quick Navigation") //--></script></span> | <a href="(start).html">Home Page</a> | <a href="recent-changes.html">Recent Changes</a> | <a href="http://wiki.beyondunreal.com/wiki?action=editprefs">Preferences</a>
	</div>
</div>

<div id="content"><!-- contains the title and article -->
	<h1 class='pagetitle'><a href="http://wiki.beyondunreal.com/wiki?back=Manual Shift Car">Manual Shift Car</a></h1>
	<div class="wiki"><h2><a name="0.1"></a>Breakdown </h2>
<p>This is a convertion of <a href="onswheeledcraft.html">ONSWheeledCraft</a>. This class allows for a stick shift or otherwise known as a manual transmission car.  Why stick shift?</p>
<ul><li>It doesn't cost much in terms of fps</li>
<li>Lets you rev it in neutral <img alt=":)" src="emoticons/smile.gif" align="middle"></li>
<li>Fun to drive</li>
<li>Will allow rear/front/all wheel drive</li>
<li>Holding the brake and the rear wheels keep spinning (no rear brakes)</li>
<li>I hope you can use what I (CIpen) have created</li>
</ul>
<h2><a name="0.2"></a>The Goods </h2>
<h3><a name="0.2.1"></a>To start the class off </h3>
<pre class="uscript"><span class="uscript-keyword">class</span> WheeledClutch_Brake <span class="uscript-keyword">extends</span> ONSVehicle<span class="uscript-operator">;</span></pre><h3><a name="0.2.2"></a>Critical variables </h3>
<pre class="uscript"><span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>             WheelSoftness<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>             WheelPenScale<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>             WheelPenOffset<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>             WheelRestitution<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>             WheelAdhesion<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>             WheelInertia<span class="uscript-operator">;</span>   <span class="uscript-comment">// I believe this is how much to resist change in motion</span>

    <span class="uscript-comment">//I(CIpen) made these an array so we could have different slips on each surface</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-keyword">array</span><span class="uscript-operator">&lt;</span><span class="uscript-type">float</span><span class="uscript-operator">&gt;</span>         WheelLongSlip<span class="uscript-operator">;</span> <span class="uscript-comment">// I think this is so we can have the wheels slip when you take off</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-keyword">array</span><span class="uscript-operator">&lt;</span>InterpCurve<span class="uscript-operator">&gt;</span>   WheelLongFrictionFunc<span class="uscript-operator">;</span><span class="uscript-comment">//this is the curve for how slippery the wheels are allong the X axis(forwards slip)</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-keyword">array</span><span class="uscript-operator">&lt;</span>InterpCurve<span class="uscript-operator">&gt;</span>   WheelLatSlipFunc<span class="uscript-operator">;</span><span class="uscript-comment">//this is the curve for how slippery the wheels are allong the Y axis(left/right slip)</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-keyword">array</span><span class="uscript-operator">&lt;</span><span class="uscript-type">float</span><span class="uscript-operator">&gt;</span>         WheelLongFrictionScale<span class="uscript-operator">;</span>  <span class="uscript-comment">// quick way to change the ammount of friction without having to draw out</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-keyword">array</span><span class="uscript-operator">&lt;</span><span class="uscript-type">float</span><span class="uscript-operator">&gt;</span>         WheelLatFrictionScale<span class="uscript-operator">;</span>   <span class="uscript-comment">// a new friction curve</span>

<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             WheelHandbrakeSlip<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             WheelHandbrakeFriction<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             WheelSuspensionTravel<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             WheelSuspensionOffset<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             WheelSuspensionMaxRenderTravel<span class="uscript-operator">;</span>   
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             FTScale<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             ChassisTorqueScale<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             MinBrakeFriction<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> InterpCurve                       MaxSteerAngleCurve<span class="uscript-operator">;</span> <span class="uscript-comment">// degrees, this makes the wheels turn like real car wheels*</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             GearRatios<span class="uscript-operator">[</span><span class="uscript-number">8</span><span class="uscript-operator">]</span><span class="uscript-operator">;</span>  <span class="uscript-comment">// 0 is reverse, 1-4 f</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">int</span>                               NumForwardGears<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             TransRatio<span class="uscript-operator">;</span>   <span class="uscript-comment">// Other(constant)gears  i.e. so we can have driveshaft ratio(if one applies)</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             ChangeUpPoint<span class="uscript-operator">;</span>   <span class="uscript-comment">//EngineRPM that signals gear up change</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             ChangeDownPoint<span class="uscript-operator">;</span> <span class="uscript-comment">//EngineRPM that signals gear down change</span>

<span class="uscript-keyword">var</span>   <span class="uscript-type">int</span>                               bGearUp<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">int</span>                               bGearDown<span class="uscript-operator">;</span>

<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             LSDFactor<span class="uscript-operator">;</span>                                                                                    
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             EngineBrakeFactor<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             EngineBrakeRPMScale<span class="uscript-operator">;</span>                                                                                     
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             MaxBrakeTorque<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             SteerSpeed<span class="uscript-operator">;</span>         <span class="uscript-comment">// How fast it turns         </span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             TurnDamping<span class="uscript-operator">;</span>                                                                                    
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             StopThreshold<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             HandbrakeThresh<span class="uscript-operator">;</span>                                                                                     
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             EngineInertia<span class="uscript-operator">;</span>     <span class="uscript-comment">// Pre-gear box engine (piston mass)</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                              bClutching<span class="uscript-operator">;</span>        <span class="uscript-comment">// If holding the clutch</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                              bOldClutching<span class="uscript-operator">;</span>  
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             IdleRPM<span class="uscript-operator">;</span>              <span class="uscript-comment">//RPM to idle at</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             EngineRPMSoundRange<span class="uscript-operator">;</span>   <span class="uscript-comment">//RPM sound range</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">name</span>                              SteerBoneName<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> EAxis                             SteerBoneAxis<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             SteerBoneMaxAngle<span class="uscript-operator">;</span> <span class="uscript-comment">// degrees                                                                                     </span>

<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             OutputBrake<span class="uscript-operator">;</span>    <span class="uscript-comment">//How much we are braking</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             OutputGas<span class="uscript-operator">;</span>      <span class="uscript-comment">//How much are we giving gas</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             OutputPitch<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                              OutputHandbrake<span class="uscript-operator">;</span>

<span class="uscript-keyword">var</span>   <span class="uscript-type">int</span>                               Gear<span class="uscript-operator">;</span>           <span class="uscript-comment">//What gear we are in</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             ForwardVel<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                              bIsInverted<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                              bIsDriving<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             NumPoweredWheels<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             NeutralRPM<span class="uscript-operator">;</span>

<span class="uscript-keyword">var</span>   InterpCurve                       RPMtoGas<span class="uscript-operator">;</span>           <span class="uscript-comment">// This is what I use to convert the current in gear RPM to the amount of gas so the RPM doesn't go to zero when we hit the clutch</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> InterpCurve                       TorqueCurve<span class="uscript-operator">;</span>        <span class="uscript-comment">// Engine output torque</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> InterpCurve                       EngineS<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> InterpCurve                       BrakeCurve<span class="uscript-operator">;</span>     <span class="uscript-comment">//This simulates more lifelike braking, where you apply braking</span>

<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             Gas<span class="uscript-operator">,</span> Gas2<span class="uscript-operator">,</span> hBrake<span class="uscript-operator">;</span>

<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             RPM2<span class="uscript-operator">;</span>    <span class="uscript-comment">//Neutral RPM</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             RPM<span class="uscript-operator">;</span>     <span class="uscript-comment">//Neutral RPM</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             NRPM<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                              bBraking<span class="uscript-operator">;</span>   <span class="uscript-comment">//if we are braking</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                              bThrot<span class="uscript-operator">,</span> bNThrot<span class="uscript-operator">,</span> bNoGas<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                              bInGear<span class="uscript-operator">;</span>          <span class="uscript-comment">//if we are completly in gear</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                              bRadians<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             TotalSpinVel<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             EngineRPM<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             WheelRPM<span class="uscript-operator">;</span><span class="uscript-comment">// used to get the wheel RPM at anytime(so we don't change EngineRPM which is what the engine sound is tied to)</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             CarMPH<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             ETorque<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             ActualSteering<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             SteerBoneAngle<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             EnginePitch<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   Vector                            worldForward<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   Vector                            worldRight<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   Vector                            worldUp<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   Matrix                            carTM<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   Rotator                           SteerRot<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                              bCurrentOnGround<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             DeltaPitch<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             DeltaHeading<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             DeltaRoll<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             VRate<span class="uscript-operator">;</span>

<span class="uscript-keyword">var</span>   vector                            one<span class="uscript-operator">,</span> two<span class="uscript-operator">,</span> three<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   vector                            Dist1<span class="uscript-operator">,</span> Dist2<span class="uscript-operator">;</span>     <span class="uscript-comment">// unused but this was for doing the daredevil stuff</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                             Dist3<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                              bBrakeFrontWheelsOnly<span class="uscript-operator">,</span> bBrakeFrontWheels<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   Vector                            UDForce<span class="uscript-operator">,</span> UDTorque<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   Vector                            WForce<span class="uscript-operator">,</span> WTorque<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   Coords                            WheelCoords<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   Coords                            OldCoords<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   Coords                            Coords<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   Vector                            ForwardsInOldPlane<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   Pawn                              OldDriver<span class="uscript-operator">;</span>        

<span class="uscript-keyword">struct</span> <span class="uscript-keyword">native</span> SCarState
<span class="uscript-operator">{</span>
          <span class="uscript-keyword">var</span> vector                    ChassisPosition<span class="uscript-operator">;</span>                               
          <span class="uscript-keyword">var</span> Quat                      ChassisQuaternion<span class="uscript-operator">;</span>                             
          <span class="uscript-keyword">var</span> vector                    ChassisLinVel<span class="uscript-operator">;</span>                                 
          <span class="uscript-keyword">var</span> vector                    ChassisAngVel<span class="uscript-operator">;</span>                                 
                                                                                     
          <span class="uscript-keyword">var</span> <span class="uscript-type">byte</span>                      ServerHandbrake<span class="uscript-operator">;</span>                               
          <span class="uscript-keyword">var</span> <span class="uscript-type">byte</span>                      ServerBrake<span class="uscript-operator">;</span>                                   
          <span class="uscript-keyword">var</span> <span class="uscript-type">byte</span>                      ServerGas<span class="uscript-operator">;</span>                                     
          <span class="uscript-keyword">var</span> <span class="uscript-type">byte</span>                      ServerGear<span class="uscript-operator">;</span>                                    
          <span class="uscript-keyword">var</span> <span class="uscript-type">byte</span>                      ServerSteering<span class="uscript-operator">;</span>
          <span class="uscript-keyword">var</span> <span class="uscript-type">int</span>                       ServerViewPitch<span class="uscript-operator">;</span>
          <span class="uscript-keyword">var</span> <span class="uscript-type">int</span>                       ServerViewYaw<span class="uscript-operator">;</span>
<span class="uscript-operator">}</span><span class="uscript-operator">;</span>
                                                                               
<span class="uscript-keyword">var</span>   <span class="uscript-type">byte</span>                     FudgeByte<span class="uscript-operator">;</span>                                                                                     
<span class="uscript-keyword">var</span>   SCarState                CarState<span class="uscript-operator">;</span>                                      
<span class="uscript-keyword">var</span>   SCarState                OldCarState<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   KRigidBodyState          ChassisState<span class="uscript-operator">;</span>                                  
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                     bNewCarState<span class="uscript-operator">;</span>                                                                                    
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                     bOldVehicleOnGround<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                    TheDeltaTime<span class="uscript-operator">;</span></pre><h3><a name="0.2.3"></a>Not so critical variables </h3>
<pre class="uscript"><span class="uscript-keyword">var</span>   <span class="uscript-keyword">class</span><span class="uscript-operator">&lt;</span>CameraEffect<span class="uscript-operator">&gt;</span>           myBlur<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   myMotionBlur                  ClientMotionBlur<span class="uscript-operator">;</span>

<span class="uscript-keyword">var</span>   <span class="uscript-keyword">array</span><span class="uscript-operator">&lt;</span>ONSDirtSlipEffect<span class="uscript-operator">&gt;</span>          Dust<span class="uscript-operator">;</span> <span class="uscript-comment">// FL, FR, RL, RR</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             DustSlipRate<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                             DustSlipThresh<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                         RevMeterPosX<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                         RevMeterPosY<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                         RevMeterScale<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                         RevMeterSizeY<span class="uscript-operator">;</span>

<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">bool</span>                  bDoStuntInfo<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">bool</span>                  bAllowAirControl<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">bool</span>                  bAllowChargingJump<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                  bAllowBigWheels<span class="uscript-operator">;</span>
                                                                                     
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                      bPushDown<span class="uscript-operator">;</span> <span class="uscript-comment">//jump is being charged</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                          bOldPushDown<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">bool</span>                          bAllWheelsOnGround<span class="uscript-operator">;</span>
                                                                                     
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 MaxJumpForce<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                         JumpForce<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 MaxJumpSpin<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                         JumpSpin<span class="uscript-operator">;</span>

<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 JumpChargeTime<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                 DesiredJumpForce<span class="uscript-operator">;</span> <span class="uscript-comment">//used by AI</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">string</span>            JumpFeedbackForce<span class="uscript-operator">;</span>                             
                                                                                     
<span class="uscript-keyword">var</span>   sound                 JumpSound<span class="uscript-operator">;</span>
                                                                                   
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 JumpMeterOriginX<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                         JumpMeterOriginY<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 JumpMeterWidth<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                         JumpMeterHeight<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                         JumpMeterSpacing<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> color                 JumpMeterColor<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> color                         SpinMeterColor<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   Texture           JumpMeterTexture<span class="uscript-operator">;</span>                              
                                                                                   
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 AirTurnTorque<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 AirPitchTorque<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 AirPitchDamping<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 AirRollTorque<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 AirRollDamping<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 MinAirControlDamping<span class="uscript-operator">;</span>                                                                                    
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                 FenderBenderSpeed<span class="uscript-operator">;</span>
                                                                            
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">bool</span>                          bMakeBrakeLights<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> vector                           BrakeLightOffset<span class="uscript-operator">[</span><span class="uscript-number">2</span><span class="uscript-operator">]</span><span class="uscript-operator">;</span>                           
<span class="uscript-keyword">var</span>   ONSBrakelightCorona           BrakeLight<span class="uscript-operator">[</span><span class="uscript-number">2</span><span class="uscript-operator">]</span><span class="uscript-operator">;</span>                                 
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> Material                        BrakeLightMaterial<span class="uscript-operator">;</span>                            
                                                                                     
<span class="uscript-keyword">var</span>   Rotator           OldRotation<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   Vector            LastOnGroundLocation<span class="uscript-operator">;</span>                          
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                 LastOnGroundTime<span class="uscript-operator">;</span>
                                                                                     
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                 InAirSpin<span class="uscript-operator">;</span> <span class="uscript-comment">// Degrees</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                 InAirPitch<span class="uscript-operator">;</span> <span class="uscript-comment">// Degrees</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                 InAirRoll<span class="uscript-operator">;</span> <span class="uscript-comment">// Degrees</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                 InAirTime<span class="uscript-operator">;</span> <span class="uscript-comment">// Second</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                 InAirDistance<span class="uscript-operator">;</span> <span class="uscript-comment">// Meters</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">int</span>               DaredevilPoints<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-keyword">config</span> <span class="uscript-type">int</span>                    IntSteerBoneAngle<span class="uscript-operator">;</span>

<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 DaredevilThreshInAirSpin<span class="uscript-operator">;</span>                      
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 DaredevilThreshInAirPitch<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 DaredevilThreshInAirRoll<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 DaredevilThreshInAirTime<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-type">float</span>                 DaredevilThreshInAirDistance<span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span><span class="uscript-operator">(</span><span class="uscript-operator">)</span> <span class="uscript-keyword">class</span><span class="uscript-operator">&lt;</span>LocalMessage<span class="uscript-operator">&gt;</span>           DaredevilMessageClass<span class="uscript-operator">;</span></pre><h4><a name="0.2.3.1"></a>Replication</h4>
<pre class="uscript"><span class="uscript-keyword">replication</span>
<span class="uscript-operator">{</span>
        <span class="uscript-keyword">reliable</span> <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>Role <span class="uscript-operator">==</span> ROLE_Authority<span class="uscript-operator">)</span>
                CarState<span class="uscript-operator">,</span> FudgeByte<span class="uscript-operator">;</span>                       <span class="uscript-comment">// make sure we get what we need to the client</span>
        <span class="uscript-keyword">reliable</span> <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>bNetInitial <span class="uscript-operator">&amp;&amp;</span> Role <span class="uscript-operator">==</span> ROLE_Authority<span class="uscript-operator">)</span>
                bAllowAirControl<span class="uscript-operator">,</span> bAllowChargingJump<span class="uscript-operator">;</span>        <span class="uscript-comment">// showoff stuff</span>
        <span class="uscript-keyword">reliable</span> <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>bNetInitial <span class="uscript-operator">&amp;&amp;</span> bDoStuntInfo <span class="uscript-operator">&amp;&amp;</span> Role <span class="uscript-operator">==</span> ROLE_Authority<span class="uscript-operator">)</span>
                DaredevilThreshInAirDistance<span class="uscript-operator">,</span> DaredevilThreshInAirTime<span class="uscript-operator">,</span> DaredevilThreshInAirSpin<span class="uscript-operator">,</span> DaredevilThreshInAirPitch<span class="uscript-operator">,</span> DaredevilThreshInAirRoll<span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><h3><a name="0.2.4"></a>Functions </h3>
<dl><dt>PostNetBeginPlay</dt></dl>
<pre class="uscript"><span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> PostNetBeginPlay<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
        <span class="uscript-keyword">local</span> <span class="uscript-type">int</span> i<span class="uscript-operator">;</span>
    NumPoweredWheels <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
    <span class="uscript-keyword">for</span><span class="uscript-operator">(</span>i<span class="uscript-operator">=</span><span class="uscript-number">0</span><span class="uscript-operator">;</span> i<span class="uscript-operator">&lt;=</span><span class="uscript-number">1</span><span class="uscript-operator">;</span> i<span class="uscript-operator">++</span><span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        NumPoweredWheels <span class="uscript-operator">+=</span> <span class="uscript-number">1.0</span><span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>
       SVehicleUpdateParams<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
       <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>PostNetBeginPlay<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>PostNetReceive</dt><dd>Here is were we deal with stuff coming from the server.</dd></dl>
<pre class="uscript"><span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> PostNetReceive<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>PostNetReceive<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>OldCarState<span class="uscript-operator">.</span>ChassisPosition <span class="uscript-operator">==</span> CarState<span class="uscript-operator">.</span>ChassisPosition <span class="uscript-operator">&amp;&amp;</span>
        OldCarState<span class="uscript-operator">.</span>ChassisQuaternion<span class="uscript-operator">.</span>X <span class="uscript-operator">==</span> CarState<span class="uscript-operator">.</span>ChassisQuaternion<span class="uscript-operator">.</span>X <span class="uscript-operator">&amp;&amp;</span>
        OldCarState<span class="uscript-operator">.</span>ChassisQuaternion<span class="uscript-operator">.</span>Y <span class="uscript-operator">==</span> CarState<span class="uscript-operator">.</span>ChassisQuaternion<span class="uscript-operator">.</span>Y <span class="uscript-operator">&amp;&amp;</span>
        OldCarState<span class="uscript-operator">.</span>ChassisQuaternion<span class="uscript-operator">.</span>Z <span class="uscript-operator">==</span> CarState<span class="uscript-operator">.</span>ChassisQuaternion<span class="uscript-operator">.</span>Z <span class="uscript-operator">&amp;&amp;</span>
        OldCarState<span class="uscript-operator">.</span>ChassisQuaternion<span class="uscript-operator">.</span>W <span class="uscript-operator">==</span> CarState<span class="uscript-operator">.</span>ChassisQuaternion<span class="uscript-operator">.</span>W <span class="uscript-operator">&amp;&amp;</span>
        OldCarState<span class="uscript-operator">.</span>ChassisLinVel <span class="uscript-operator">==</span> CarState<span class="uscript-operator">.</span>ChassisLinVel <span class="uscript-operator">&amp;&amp;</span>
        OldCarState<span class="uscript-operator">.</span>ChassisAngVel <span class="uscript-operator">==</span> CarState<span class="uscript-operator">.</span>ChassisAngVel <span class="uscript-operator">&amp;&amp;</span>
        OldCarState<span class="uscript-operator">.</span>ServerHandbrake <span class="uscript-operator">==</span> CarState<span class="uscript-operator">.</span>ServerHandbrake <span class="uscript-operator">&amp;&amp;</span>
        OldCarState<span class="uscript-operator">.</span>ServerBrake <span class="uscript-operator">==</span> CarState<span class="uscript-operator">.</span>ServerBrake <span class="uscript-operator">&amp;&amp;</span>
        OldCarState<span class="uscript-operator">.</span>ServerGas <span class="uscript-operator">==</span> CarState<span class="uscript-operator">.</span>ServerGas <span class="uscript-operator">&amp;&amp;</span>
        OldCarState<span class="uscript-operator">.</span>ServerGear <span class="uscript-operator">==</span> CarState<span class="uscript-operator">.</span>ServerGear <span class="uscript-operator">&amp;&amp;</span>
        OldCarState<span class="uscript-operator">.</span>ServerSteering <span class="uscript-operator">==</span> CarState<span class="uscript-operator">.</span>ServerSteering <span class="uscript-operator">&amp;&amp;</span>
        OldCarState<span class="uscript-operator">.</span>ServerViewPitch <span class="uscript-operator">==</span> CarState<span class="uscript-operator">.</span>ServerViewPitch <span class="uscript-operator">&amp;&amp;</span>
        OldCarState<span class="uscript-operator">.</span>ServerViewYaw <span class="uscript-operator">==</span> CarState<span class="uscript-operator">.</span>ServerViewYaw<span class="uscript-operator">)</span>
        <span class="uscript-keyword">return</span><span class="uscript-operator">;</span>

    ChassisState<span class="uscript-operator">.</span>Position<span class="uscript-operator">.</span>X <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ChassisPosition<span class="uscript-operator">.</span>X<span class="uscript-operator">;</span>
    ChassisState<span class="uscript-operator">.</span>Position<span class="uscript-operator">.</span>Y <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ChassisPosition<span class="uscript-operator">.</span>Y<span class="uscript-operator">;</span>
    ChassisState<span class="uscript-operator">.</span>Position<span class="uscript-operator">.</span>Z <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ChassisPosition<span class="uscript-operator">.</span>Z<span class="uscript-operator">;</span>

    ChassisState<span class="uscript-operator">.</span>Quaternion <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ChassisQuaternion<span class="uscript-operator">;</span>

    ChassisState<span class="uscript-operator">.</span>LinVel<span class="uscript-operator">.</span>X <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>1f <span class="uscript-operator">*</span> CarState<span class="uscript-operator">.</span>ChassisLinVel<span class="uscript-operator">.</span>X<span class="uscript-operator">;</span>
    ChassisState<span class="uscript-operator">.</span>LinVel<span class="uscript-operator">.</span>Y <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>1f <span class="uscript-operator">*</span> CarState<span class="uscript-operator">.</span>ChassisLinVel<span class="uscript-operator">.</span>Y<span class="uscript-operator">;</span>
    ChassisState<span class="uscript-operator">.</span>LinVel<span class="uscript-operator">.</span>Z <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>1f <span class="uscript-operator">*</span> CarState<span class="uscript-operator">.</span>ChassisLinVel<span class="uscript-operator">.</span>Z<span class="uscript-operator">;</span>

    ChassisState<span class="uscript-operator">.</span>AngVel<span class="uscript-operator">.</span>X <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>001f <span class="uscript-operator">*</span> CarState<span class="uscript-operator">.</span>ChassisAngVel<span class="uscript-operator">.</span>X<span class="uscript-operator">;</span>
    ChassisState<span class="uscript-operator">.</span>AngVel<span class="uscript-operator">.</span>Y <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>001f <span class="uscript-operator">*</span> CarState<span class="uscript-operator">.</span>ChassisAngVel<span class="uscript-operator">.</span>Y<span class="uscript-operator">;</span>
    ChassisState<span class="uscript-operator">.</span>AngVel<span class="uscript-operator">.</span>Z <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">.</span>001f <span class="uscript-operator">*</span> CarState<span class="uscript-operator">.</span>ChassisAngVel<span class="uscript-operator">.</span>Z<span class="uscript-operator">;</span>

    bNewCarState <span class="uscript-operator">=</span> <span class="uscript-keyword">true</span><span class="uscript-operator">;</span>
    OldCarState<span class="uscript-operator">.</span>ChassisPosition <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ChassisPosition<span class="uscript-operator">;</span>
    OldCarState<span class="uscript-operator">.</span>ChassisQuaternion <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ChassisQuaternion<span class="uscript-operator">;</span>
    OldCarState<span class="uscript-operator">.</span>ChassisLinVel <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ChassisLinVel<span class="uscript-operator">;</span>
    OldCarState<span class="uscript-operator">.</span>ChassisAngVel <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ChassisAngVel<span class="uscript-operator">;</span>
    OldCarState<span class="uscript-operator">.</span>ServerHandbrake <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ServerHandbrake<span class="uscript-operator">;</span>
    OldCarState<span class="uscript-operator">.</span>ServerBrake <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ServerBrake<span class="uscript-operator">;</span>
    OldCarState<span class="uscript-operator">.</span>ServerGas <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ServerGas<span class="uscript-operator">;</span>
    OldCarState<span class="uscript-operator">.</span>ServerGear <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ServerGear<span class="uscript-operator">;</span>
    OldCarState<span class="uscript-operator">.</span>ServerSteering <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ServerSteering<span class="uscript-operator">;</span>
    OldCarState<span class="uscript-operator">.</span>ServerViewPitch <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ServerViewPitch<span class="uscript-operator">;</span>
    OldCarState<span class="uscript-operator">.</span>ServerViewYaw <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ServerViewYaw<span class="uscript-operator">;</span>

    OutputPitch <span class="uscript-operator">=</span> RangeByteToFloat<span class="uscript-operator">(</span>CarState<span class="uscript-operator">.</span>ServerHandbrake<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    OutputHandbrake <span class="uscript-operator">=</span> <span class="uscript-operator">(</span>OutputPitch <span class="uscript-operator">&gt;</span> <span class="uscript-number">0.01</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    OutputBrake <span class="uscript-operator">=</span> RangeByteToFloat<span class="uscript-operator">(</span>CarState<span class="uscript-operator">.</span>ServerBrake<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    OutputGas <span class="uscript-operator">=</span> RangeByteToFloat<span class="uscript-operator">(</span>CarState<span class="uscript-operator">.</span>ServerGas<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    Gear <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ServerGear<span class="uscript-operator">;</span>
    Steering <span class="uscript-operator">=</span> RangeByteToFloat<span class="uscript-operator">(</span>CarState<span class="uscript-operator">.</span>ServerSteering<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    DriverViewPitch <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ServerViewPitch<span class="uscript-operator">;</span>
    DriverViewYaw <span class="uscript-operator">=</span> CarState<span class="uscript-operator">.</span>ServerViewYaw<span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>PrecacheAnnouncer</dt></dl>
<pre class="uscript"><span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> PrecacheAnnouncer<span class="uscript-operator">(</span>AnnouncerVoice V<span class="uscript-operator">,</span> <span class="uscript-type">bool</span> bRewardSounds<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>

    <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>bRewardSounds <span class="uscript-operator">&amp;&amp;</span> <span class="uscript-operator">!</span>bSoundsPrecached<span class="uscript-operator">)</span>
        V<span class="uscript-operator">.</span>PrecacheSound<span class="uscript-operator">(</span><span class="uscript-name">'fender_bender'</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>PrecacheAnnouncer<span class="uscript-operator">(</span>V<span class="uscript-operator">,</span> bRewardSounds<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>KUpdateState</dt><dd>This function tells when we should update.</dd></dl>
<pre class="uscript"><span class="uscript-keyword">event</span> <span class="uscript-type">bool</span> KUpdateState<span class="uscript-operator">(</span><span class="uscript-keyword">out</span> KRigidBodyState newState<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Role <span class="uscript-operator">==</span> ROLE_Authority <span class="uscript-operator">||</span> <span class="uscript-operator">!</span>bNewCarState<span class="uscript-operator">)</span>
        <span class="uscript-keyword">return</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>

    newState <span class="uscript-operator">=</span> ChassisState<span class="uscript-operator">;</span>
    bNewCarState <span class="uscript-operator">=</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
    <span class="uscript-keyword">return</span> <span class="uscript-keyword">true</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>SVehicleUpdateParams</dt></dl>
<pre class="uscript"><span class="uscript-keyword">event</span> SVehicleUpdateParams<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">local</span> <span class="uscript-type">int</span> i<span class="uscript-operator">;</span>

    <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>SVehicleUpdateParams<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    <span class="uscript-keyword">for</span><span class="uscript-operator">(</span>i<span class="uscript-operator">=</span><span class="uscript-number">0</span><span class="uscript-operator">;</span> i<span class="uscript-operator">&lt;</span>Wheels<span class="uscript-operator">.</span><span class="uscript-keyword">Length</span><span class="uscript-operator">;</span> i<span class="uscript-operator">++</span><span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>Softness <span class="uscript-operator">=</span> WheelSoftness<span class="uscript-operator">;</span>
        Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>PenScale <span class="uscript-operator">=</span> WheelPenScale<span class="uscript-operator">;</span>
        Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>PenOffset <span class="uscript-operator">=</span> WheelPenOffset<span class="uscript-operator">;</span>
        Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LongSlip <span class="uscript-operator">=</span> WheelLongSlip<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">;</span>
        Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LatSlipFunc <span class="uscript-operator">=</span> WheelLatSlipFunc<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">;</span>
        Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>Restitution <span class="uscript-operator">=</span> WheelRestitution<span class="uscript-operator">;</span>
        Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>Adhesion <span class="uscript-operator">=</span> WheelAdhesion<span class="uscript-operator">;</span>
        Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>WheelInertia <span class="uscript-operator">=</span> WheelInertia<span class="uscript-operator">;</span>
        Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LongFrictionFunc <span class="uscript-operator">=</span> WheelLongFrictionFunc<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span><span class="uscript-operator">;</span>
        Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>HandbrakeFrictionFactor <span class="uscript-operator">=</span> WheelHandbrakeFriction<span class="uscript-operator">;</span>
        Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>HandbrakeSlipFactor <span class="uscript-operator">=</span> WheelHandbrakeSlip<span class="uscript-operator">;</span>
        Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SuspensionTravel <span class="uscript-operator">=</span> WheelSuspensionTravel<span class="uscript-operator">;</span>
        Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SuspensionOffset <span class="uscript-operator">=</span> WheelSuspensionOffset<span class="uscript-operator">;</span>
        Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SuspensionMaxRenderTravel <span class="uscript-operator">=</span> WheelSuspensionMaxRenderTravel<span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Level<span class="uscript-operator">.</span>NetMode <span class="uscript-operator">!=</span> NM_DedicatedServer <span class="uscript-operator">&amp;&amp;</span> bMakeBrakeLights<span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-keyword">for</span><span class="uscript-operator">(</span>i<span class="uscript-operator">=</span><span class="uscript-number">0</span><span class="uscript-operator">;</span> i<span class="uscript-operator">&lt;</span><span class="uscript-number">2</span><span class="uscript-operator">;</span> i<span class="uscript-operator">++</span><span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
                     <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>BrakeLight<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span> <span class="uscript-operator">!=</span> <span class="uscript-keyword">None</span><span class="uscript-operator">)</span>
                     <span class="uscript-operator">{</span>
                BrakeLight<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SetBase<span class="uscript-operator">(</span><span class="uscript-keyword">None</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                BrakeLight<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SetLocation<span class="uscript-operator">(</span> Location <span class="uscript-operator">+</span> <span class="uscript-operator">(</span>BrakelightOffset<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span> <span class="uscript-operator">&gt;&gt;</span> Rotation<span class="uscript-operator">)</span> <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                BrakeLight<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SetBase<span class="uscript-operator">(</span><span class="uscript-keyword">self</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                BrakeLight<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SetRelativeRotation<span class="uscript-operator">(</span> <span class="uscript-keyword">rot</span><span class="uscript-operator">(</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">32768</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">)</span> <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                BrakeLight<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>Skins<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span> <span class="uscript-operator">=</span> BrakeLightMaterial<span class="uscript-operator">;</span>
              <span class="uscript-operator">}</span>
        <span class="uscript-operator">}</span>
    <span class="uscript-operator">}</span>
<span class="uscript-operator">}</span></pre><dl><dt>UpdateVehicle</dt><dd>This is the function were everything happens</dd></dl>
<pre class="paraverbatim">           <i>Also see </i><a href="manual-shift-car-cplusplus.html">Manual Shift Car/C++ Version</a></pre><pre class="uscript"><span class="uscript-keyword">function</span> UpdateVehicle<span class="uscript-operator">(</span><span class="uscript-type">float</span> DeltaTime<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
        <span class="uscript-keyword">local</span> Matrix carTM<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> Vector worldUp<span class="uscript-operator">,</span> worldRight<span class="uscript-operator">,</span> worldForward<span class="uscript-operator">;</span>

        <span class="uscript-keyword">local</span> KarmaParams KP<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> KRigidBodyState rbState<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> <span class="uscript-type">int</span>   i<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> <span class="uscript-type">float</span> maxSteerAngle<span class="uscript-operator">,</span> maxSteer<span class="uscript-operator">,</span> deltaSteer<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> <span class="uscript-type">float</span> DriveTorque<span class="uscript-operator">,</span> GripTorque<span class="uscript-operator">,</span> EngineTorque<span class="uscript-operator">,</span> EngineBraking<span class="uscript-operator">,</span> EngineWheelRatio<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> <span class="uscript-type">float</span> BrakeTorque<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> <span class="uscript-type">float</span> NewTotalSpinVel<span class="uscript-operator">,</span> LSDSplit<span class="uscript-operator">,</span> EvenSplit<span class="uscript-operator">,</span> UseSplit<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> <span class="uscript-type">float</span> TransInertia<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> <span class="uscript-type">float</span> LimitBrakeTorque<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> <span class="uscript-type">float</span> WheelTorque<span class="uscript-operator">,</span> VehicleForce<span class="uscript-operator">,</span> TransAcc<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> <span class="uscript-type">float</span> TurnAngVel<span class="uscript-operator">,</span> DampingScale<span class="uscript-operator">,</span> TurnDampingMag<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> <span class="uscript-type">float</span> PitchAngVel<span class="uscript-operator">,</span> RollAngVel<span class="uscript-operator">,</span> PitchDampingMag<span class="uscript-operator">,</span> RollDampingMag<span class="uscript-operator">;</span>

        <span class="uscript-keyword">local</span> Vector AirControlTorque<span class="uscript-operator">,</span> AngVel<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> <span class="uscript-type">float</span>  VRate<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> Vector Force<span class="uscript-operator">,</span> Torque<span class="uscript-operator">;</span>
        <span class="uscript-keyword">local</span> <span class="uscript-type">int</span> z<span class="uscript-operator">;</span>

        WForce <span class="uscript-operator">=</span> <span class="uscript-keyword">vect</span><span class="uscript-operator">(</span><span class="uscript-number">0</span><span class="uscript-operator">,</span> <span class="uscript-number">0</span><span class="uscript-operator">,</span> <span class="uscript-number">0</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    WTorque <span class="uscript-operator">=</span> <span class="uscript-keyword">vect</span><span class="uscript-operator">(</span><span class="uscript-number">0</span><span class="uscript-operator">,</span> <span class="uscript-number">0</span><span class="uscript-operator">,</span> <span class="uscript-number">0</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>KIsAwake<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">)</span>
        <span class="uscript-keyword">return</span><span class="uscript-operator">;</span>
        KP <span class="uscript-operator">=</span> KarmaParams<span class="uscript-operator">(</span>KParams<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>KP <span class="uscript-operator">==</span> <span class="uscript-keyword">None</span><span class="uscript-operator">)</span>
        <span class="uscript-keyword">return</span><span class="uscript-operator">;</span>

        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Controller <span class="uscript-operator">!=</span> <span class="uscript-keyword">None</span><span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
          <span class="uscript-comment">//Calc up (z), right(y) and forward (x) vectors</span>
          GetAxes<span class="uscript-operator">(</span>Rotation<span class="uscript-operator">,</span> worldRight<span class="uscript-operator">,</span> worldForward<span class="uscript-operator">,</span> worldUp<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

          <span class="uscript-comment">/////////// STEERING ///////////</span>
          maxSteerAngle <span class="uscript-operator">=</span> InterpCurveEval<span class="uscript-operator">(</span>MaxSteerAngleCurve<span class="uscript-operator">,</span> VRate<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
          <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>maxSteerAngle<span class="uscript-operator">==</span><span class="uscript-number">0</span><span class="uscript-operator">)</span>
                    maxSteer <span class="uscript-operator">=</span> DeltaTime <span class="uscript-operator">*</span> SteerSpeed <span class="uscript-operator">*</span> maxSteerAngle<span class="uscript-operator">;</span>
              <span class="uscript-keyword">else</span>
                maxSteer <span class="uscript-operator">=</span> DeltaTime <span class="uscript-operator">*</span> SteerSpeed<span class="uscript-operator">;</span>

          deltaSteer <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-operator">-</span>Steering <span class="uscript-operator">*</span> maxSteerAngle<span class="uscript-operator">)</span> <span class="uscript-operator">-</span> ActualSteering<span class="uscript-operator">;</span> <span class="uscript-comment">// Amount we want to move (target - current)</span>
          deltaSteer <span class="uscript-operator">=</span> Clamp<span class="uscript-operator">(</span>deltaSteer<span class="uscript-operator">,</span> <span class="uscript-operator">-</span>maxSteer<span class="uscript-operator">,</span> maxSteer<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
          ActualSteering <span class="uscript-operator">+=</span> deltaSteer<span class="uscript-operator">;</span>

          <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bAuto<span class="uscript-operator">==</span><span class="uscript-keyword">True</span><span class="uscript-operator">)</span>
              <span class="uscript-operator">{</span>
                  EngineTorque <span class="uscript-operator">=</span> OutputGas <span class="uscript-operator">*</span> InterpCurveEval<span class="uscript-operator">(</span>TorqueCurve<span class="uscript-operator">,</span> EngineRPM<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                  EngineBraking <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-number">1</span><span class="uscript-operator">.</span>0f <span class="uscript-operator">-</span> OutputGas<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> <span class="uscript-operator">(</span>EngineBrakeRPMScale<span class="uscript-operator">*</span>EngineRPM <span class="uscript-operator">*</span> EngineBrakeRPMScale<span class="uscript-operator">*</span>EngineRPM <span class="uscript-operator">*</span> EngineBrakeFactor<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                  EngineTorque <span class="uscript-operator">-=</span> EngineBraking<span class="uscript-operator">;</span>
                  EngineWheelRatio <span class="uscript-operator">=</span> GearRatios<span class="uscript-operator">[</span>Gear<span class="uscript-operator">]</span> <span class="uscript-operator">*</span> TransRatio<span class="uscript-operator">;</span>
                  NewTotalSpinVel<span class="uscript-operator">=</span><span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                  EngineRPM <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                  <span class="uscript-keyword">for</span><span class="uscript-operator">(</span>i<span class="uscript-operator">=</span><span class="uscript-number">0</span><span class="uscript-operator">;</span> i<span class="uscript-operator">&lt;</span>Wheels<span class="uscript-operator">.</span><span class="uscript-keyword">length</span><span class="uscript-operator">;</span> i<span class="uscript-operator">++</span><span class="uscript-operator">)</span>
                  <span class="uscript-operator">{</span>
                      EvenSplit <span class="uscript-operator">=</span> <span class="uscript-number">1</span><span class="uscript-operator">/</span>NumPoweredWheels<span class="uscript-operator">;</span>
                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>TotalSpinVel <span class="uscript-operator">&gt;</span> <span class="uscript-number">0.1</span><span class="uscript-operator">)</span>
                          LSDSplit <span class="uscript-operator">=</span> <span class="uscript-operator">(</span>TotalSpinVel <span class="uscript-operator">-</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel<span class="uscript-operator">)</span><span class="uscript-operator">/</span><span class="uscript-operator">(</span><span class="uscript-operator">(</span>NumPoweredWheels<span class="uscript-number">-1</span><span class="uscript-operator">)</span> <span class="uscript-operator">*</span> TotalSpinVel<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                      <span class="uscript-keyword">else</span>
                          LSDSplit <span class="uscript-operator">=</span> EvenSplit<span class="uscript-operator">;</span>
                      UseSplit <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-operator">(</span><span class="uscript-number">1</span><span class="uscript-operator">-</span>LSDFactor<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> EvenSplit<span class="uscript-operator">)</span> <span class="uscript-operator">+</span> <span class="uscript-operator">(</span>LSDFactor <span class="uscript-operator">*</span> LSDSplit<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                      DriveTorque <span class="uscript-operator">=</span> UseSplit <span class="uscript-operator">*</span> <span class="uscript-operator">(</span>EngineTorque <span class="uscript-operator">/</span> EngineWheelRatio<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                      GripTorque <span class="uscript-operator">=</span> FTScale <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>WheelRadius <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>TireLoad <span class="uscript-operator">*</span> WheelLongFrictionScale<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span> <span class="uscript-operator">*</span> InterpCurveEval<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LongFrictionFunc<span class="uscript-operator">,</span> Abs<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SlipVel<span class="uscript-operator">)</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SlipVel <span class="uscript-operator">&lt;</span> <span class="uscript-number">0.0</span><span class="uscript-operator">)</span>
                          GripTorque <span class="uscript-operator">*=</span> <span class="uscript-operator">-</span><span class="uscript-number">1.0</span><span class="uscript-operator">;</span>
                      TransInertia <span class="uscript-operator">=</span> <span class="uscript-operator">(</span>EngineInertia <span class="uscript-operator">/</span> Abs<span class="uscript-operator">(</span>GearRatios<span class="uscript-operator">[</span>Gear<span class="uscript-operator">]</span> <span class="uscript-operator">*</span> TransRatio<span class="uscript-operator">)</span><span class="uscript-operator">)</span> <span class="uscript-operator">+</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>WheelInertia<span class="uscript-operator">;</span>
                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">&gt;</span> <span class="uscript-number">0.0</span><span class="uscript-operator">)</span>
                              BrakeTorque <span class="uscript-operator">=</span> <span class="uscript-operator">-</span>OutputBrake <span class="uscript-operator">*</span> MaxBrakeTorque<span class="uscript-operator">;</span>
                              <span class="uscript-keyword">else</span>
                                      BrakeTorque <span class="uscript-operator">=</span> OutputBrake <span class="uscript-operator">*</span> MaxBrakeTorque<span class="uscript-operator">;</span>

                      LimitBrakeTorque <span class="uscript-operator">=</span> <span class="uscript-operator">(</span> Abs<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> TransInertia <span class="uscript-operator">)</span> <span class="uscript-operator">/</span> TheDeltaTime<span class="uscript-operator">;</span> <span class="uscript-comment">// Size of torque needed to completely stop wheel spinning.</span>
                      BrakeTorque <span class="uscript-operator">=</span> Clamp<span class="uscript-operator">(</span>BrakeTorque<span class="uscript-operator">,</span> <span class="uscript-operator">-</span>LimitBrakeTorque<span class="uscript-operator">,</span> LimitBrakeTorque<span class="uscript-operator">)</span><span class="uscript-operator">;</span> <span class="uscript-comment">// Never apply more than this!</span>
                      WheelTorque <span class="uscript-operator">=</span> DriveTorque <span class="uscript-operator">+</span> BrakeTorque <span class="uscript-operator">-</span> GripTorque<span class="uscript-operator">;</span>
                      VehicleForce <span class="uscript-operator">=</span> GripTorque <span class="uscript-operator">/</span> <span class="uscript-operator">(</span>FTScale <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>WheelRadius<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span> OutputBrake <span class="uscript-operator">&gt;</span> <span class="uscript-number">0.0</span> <span class="uscript-operator">||</span>  <span class="uscript-operator">(</span>DriveTorque <span class="uscript-operator">+</span> BrakeTorque<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">&lt;</span> <span class="uscript-number">0.0</span><span class="uscript-operator">)</span>
                      <span class="uscript-operator">{</span>
                          Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>DriveForce <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                          Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LongFriction <span class="uscript-operator">=</span> Abs<span class="uscript-operator">(</span>VehicleForce<span class="uscript-operator">)</span> <span class="uscript-operator">+</span> <span class="uscript-operator">(</span>OutputBrake <span class="uscript-operator">*</span> MinBrakeFriction<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                      <span class="uscript-operator">}</span>
                      <span class="uscript-keyword">else</span>
                      <span class="uscript-operator">{</span>
                          Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>DriveForce <span class="uscript-operator">=</span> VehicleForce<span class="uscript-operator">;</span>
                          Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LongFriction <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                      <span class="uscript-operator">}</span>
                      <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bWheelOnGround<span class="uscript-operator">)</span>
                          Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>ChassisTorque <span class="uscript-operator">=</span> <span class="uscript-operator">-</span><span class="uscript-number">1.0</span> <span class="uscript-operator">*</span> <span class="uscript-operator">(</span>DriveTorque <span class="uscript-operator">+</span> BrakeTorque<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> ChassisTorqueScale<span class="uscript-operator">;</span>
                       <span class="uscript-keyword">else</span>
                          Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>ChassisTorque <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                      TransAcc <span class="uscript-operator">=</span> WheelTorque <span class="uscript-operator">/</span> TransInertia<span class="uscript-operator">;</span>
                      Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">+=</span> TransAcc <span class="uscript-operator">*</span> DeltaTime<span class="uscript-operator">;</span>
                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Gear <span class="uscript-operator">==</span> <span class="uscript-number">0</span> <span class="uscript-operator">&amp;&amp;</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">&gt;</span> <span class="uscript-number">0.0</span><span class="uscript-operator">)</span>
                          Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                      <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Gear <span class="uscript-operator">&gt;</span> <span class="uscript-number">0</span> <span class="uscript-operator">&amp;&amp;</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">&lt;</span> <span class="uscript-number">0.0</span><span class="uscript-operator">)</span>
                          Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                      NewTotalSpinVel <span class="uscript-operator">+=</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel<span class="uscript-operator">;</span>
                      EngineRPM <span class="uscript-operator">+=</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">/</span> EngineWheelRatio<span class="uscript-operator">;</span>
                      Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LatFriction <span class="uscript-operator">=</span> WheelLatFrictionScale<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span> <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>TireLoad<span class="uscript-operator">;</span>
                      Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LatSlip <span class="uscript-operator">=</span> InterpCurveEval<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LatSlipFunc<span class="uscript-operator">,</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SlipAngle<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>OutputHandbrake <span class="uscript-operator">&amp;&amp;</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bHandbrakeWheel<span class="uscript-operator">)</span>
                      <span class="uscript-operator">{</span>
                          Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LatFriction <span class="uscript-operator">*=</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>HandbrakeFrictionFactor<span class="uscript-operator">;</span>
                          Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LatSlip <span class="uscript-operator">*=</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>HandbrakeSlipFactor<span class="uscript-operator">;</span>
                              <span class="uscript-operator">}</span>
                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SteerType <span class="uscript-operator">==</span> VST_Steered<span class="uscript-operator">)</span>
                          Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>Steer <span class="uscript-operator">=</span> ActualSteering<span class="uscript-operator">;</span>
                      <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SteerType <span class="uscript-operator">==</span> VST_Inverted<span class="uscript-operator">)</span>
                          Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>Steer <span class="uscript-operator">=</span> <span class="uscript-operator">-</span>ActualSteering<span class="uscript-operator">;</span>
                      <span class="uscript-keyword">else</span>
                          Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>Steer <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                  <span class="uscript-operator">}</span>
                  EngineRPM <span class="uscript-operator">/=</span> NumPoweredWheels<span class="uscript-operator">;</span>
                  EngineRPM <span class="uscript-operator">=</span> Max<span class="uscript-operator">(</span>EngineRPM<span class="uscript-operator">,</span> <span class="uscript-number">0.01</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span> <span class="uscript-comment">// ensure always positive!</span>
                  TotalSpinVel <span class="uscript-operator">=</span> NewTotalSpinVel<span class="uscript-operator">;</span>
          <span class="uscript-operator">}</span>
<span class="uscript-comment">///////////////STICK SHIFT///////////////////////////////</span>
          <span class="uscript-keyword">else</span>
          <span class="uscript-operator">{</span>
                   <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bClutching<span class="uscript-operator">)</span>
                   <span class="uscript-operator">{</span>
                        EngineTorque <span class="uscript-operator">=</span> InterpCurveEval<span class="uscript-operator">(</span>TorqueCurve<span class="uscript-operator">,</span> EngineRPM<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                   <span class="uscript-operator">}</span>
                   <span class="uscript-keyword">else</span>
                   <span class="uscript-operator">{</span>
                        EngineTorque <span class="uscript-operator">=</span> InterpCurveEval<span class="uscript-operator">(</span>TorqueCurve<span class="uscript-operator">,</span> EngineRPM<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>EngineTorque <span class="uscript-operator">&gt;=</span> <span class="uscript-number">0</span><span class="uscript-operator">)</span>
                        <span class="uscript-operator">{</span>
                               <span class="uscript-comment">// Calculate torque at output of engine. Combination of throttle, current RPM and engine braking.</span>
                            EngineTorque <span class="uscript-operator">=</span> OutputGas <span class="uscript-operator">*</span> InterpCurveEval<span class="uscript-operator">(</span>TorqueCurve<span class="uscript-operator">,</span> EngineRPM<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                        <span class="uscript-operator">}</span>
                        <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>EngineTorque <span class="uscript-operator">&lt;</span> <span class="uscript-number">0</span><span class="uscript-operator">)</span>
                        <span class="uscript-operator">{</span>
                                EngineTorque <span class="uscript-operator">=</span> InterpCurveEval<span class="uscript-operator">(</span>TorqueCurve<span class="uscript-operator">,</span> EngineRPM<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                        <span class="uscript-operator">}</span>

                    EngineBraking <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-number">1</span><span class="uscript-operator">.</span>0f <span class="uscript-operator">-</span> OutputGas<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> <span class="uscript-operator">(</span>EngineBrakeRPMScale<span class="uscript-operator">*</span>EngineRPM <span class="uscript-operator">*</span> EngineBrakeRPMScale<span class="uscript-operator">*</span>EngineRPM <span class="uscript-operator">*</span> EngineBrakeFactor<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
               <span class="uscript-operator">}</span>

                  <span class="uscript-comment">// EngineRPM = OutputGas * InterpCurveEval(RPMCurve, EngineTorque);</span>

               EngineTorque <span class="uscript-operator">-=</span> EngineBraking<span class="uscript-operator">;</span>
                   ETorque <span class="uscript-operator">=</span> EngineTorque<span class="uscript-operator">;</span>
               <span class="uscript-comment">//DebugInfo = FString::Printf(TEXT("OutputBrake: %f  EngineRPM: %f    EngineTorque: %f"), OutputBrake, EngineRPM, EngineTorque);</span>

               <span class="uscript-comment">// Total gear ratio between engine and differential (ie before being split between wheels).</span>
               <span class="uscript-comment">// A higher gear ratio and the torque at the wheels is reduced.</span>
               EngineWheelRatio <span class="uscript-operator">=</span> GearRatios<span class="uscript-operator">[</span>Gear<span class="uscript-operator">]</span> <span class="uscript-operator">*</span> TransRatio<span class="uscript-operator">;</span>

                   <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bClutching<span class="uscript-operator">)</span>
                   <span class="uscript-operator">{</span>
                        <span class="uscript-comment">//EngineRPM = 0.0;</span>
                        WheelRPM <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                   <span class="uscript-operator">}</span>
                   <span class="uscript-keyword">else</span>
                   <span class="uscript-operator">{</span>
                        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bPoweredWheel<span class="uscript-operator">)</span>
                        <span class="uscript-operator">{</span>
                         <span class="uscript-comment">// Reset engine RPM. We calculate this by adding the component of each wheel spinning.</span>
                         NewTotalSpinVel<span class="uscript-operator">=</span><span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                         <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bInGear<span class="uscript-operator">)</span>
                         <span class="uscript-operator">{</span>
                               WheelRPM <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                               EngineRPM <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                         <span class="uscript-operator">}</span>
                         <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bInGear<span class="uscript-operator">)</span>
                               WheelRPM <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                    <span class="uscript-operator">}</span>
               <span class="uscript-operator">}</span>

          <span class="uscript-comment">// Do model for each wheel.</span>
          <span class="uscript-comment">//  Okay this needs to be fixed because the way this is, all the wheels get power</span>

               <span class="uscript-keyword">for</span><span class="uscript-operator">(</span>i<span class="uscript-operator">=</span><span class="uscript-number">0</span><span class="uscript-operator">;</span>i<span class="uscript-operator">&lt;</span>Wheels<span class="uscript-operator">.</span><span class="uscript-keyword">length</span><span class="uscript-operator">;</span> i<span class="uscript-operator">++</span><span class="uscript-operator">)</span>
               <span class="uscript-operator">{</span>
                  <span class="uscript-comment">//Wheels[i];</span>
              <span class="uscript-comment">/////////// DRIVE ///////////</span>
              <span class="uscript-comment">// Heuristic to divide torque up so that the wheels that are spinning slower get more of it.</span>
              <span class="uscript-comment">// Sum of LSDFactor across all wheels should be 1.</span>
              <span class="uscript-comment">// JTODO: Do we need to handle the case of vehicles with different size wheels?</span>

              EvenSplit <span class="uscript-operator">=</span> <span class="uscript-number">1</span><span class="uscript-operator">/</span>NumPoweredWheels<span class="uscript-operator">;</span>

              <span class="uscript-comment">// If no wheels are spinning, just do an even split.</span>
              <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>TotalSpinVel <span class="uscript-operator">&gt;</span> <span class="uscript-number">0.1</span><span class="uscript-operator">)</span>
                  LSDSplit <span class="uscript-operator">=</span> <span class="uscript-operator">(</span>TotalSpinVel <span class="uscript-operator">-</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel<span class="uscript-operator">)</span><span class="uscript-operator">/</span><span class="uscript-operator">(</span><span class="uscript-operator">(</span>NumPoweredWheels<span class="uscript-number">-1</span><span class="uscript-operator">)</span> <span class="uscript-operator">*</span> TotalSpinVel<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
              <span class="uscript-keyword">else</span>
                  LSDSplit <span class="uscript-operator">=</span> EvenSplit<span class="uscript-operator">;</span>

              UseSplit <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-operator">(</span><span class="uscript-number">1</span><span class="uscript-operator">-</span>LSDFactor<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> EvenSplit<span class="uscript-operator">)</span> <span class="uscript-operator">+</span> <span class="uscript-operator">(</span>LSDFactor <span class="uscript-operator">*</span> LSDSplit<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bClutching<span class="uscript-operator">)</span>
                      <span class="uscript-operator">{</span>
                           EngineRPM <span class="uscript-operator">=</span> RPM<span class="uscript-operator">;</span>

                           <span class="uscript-comment">//DriveTorque = UseSplit * (EngineTorque / EngineWheelRatio);</span>
                      <span class="uscript-operator">}</span>
                      <span class="uscript-keyword">else</span>
                      <span class="uscript-operator">{</span>
                           <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bPoweredWheel<span class="uscript-operator">)</span>
                           <span class="uscript-operator">{</span>
                                <span class="uscript-comment">//EngineRPM = RPM;</span>

                                <span class="uscript-comment">// Calculate Drive Torque : applied at wheels (ie after gearbox and differential)</span>
                        <span class="uscript-comment">// This is an 'open differential' ie. equal torque to each wheel</span>
                        DriveTorque <span class="uscript-operator">=</span> UseSplit <span class="uscript-operator">*</span> <span class="uscript-operator">(</span>EngineTorque <span class="uscript-operator">/</span> EngineWheelRatio<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                   <span class="uscript-operator">}</span>
              <span class="uscript-operator">}</span>

              <span class="uscript-comment">/////////// LONGITUDINAL ///////////</span>
              <span class="uscript-comment">// Calculate Grip Torque : longitudinal force against ground * distance of action (radius of tyre)</span>
              <span class="uscript-comment">// LongFrictionFunc is assumed to be reflected for negative Slip Ratio</span>
              GripTorque <span class="uscript-operator">=</span> FTScale <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>WheelRadius <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>TireLoad <span class="uscript-operator">*</span> WheelLongFrictionScale<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span> <span class="uscript-operator">*</span> InterpCurveEval<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LongFrictionFunc<span class="uscript-operator">,</span> Abs<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SlipVel<span class="uscript-operator">)</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

              <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SlipVel <span class="uscript-operator">&lt;</span> <span class="uscript-number">0.0</span><span class="uscript-operator">)</span>
                  GripTorque <span class="uscript-operator">*=</span> <span class="uscript-operator">-</span><span class="uscript-number">1.0</span><span class="uscript-operator">;</span>

                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bPoweredWheel<span class="uscript-operator">)</span>
                      <span class="uscript-operator">{</span>
                           <span class="uscript-comment">// GripTorque can't be more than the torque needed to invert slip ratio.</span>
                   TransInertia <span class="uscript-operator">=</span> <span class="uscript-operator">(</span>EngineInertia <span class="uscript-operator">/</span> Abs<span class="uscript-operator">(</span>GearRatios<span class="uscript-operator">[</span>Gear<span class="uscript-operator">]</span> <span class="uscript-operator">*</span> TransRatio<span class="uscript-operator">)</span><span class="uscript-operator">)</span> <span class="uscript-operator">+</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>WheelInertia<span class="uscript-operator">;</span>
                      <span class="uscript-operator">}</span>

              <span class="uscript-comment">//FLOAT SlipAngVel = Wheels[i].SlipVel/Wheels[i].WheelRadius;</span>

                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bBraking<span class="uscript-operator">)</span>
                      <span class="uscript-operator">{</span>
                   <span class="uscript-comment">// Brake torque acts to stop wheels (ie against direction of motion)</span>
                   BrakeTorque <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                   <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">&gt;</span> <span class="uscript-number">0.0</span><span class="uscript-operator">)</span>
                        BrakeTorque <span class="uscript-operator">=</span> <span class="uscript-operator">-</span>OutputBrake <span class="uscript-operator">*</span> MaxBrakeTorque<span class="uscript-operator">;</span>
                          <span class="uscript-keyword">else</span>
                                BrakeTorque <span class="uscript-operator">=</span> OutputBrake <span class="uscript-operator">*</span> MaxBrakeTorque<span class="uscript-operator">;</span>

                   LimitBrakeTorque <span class="uscript-operator">=</span> <span class="uscript-operator">(</span> Abs<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> TransInertia <span class="uscript-operator">)</span> <span class="uscript-operator">/</span> TheDeltaTime<span class="uscript-operator">;</span> <span class="uscript-comment">// Size of torque needed to completely stop wheel spinning.</span>
                   BrakeTorque <span class="uscript-operator">=</span> Clamp<span class="uscript-operator">(</span>BrakeTorque<span class="uscript-operator">,</span> <span class="uscript-operator">-</span>LimitBrakeTorque<span class="uscript-operator">,</span> LimitBrakeTorque<span class="uscript-operator">)</span><span class="uscript-operator">;</span> <span class="uscript-comment">// Never apply more than this!</span>
                   mBrakeTorque <span class="uscript-operator">=</span> BrakeTorque<span class="uscript-operator">;</span>
                      <span class="uscript-operator">}</span>
                      <span class="uscript-keyword">else</span>
                      <span class="uscript-operator">{</span>
                           BrakeTorque <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
                           mBrakeTorque <span class="uscript-operator">=</span> BrakeTorque<span class="uscript-operator">;</span>
                      <span class="uscript-operator">}</span>
<span class="uscript-comment">//_____________________________________________</span>

                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bClutching<span class="uscript-operator">)</span>
                      <span class="uscript-operator">{</span>
                              WheelTorque <span class="uscript-operator">=</span> GripTorque<span class="uscript-operator">;</span>
                              <span class="uscript-comment">//Log("GripTorque");</span>
                              <span class="uscript-comment">//Log(GripTorque);</span>
                      <span class="uscript-operator">}</span>
                      <span class="uscript-keyword">else</span>     <span class="uscript-comment">// we are in full gear</span>
                      <span class="uscript-operator">{</span>
                           <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bPoweredWheel<span class="uscript-operator">)</span>
                           <span class="uscript-operator">{</span>
                              <span class="uscript-comment">//Don't do this if 4 wheel drive!!!!</span>
                              WheelTorque <span class="uscript-operator">=</span> GripTorque <span class="uscript-operator">*</span> <span class="uscript-number">2</span><span class="uscript-operator">;</span>
                           <span class="uscript-operator">}</span>
                           <span class="uscript-keyword">else</span>
                           <span class="uscript-operator">{</span>
                              <span class="uscript-comment">// Resultant torque at wheel : torque applied from engine + brakes + equal-and-opposite from tire-road interaction.</span>
                      WheelTorque <span class="uscript-operator">=</span> DriveTorque <span class="uscript-operator">+</span> BrakeTorque <span class="uscript-operator">-</span> GripTorque<span class="uscript-operator">;</span>
                  <span class="uscript-comment">/*    Log("WheelTorque");
                              Log(WheelTorque);
                              Log("GripTorque");
                              Log(GripTorque);      */</span>
                   <span class="uscript-operator">}</span>
                      <span class="uscript-operator">}</span>
<span class="uscript-comment">//____________________________________________</span>

              <span class="uscript-comment">// Resultant linear force applied to car. (GripTorque applied at road)</span>
              VehicleForce <span class="uscript-operator">=</span> GripTorque <span class="uscript-operator">/</span> <span class="uscript-operator">(</span>FTScale <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>WheelRadius<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

              <span class="uscript-comment">// If the wheel torque is opposing the direction of spin (ie braking) we use friction to apply it.</span>
              <span class="uscript-keyword">if</span><span class="uscript-operator">(</span> OutputBrake <span class="uscript-operator">&gt;</span> <span class="uscript-number">0</span> <span class="uscript-operator">&amp;&amp;</span> bBraking<span class="uscript-operator">)</span><span class="uscript-comment">//  || (DriveTorque + BrakeTorque) * Wheels[i].SpinVel &lt; 0.0</span>
              <span class="uscript-operator">{</span>
                  Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>DriveForce <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                  Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LongFriction <span class="uscript-operator">=</span> Abs<span class="uscript-operator">(</span>VehicleForce<span class="uscript-operator">)</span> <span class="uscript-operator">+</span> <span class="uscript-operator">(</span>OutputBrake <span class="uscript-operator">*</span> MinBrakeFriction<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
              <span class="uscript-operator">}</span>
              <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bClutching<span class="uscript-operator">)</span>
              <span class="uscript-operator">{</span>
                      Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>DriveForce <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                              Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LongFriction <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
              <span class="uscript-operator">}</span>
              <span class="uscript-keyword">else</span>
              <span class="uscript-operator">{</span>
                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bPoweredWheel<span class="uscript-operator">)</span>
                      <span class="uscript-operator">{</span>
                             Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>DriveForce <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                                     Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LongFriction <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                      <span class="uscript-operator">}</span>
                      <span class="uscript-keyword">else</span>
                      <span class="uscript-operator">{</span>
                       Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>DriveForce <span class="uscript-operator">=</span> VehicleForce<span class="uscript-operator">;</span>
                                   Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LongFriction <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                       <span class="uscript-comment">//Wheels[i].LongFriction = 0.0;</span>
                  <span class="uscript-operator">}</span>
              <span class="uscript-operator">}</span>


                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bPoweredWheel<span class="uscript-operator">)</span>
                      <span class="uscript-operator">{</span>
                   <span class="uscript-comment">// Calculate torque applied back to chassis if wheel is on the ground</span>
                   <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bWheelOnGround<span class="uscript-operator">)</span>
                  Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>ChassisTorque <span class="uscript-operator">=</span> <span class="uscript-operator">-</span><span class="uscript-number">1.0</span> <span class="uscript-operator">*</span> <span class="uscript-operator">(</span>DriveTorque <span class="uscript-operator">+</span> BrakeTorque<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> ChassisTorqueScale<span class="uscript-operator">;</span>
                   <span class="uscript-keyword">else</span>
                  Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>ChassisTorque <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                      <span class="uscript-operator">}</span>

              <span class="uscript-comment">// Calculate new wheel speed.</span>
              <span class="uscript-comment">// The lower the gear ratio, the harder it is to accelerate the engine.</span>

              <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bClutching<span class="uscript-operator">)</span>
              <span class="uscript-operator">{</span>
                     TransAcc <span class="uscript-operator">=</span> WheelTorque <span class="uscript-operator">/</span> <span class="uscript-operator">-</span><span class="uscript-number">1</span><span class="uscript-operator">;</span>
                     Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">+=</span> TransAcc <span class="uscript-operator">*</span> DeltaTime<span class="uscript-operator">;</span>
              <span class="uscript-operator">}</span>
              <span class="uscript-keyword">else</span>
              <span class="uscript-operator">{</span>
                     <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bPoweredWheel<span class="uscript-operator">)</span>
                     <span class="uscript-operator">{</span>
                           TransAcc <span class="uscript-operator">=</span> WheelTorque <span class="uscript-operator">/</span> <span class="uscript-operator">-</span><span class="uscript-number">1</span><span class="uscript-operator">;</span>
                           Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">+=</span> TransAcc <span class="uscript-operator">*</span> DeltaTime<span class="uscript-operator">;</span>
                     <span class="uscript-operator">}</span>
                     <span class="uscript-keyword">else</span>
                     <span class="uscript-operator">{</span>
                           TransAcc <span class="uscript-operator">=</span> WheelTorque <span class="uscript-operator">/</span> TransInertia<span class="uscript-operator">;</span>
                           Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">+=</span> TransAcc <span class="uscript-operator">*</span> DeltaTime<span class="uscript-operator">;</span>
                     <span class="uscript-operator">}</span>
                      <span class="uscript-operator">}</span>

<span class="uscript-comment">//  -----this is were the engine needs to be slowly put into gear-----</span>

                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bClutching<span class="uscript-operator">)</span>
                      <span class="uscript-operator">{</span>

                          WheelRPM <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">/</span> EngineWheelRatio<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                          <span class="uscript-comment">//TorqueConverter();</span>
                      <span class="uscript-operator">}</span>
                      <span class="uscript-keyword">else</span>   <span class="uscript-comment">// we are in full gear</span>
                      <span class="uscript-operator">{</span>
                          <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bPoweredWheel<span class="uscript-operator">)</span>
                          <span class="uscript-operator">{</span>
                               WheelRPM <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">/</span> EngineWheelRatio<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                          <span class="uscript-operator">}</span>
                          <span class="uscript-keyword">else</span>
                          <span class="uscript-operator">{</span>
                               <span class="uscript-comment">// Accumulate wheel spin speeds to find engine RPM.</span>
                       <span class="uscript-comment">// The lower the gear ratio, the faster the engine spins for a given wheel speed.</span>
                       NewTotalSpinVel <span class="uscript-operator">+=</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel<span class="uscript-operator">;</span>
                               <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bInGear<span class="uscript-operator">)</span>
                               <span class="uscript-operator">{</span>
<span class="uscript-comment">//                                  EngineRPM += (Wheels[i].SpinVel / EngineWheelRatio);</span>
                                    WheelRPM <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">/</span> EngineWheelRatio<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                                    TorqueConverter<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

                               <span class="uscript-operator">}</span>
                               <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bInGear<span class="uscript-operator">)</span>
                               <span class="uscript-operator">{</span>
                                    WheelRPM <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">/</span> EngineWheelRatio<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                                    EngineRPM <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">/</span> EngineWheelRatio<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                               <span class="uscript-operator">}</span>
                          <span class="uscript-operator">}</span>

                      <span class="uscript-operator">}</span>
<span class="uscript-comment">//  ---------------------------------------------------------------</span>

              <span class="uscript-comment">// Make sure the wheel can't spin in the wrong direction for the current gear.</span>
              <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bClutching<span class="uscript-operator">)</span>
              <span class="uscript-operator">{</span>
              <span class="uscript-operator">}</span>
              <span class="uscript-keyword">else</span>
              <span class="uscript-operator">{</span>
                   <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bPoweredWheel<span class="uscript-operator">)</span>
                   <span class="uscript-operator">{</span>
                          <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Gear <span class="uscript-operator">==</span> <span class="uscript-number">0</span> <span class="uscript-operator">&amp;&amp;</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">&gt;</span> <span class="uscript-number">0.0</span><span class="uscript-operator">)</span>
                           Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                          <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Gear <span class="uscript-operator">&gt;</span> <span class="uscript-number">0</span> <span class="uscript-operator">&amp;&amp;</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">&lt;</span> <span class="uscript-number">0.0</span><span class="uscript-operator">)</span>
                           Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SpinVel <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
               <span class="uscript-operator">}</span>
              <span class="uscript-operator">}</span>

              <span class="uscript-comment">/////////// LATERAL ///////////</span>
                      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bPoweredWheel<span class="uscript-operator">)</span>
                      <span class="uscript-operator">{</span>
                   Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LatFriction <span class="uscript-operator">=</span> <span class="uscript-operator">(</span>WheelLatFrictionScale<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span> <span class="uscript-operator">*</span> <span class="uscript-number">1.5</span><span class="uscript-operator">)</span> <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>TireLoad <span class="uscript-operator">;</span>
                   Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LatSlip <span class="uscript-operator">=</span> InterpCurveEval<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LatSlipFunc<span class="uscript-operator">,</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SlipAngle<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                      <span class="uscript-operator">}</span>
                      <span class="uscript-keyword">else</span>
                      <span class="uscript-operator">{</span>
                           Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LatFriction <span class="uscript-operator">=</span> WheelLatFrictionScale<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span> <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>TireLoad<span class="uscript-operator">;</span>
                   Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LatSlip <span class="uscript-operator">=</span> InterpCurveEval<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LatSlipFunc<span class="uscript-operator">,</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SlipAngle<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                      <span class="uscript-operator">}</span>

              <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>OutputHandbrake <span class="uscript-operator">&amp;&amp;</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bHandbrakeWheel<span class="uscript-operator">)</span>
              <span class="uscript-operator">{</span>
                  Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LatFriction <span class="uscript-operator">*=</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>HandbrakeFrictionFactor<span class="uscript-operator">;</span>
                  Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LatSlip <span class="uscript-operator">*=</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>HandbrakeSlipFactor<span class="uscript-operator">;</span>
              <span class="uscript-operator">}</span>

              <span class="uscript-comment">/////////// STEERING  ///////////</span>

              <span class="uscript-comment">// Pass on steering to wheels that want it.</span>
              <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SteerType <span class="uscript-operator">==</span> VST_Steered<span class="uscript-operator">)</span>
                  Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>Steer <span class="uscript-operator">=</span> ActualSteering<span class="uscript-operator">;</span>
              <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SteerType <span class="uscript-operator">==</span> VST_Inverted<span class="uscript-operator">)</span>
                  Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>Steer <span class="uscript-operator">=</span> <span class="uscript-operator">-</span>ActualSteering<span class="uscript-operator">;</span>
              <span class="uscript-keyword">else</span>
                  Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>Steer <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
             <span class="uscript-operator">}</span>
              <span class="uscript-operator">}</span>
              <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bClutching<span class="uscript-operator">)</span>
              <span class="uscript-operator">{</span>
              <span class="uscript-operator">}</span>
              <span class="uscript-keyword">else</span>
              <span class="uscript-operator">{</span>
                   <span class="uscript-comment">// EngineRPM is in radians per second, want in revolutions per minute</span>
               EngineRPM <span class="uscript-operator">/=</span> <span class="uscript-number">4</span><span class="uscript-operator">;</span>
<span class="uscript-comment">//             EngineRPM /= 2.0 * PI; // revs per sec</span>
<span class="uscript-comment">//             EngineRPM *= 60;</span>
               EngineRPM <span class="uscript-operator">=</span> Max<span class="uscript-operator">(</span>EngineRPM<span class="uscript-operator">,</span> <span class="uscript-number">0.00</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span> <span class="uscript-comment">// ensure always positive!</span>

               RPM <span class="uscript-operator">/=</span> NumPoweredWheels<span class="uscript-operator">;</span>
<span class="uscript-comment">//             RPM /= 2.0 * PI; // revs per sec</span>
<span class="uscript-comment">//             RPM *= 60;</span>
               RPM <span class="uscript-operator">=</span> Max<span class="uscript-operator">(</span>EngineRPM<span class="uscript-operator">,</span> <span class="uscript-number">0.00</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span> <span class="uscript-comment">// ensure always positive!</span>
              <span class="uscript-operator">}</span>

              <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bClutching<span class="uscript-operator">)</span>
              <span class="uscript-operator">{</span>
               <span class="uscript-comment">// Update total wheel spin vel</span>
               TotalSpinVel <span class="uscript-operator">=</span> NewTotalSpinVel<span class="uscript-operator">;</span>
          <span class="uscript-operator">}</span>

          <span class="uscript-comment">// Turn (yaw) damping.</span>
          carTM <span class="uscript-operator">=</span> CachedLocalToWorld<span class="uscript-operator">;</span>  <span class="uscript-comment">// was  carTM = LocalToWorld()</span>
          <span class="uscript-comment">//worldUp(carTM.M[2][0], carTM.M[2][1], carTM.M[2][2]);</span>
          <span class="uscript-comment">//worldRight(carTM.M[1][0], carTM.M[1][1], carTM.M[1][2]);</span>
          <span class="uscript-comment">//worldForward(carTM.M[0][0], carTM.M[0][1], carTM.M[0][2]);</span>

            <span class="uscript-comment">//  KGetRigidBodyState(rbState);</span>
        <span class="uscript-comment">//  AngVel = KRBVecToVector(rbState.AngVel);</span>
          AngVel<span class="uscript-operator">.</span>X <span class="uscript-operator">=</span> rbState<span class="uscript-operator">.</span>AngVel<span class="uscript-operator">.</span>X<span class="uscript-operator">;</span>
              AngVel<span class="uscript-operator">.</span>Y <span class="uscript-operator">=</span> rbState<span class="uscript-operator">.</span>AngVel<span class="uscript-operator">.</span>Y<span class="uscript-operator">;</span>
              AngVel<span class="uscript-operator">.</span>Z <span class="uscript-operator">=</span> rbState<span class="uscript-operator">.</span>AngVel<span class="uscript-operator">.</span>Z<span class="uscript-operator">;</span>
          TurnAngVel <span class="uscript-operator">=</span> AngVel <span class="uscript-operator">dot</span> worldUp<span class="uscript-operator">;</span>

          DampingScale <span class="uscript-operator">=</span> <span class="uscript-number">1.0</span> <span class="uscript-operator">-</span> MinAirControlDamping<span class="uscript-operator">;</span>
          <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bAllowAirControl <span class="uscript-operator">&amp;&amp;</span> <span class="uscript-operator">!</span>bVehicleOnGround<span class="uscript-operator">)</span>
          <span class="uscript-operator">{</span>
      <span class="uscript-comment">//            Log("bVehicleOnGround");</span>
          <span class="uscript-comment">//            Log(bVehicleOnGround);</span>
              TurnDampingMag <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-number">1.0</span> <span class="uscript-operator">-</span> DampingScale<span class="uscript-operator">*</span>Abs<span class="uscript-operator">(</span>Steering<span class="uscript-operator">)</span><span class="uscript-operator">)</span> <span class="uscript-operator">*</span> TurnDamping <span class="uscript-operator">*</span> TurnAngVel<span class="uscript-operator">;</span>
              <span class="uscript-comment">//KAddImpulse( WForce, -TurnDampingMag * worldUp );</span>
              Force <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span>WForce <span class="uscript-operator">+</span> <span class="uscript-operator">(</span><span class="uscript-operator">-</span><span class="uscript-number">1</span> <span class="uscript-operator">*</span> TurnDampingMag<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> worldUp<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
          <span class="uscript-operator">}</span>

          <span class="uscript-keyword">else</span>
          <span class="uscript-operator">{</span>
              TurnDampingMag <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-number">1.0</span> <span class="uscript-operator">-</span> Abs<span class="uscript-operator">(</span>ActualSteering<span class="uscript-operator">)</span><span class="uscript-operator">)</span> <span class="uscript-operator">*</span> TurnDamping <span class="uscript-operator">*</span> TurnAngVel<span class="uscript-operator">;</span>
              <span class="uscript-comment">//KAddImpulse( WForce, -TurnDampingMag * worldUp );</span>
              Force <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span>WForce <span class="uscript-operator">+</span> <span class="uscript-operator">(</span><span class="uscript-operator">-</span><span class="uscript-number">1</span> <span class="uscript-operator">+</span> TurnDampingMag<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> worldUp<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
          <span class="uscript-operator">}</span>

          <span class="uscript-comment">// If vehicle is in the air and we are allowing air control...</span>
          <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bVehicleOnGround<span class="uscript-operator">)</span>
          <span class="uscript-operator">{</span>
              PitchAngVel <span class="uscript-operator">=</span> AngVel <span class="uscript-operator">dot</span> worldRight<span class="uscript-operator">;</span>
              RollAngVel <span class="uscript-operator">=</span> AngVel <span class="uscript-operator">dot</span> worldForward<span class="uscript-operator">;</span>

              <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bAllowAirControl<span class="uscript-operator">)</span>
              <span class="uscript-operator">{</span>
                  AirControlTorque <span class="uscript-operator">=</span> worldRight <span class="uscript-operator">*</span> OutputPitch <span class="uscript-operator">*</span> <span class="uscript-operator">-</span>AirPitchTorque<span class="uscript-operator">;</span>

                  <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bIsWalking<span class="uscript-operator">)</span>
                  <span class="uscript-operator">{</span>
    <span class="uscript-comment">//                    Log("bIsWalking");</span>
    <span class="uscript-comment">//                    Log(bIsWalking);</span>
                      AirControlTorque <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span>worldForward <span class="uscript-operator">*</span> Steering <span class="uscript-operator">*</span> <span class="uscript-operator">-</span>AirRollTorque<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                      <span class="uscript-operator">}</span>
                  <span class="uscript-keyword">else</span>
                  <span class="uscript-operator">{</span>
                      AirControlTorque <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span>worldUp <span class="uscript-operator">*</span> Steering <span class="uscript-operator">*</span> <span class="uscript-operator">-</span>AirTurnTorque<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                  <span class="uscript-operator">}</span>
                              <span class="uscript-comment">//KAddImpulse( WForce, AirControlTorque );</span>
                  Force <span class="uscript-operator">+=</span> AirControlTorque<span class="uscript-operator">;</span>

                  <span class="uscript-comment">// Damping forces</span>
                  PitchDampingMag <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-number">1.0</span> <span class="uscript-operator">-</span> DampingScale<span class="uscript-operator">*</span>Abs<span class="uscript-operator">(</span>OutputPitch<span class="uscript-operator">)</span><span class="uscript-operator">)</span> <span class="uscript-operator">*</span> AirPitchDamping <span class="uscript-operator">*</span> PitchAngVel<span class="uscript-operator">;</span>
                  RollDampingMag <span class="uscript-operator">=</span> <span class="uscript-operator">(</span><span class="uscript-number">1.0</span> <span class="uscript-operator">-</span> DampingScale<span class="uscript-operator">*</span>Abs<span class="uscript-operator">(</span>Steering<span class="uscript-operator">)</span><span class="uscript-operator">)</span> <span class="uscript-operator">*</span> AirRollDamping <span class="uscript-operator">*</span> RollAngVel<span class="uscript-operator">;</span>

                              <span class="uscript-comment">//KAddImpulse( WForce, (-PitchDampingMag * worldRight) + (-RollDampingMag * worldForward) );</span>
                  Force <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span>WForce <span class="uscript-operator">+</span> <span class="uscript-operator">(</span><span class="uscript-operator">(</span><span class="uscript-operator">-</span><span class="uscript-number">1</span> <span class="uscript-operator">+</span> PitchDampingMag<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> worldRight<span class="uscript-operator">)</span> <span class="uscript-operator">+</span> <span class="uscript-operator">(</span><span class="uscript-operator">(</span><span class="uscript-operator">-</span><span class="uscript-number">1</span> <span class="uscript-operator">+</span> RollDampingMag<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> worldForward<span class="uscript-operator">)</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                  
                  UDForce <span class="uscript-operator">=</span> Force<span class="uscript-operator">;</span>
                  UDTorque <span class="uscript-operator">=</span> Torque<span class="uscript-operator">;</span>
              <span class="uscript-operator">}</span>
              <span class="uscript-keyword">else</span>
              <span class="uscript-operator">{</span>
             PitchDampingMag <span class="uscript-operator">=</span> AirPitchDamping <span class="uscript-operator">*</span> PitchAngVel<span class="uscript-operator">;</span>
             <span class="uscript-comment">//KAddImpulse( WForce, -PitchDampingMag * worldRight );</span>
             Force <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span>WForce <span class="uscript-operator">+</span> <span class="uscript-operator">(</span><span class="uscript-operator">-</span><span class="uscript-number">1</span> <span class="uscript-operator">+</span> PitchDampingMag<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> worldRight<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
              <span class="uscript-operator">}</span>
              <span class="uscript-operator">}</span>
              <span class="uscript-keyword">else</span>
              <span class="uscript-operator">{</span>
                   UDForce <span class="uscript-operator">=</span> Force<span class="uscript-operator">;</span>
                   UDTorque <span class="uscript-operator">=</span> Torque<span class="uscript-operator">;</span>
              <span class="uscript-operator">}</span>
    <span class="uscript-operator">}</span>
<span class="uscript-operator">}</span></pre><dl><dt>Engine</dt></dl>
<pre class="uscript"><span class="uscript-keyword">function</span> Engine<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
     Gas <span class="uscript-operator">=</span> Gas2<span class="uscript-operator">;</span>
     RPM <span class="uscript-operator">=</span> InterpCurveEval<span class="uscript-operator">(</span>EngineS<span class="uscript-operator">,</span> Gas<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>StoptheCar</dt></dl>
<ul><li>This function allows for slower, more real life like breaking</li>
</ul>
<pre class="uscript"><span class="uscript-keyword">function</span> StoptheCar<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
   <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bBraking<span class="uscript-operator">)</span>
   <span class="uscript-operator">{</span>
      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>hBrake<span class="uscript-operator">&lt;=</span><span class="uscript-number">21</span> <span class="uscript-operator">&amp;&amp;</span> hBrake<span class="uscript-operator">&gt;=</span><span class="uscript-number">0</span><span class="uscript-operator">)</span>
      <span class="uscript-operator">{</span>
           hBrake <span class="uscript-operator">+=</span> <span class="uscript-number">0.5</span><span class="uscript-operator">;</span>
      <span class="uscript-operator">}</span>
      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>hBrake<span class="uscript-operator">&gt;</span><span class="uscript-number">21</span><span class="uscript-operator">)</span>
             hBrake <span class="uscript-operator">=</span> <span class="uscript-number">21</span><span class="uscript-operator">;</span>
   <span class="uscript-operator">}</span>
   <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bBraking<span class="uscript-operator">)</span>
   <span class="uscript-operator">{</span>
           <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>hBrake<span class="uscript-operator">&lt;=</span><span class="uscript-number">21</span> <span class="uscript-operator">&amp;&amp;</span> hBrake<span class="uscript-operator">&gt;=</span><span class="uscript-number">0</span><span class="uscript-operator">)</span>
           <span class="uscript-operator">{</span>
                hBrake <span class="uscript-operator">-=</span> <span class="uscript-number">0.5</span><span class="uscript-operator">;</span>
           <span class="uscript-operator">}</span>
           <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>hBrake<span class="uscript-operator">&lt;</span><span class="uscript-number">0</span><span class="uscript-operator">)</span>
                hBrake <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
   <span class="uscript-operator">}</span>
<span class="uscript-operator">}</span></pre><dl><dt>TorqueConverter</dt></dl>
<ul><li>This function should prolly have a different name, I named it this thinking I would need to accually have a torque converter for the tranny but I turned out making it a function that eases into gear and fixes the rpm to equal that of the engine rpm when the clutch is pressed.</li>
</ul>
<pre class="uscript"><span class="uscript-keyword">function</span> TorqueConverter<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">local</span>  <span class="uscript-type">float</span>    rpmDifference<span class="uscript-operator">;</span>
    <span class="uscript-keyword">local</span>  <span class="uscript-type">float</span>    myRPM<span class="uscript-operator">;</span>
    rpmDifference <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
    myRPM <span class="uscript-operator">=</span> WheelRPM<span class="uscript-operator">;</span>
    myRPM <span class="uscript-operator">*=</span> <span class="uscript-number">6.28</span><span class="uscript-operator">;</span> <span class="uscript-comment">// convert to radians per sec</span>
    myRPM <span class="uscript-operator">/=</span> <span class="uscript-number">60</span><span class="uscript-operator">;</span>
         <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>EngineRPM <span class="uscript-operator">==</span> myRPM<span class="uscript-operator">)</span>
              bInGear <span class="uscript-operator">=</span> <span class="uscript-keyword">True</span><span class="uscript-operator">;</span>
         <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>EngineRPM <span class="uscript-operator">&gt;</span> myRPM<span class="uscript-operator">)</span>
         <span class="uscript-operator">{</span>
              <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>myRPM <span class="uscript-operator">&lt;</span> <span class="uscript-number">0</span><span class="uscript-operator">)</span>
                    rpmDifference <span class="uscript-operator">=</span> EngineRPM <span class="uscript-operator">-</span> <span class="uscript-operator">(</span><span class="uscript-number">2</span> <span class="uscript-operator">*</span> Abs<span class="uscript-operator">(</span>myRPM<span class="uscript-operator">)</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

              <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>myRPM <span class="uscript-operator">&gt;=</span> <span class="uscript-number">0</span><span class="uscript-operator">)</span>
                    rpmDifference <span class="uscript-operator">=</span> EngineRPM <span class="uscript-operator">-</span> myRPM<span class="uscript-operator">;</span>
              <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>rpmDifference <span class="uscript-operator">&lt;=</span> <span class="uscript-number">200.0</span><span class="uscript-operator">)</span>
              <span class="uscript-operator">{</span>
                   bInGear <span class="uscript-operator">=</span> <span class="uscript-keyword">True</span><span class="uscript-operator">;</span>
              <span class="uscript-operator">}</span>
              <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>rpmDifference <span class="uscript-operator">&gt;</span> <span class="uscript-number">200.0</span><span class="uscript-operator">)</span>
              <span class="uscript-operator">{</span>
                   bInGear <span class="uscript-operator">=</span> <span class="uscript-keyword">False</span><span class="uscript-operator">;</span>
                   rpmDifference <span class="uscript-operator">=</span> rpmDifference <span class="uscript-operator">*</span> <span class="uscript-number">0.2</span><span class="uscript-operator">;</span>
                   EngineRPM <span class="uscript-operator">-=</span> rpmDifference<span class="uscript-operator">;</span>
                   bRadians <span class="uscript-operator">=</span> <span class="uscript-keyword">True</span><span class="uscript-operator">;</span>
              <span class="uscript-operator">}</span>
         <span class="uscript-operator">}</span>
         <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>EngineRPM <span class="uscript-operator">&lt;</span> myRPM<span class="uscript-operator">)</span>
         <span class="uscript-operator">{</span>
              rpmDifference <span class="uscript-operator">=</span> myRPM <span class="uscript-operator">-</span> EngineRPM<span class="uscript-operator">;</span>
              <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>rpmDifference <span class="uscript-operator">&lt;=</span> <span class="uscript-number">200.0</span><span class="uscript-operator">)</span>
              <span class="uscript-operator">{</span>
                   bInGear <span class="uscript-operator">=</span> <span class="uscript-keyword">True</span><span class="uscript-operator">;</span>
              <span class="uscript-operator">}</span>
              <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>rpmDifference <span class="uscript-operator">&gt;</span> <span class="uscript-number">200.0</span><span class="uscript-operator">)</span>
              <span class="uscript-operator">{</span>
                   bInGear <span class="uscript-operator">=</span> <span class="uscript-keyword">False</span><span class="uscript-operator">;</span>
                   rpmDifference <span class="uscript-operator">=</span> rpmDifference <span class="uscript-operator">*</span> <span class="uscript-number">0.2</span><span class="uscript-operator">;</span>
                   EngineRPM <span class="uscript-operator">-=</span> rpmDifference<span class="uscript-operator">;</span>
                   bRadians <span class="uscript-operator">=</span> <span class="uscript-keyword">True</span><span class="uscript-operator">;</span>
              <span class="uscript-operator">}</span>
         <span class="uscript-operator">}</span>
<span class="uscript-operator">}</span></pre><dl><dt>KApplyForce</dt></dl>
<pre class="uscript"><span class="uscript-keyword">function</span> KApplyForce<span class="uscript-operator">(</span><span class="uscript-keyword">out</span> vector Force<span class="uscript-operator">,</span> <span class="uscript-keyword">out</span> vector Torque<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>KApplyForce<span class="uscript-operator">(</span>Force<span class="uscript-operator">,</span> Torque<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    Force <span class="uscript-operator">+=</span> UDForce<span class="uscript-operator">;</span>
    Torque <span class="uscript-operator">+=</span> UDTorque<span class="uscript-operator">;</span>
    <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>bBoosting <span class="uscript-operator">==</span> <span class="uscript-keyword">true</span> <span class="uscript-operator">&amp;&amp;</span> bVehicleOnGround <span class="uscript-operator">==</span> <span class="uscript-keyword">true</span><span class="uscript-operator">)</span>
        Force <span class="uscript-operator">+=</span> vector<span class="uscript-operator">(</span>Rotation<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> SpeedBoost<span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>KImpact</dt></dl>
<pre class="uscript"><span class="uscript-keyword">event</span> KImpact<span class="uscript-operator">(</span>Actor Other<span class="uscript-operator">,</span> vector Pos<span class="uscript-operator">,</span> vector ImpactVel<span class="uscript-operator">,</span> vector ImpactNorm<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>Role <span class="uscript-operator">==</span> ROLE_Authority<span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>

        ImpactInfo<span class="uscript-operator">.</span>Other <span class="uscript-operator">=</span> Other<span class="uscript-operator">;</span>
        ImpactInfo<span class="uscript-operator">.</span>Pos <span class="uscript-operator">=</span> Pos<span class="uscript-operator">;</span>
        ImpactInfo<span class="uscript-operator">.</span>ImpactVel <span class="uscript-operator">=</span> ImpactVel<span class="uscript-operator">;</span>
        ImpactInfo<span class="uscript-operator">.</span>ImpactNorm <span class="uscript-operator">=</span> ImpactNorm<span class="uscript-operator">;</span>
        ImpactInfo<span class="uscript-operator">.</span>ImpactAccel <span class="uscript-operator">=</span> KParams<span class="uscript-operator">.</span>KAcceleration<span class="uscript-operator">;</span>
        ImpactTicksLeft <span class="uscript-operator">=</span> ImpactDamageTicks<span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>
<span class="uscript-operator">}</span></pre><dl><dt>DrivingStatusChanged</dt></dl>
<pre class="uscript"><span class="uscript-keyword">event</span> DrivingStatusChanged<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">local</span> <span class="uscript-type">int</span> i<span class="uscript-operator">;</span>
    <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>DrivingStatusChanged<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>bDriving <span class="uscript-operator">&amp;&amp;</span> Level<span class="uscript-operator">.</span>NetMode <span class="uscript-operator">!=</span> NM_DedicatedServer <span class="uscript-operator">&amp;&amp;</span> <span class="uscript-operator">!</span>bDropDetail<span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        Dust<span class="uscript-operator">.</span><span class="uscript-keyword">length</span> <span class="uscript-operator">=</span> Wheels<span class="uscript-operator">.</span><span class="uscript-keyword">length</span><span class="uscript-operator">;</span>
        <span class="uscript-keyword">for</span><span class="uscript-operator">(</span>i<span class="uscript-operator">=</span><span class="uscript-number">0</span><span class="uscript-operator">;</span> i<span class="uscript-operator">&lt;</span>Wheels<span class="uscript-operator">.</span><span class="uscript-keyword">Length</span><span class="uscript-operator">;</span> i<span class="uscript-operator">++</span><span class="uscript-operator">)</span>
            <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>Dust<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span> <span class="uscript-operator">==</span> <span class="uscript-keyword">None</span><span class="uscript-operator">)</span>
            <span class="uscript-operator">{</span>
                <span class="uscript-comment">// Create wheel dust emitters.</span>
                WheelCoords <span class="uscript-operator">=</span> GetBoneCoords<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>BoneName<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                Dust<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span> <span class="uscript-operator">=</span> spawn<span class="uscript-operator">(</span><span class="uscript-keyword">class</span><span class="uscript-name">'ONSDirtSlipEffect'</span><span class="uscript-operator">,</span> <span class="uscript-keyword">self</span><span class="uscript-operator">,</span><span class="uscript-operator">,</span> WheelCoords<span class="uscript-operator">.</span>Origin <span class="uscript-operator">+</span> <span class="uscript-operator">(</span><span class="uscript-operator">(</span><span class="uscript-keyword">vect</span><span class="uscript-operator">(</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-operator">-</span><span class="uscript-number">1</span><span class="uscript-operator">)</span> <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>WheelRadius<span class="uscript-operator">)</span> <span class="uscript-operator">&gt;&gt;</span> Rotation<span class="uscript-operator">)</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                Dust<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SetBase<span class="uscript-operator">(</span><span class="uscript-keyword">self</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                Dust<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SetDirtColor<span class="uscript-operator">(</span> Level<span class="uscript-operator">.</span>DustColor <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
            <span class="uscript-operator">}</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bMakeBrakeLights<span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
            <span class="uscript-keyword">for</span><span class="uscript-operator">(</span>i<span class="uscript-operator">=</span><span class="uscript-number">0</span><span class="uscript-operator">;</span> i<span class="uscript-operator">&lt;</span><span class="uscript-number">2</span><span class="uscript-operator">;</span> i<span class="uscript-operator">++</span><span class="uscript-operator">)</span>
                <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>BrakeLight<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span> <span class="uscript-operator">==</span> <span class="uscript-keyword">None</span><span class="uscript-operator">)</span>
                <span class="uscript-operator">{</span>
                    BrakeLight<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span> <span class="uscript-operator">=</span> spawn<span class="uscript-operator">(</span><span class="uscript-keyword">class</span><span class="uscript-name">'ONSBrakelightCorona'</span><span class="uscript-operator">,</span> <span class="uscript-keyword">self</span><span class="uscript-operator">,</span><span class="uscript-operator">,</span> Location <span class="uscript-operator">+</span> <span class="uscript-operator">(</span>BrakeLightOffset<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span> <span class="uscript-operator">&gt;&gt;</span> Rotation<span class="uscript-operator">)</span> <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                    BrakeLight<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SetBase<span class="uscript-operator">(</span><span class="uscript-keyword">self</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                    BrakeLight<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SetRelativeRotation<span class="uscript-operator">(</span> <span class="uscript-keyword">rot</span><span class="uscript-operator">(</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">32768</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">)</span> <span class="uscript-operator">)</span><span class="uscript-operator">;</span> <span class="uscript-comment">// Point lights backwards.</span>
                    BrakeLight<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>Skins<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span> <span class="uscript-operator">=</span> BrakeLightMaterial<span class="uscript-operator">;</span>
                <span class="uscript-operator">}</span>
        <span class="uscript-operator">}</span>
    <span class="uscript-operator">}</span>
    <span class="uscript-keyword">else</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>Level<span class="uscript-operator">.</span>NetMode <span class="uscript-operator">!=</span> NM_DedicatedServer<span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
            <span class="uscript-keyword">for</span><span class="uscript-operator">(</span>i<span class="uscript-operator">=</span><span class="uscript-number">0</span><span class="uscript-operator">;</span> i<span class="uscript-operator">&lt;</span>Dust<span class="uscript-operator">.</span><span class="uscript-keyword">Length</span><span class="uscript-operator">;</span> i<span class="uscript-operator">++</span><span class="uscript-operator">)</span>
                Dust<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>Destroy<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

            Dust<span class="uscript-operator">.</span><span class="uscript-keyword">Length</span> <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>

            <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bMakeBrakeLights<span class="uscript-operator">)</span>
            <span class="uscript-operator">{</span>
                <span class="uscript-keyword">for</span><span class="uscript-operator">(</span>i<span class="uscript-operator">=</span><span class="uscript-number">0</span><span class="uscript-operator">;</span> i<span class="uscript-operator">&lt;</span><span class="uscript-number">2</span><span class="uscript-operator">;</span> i<span class="uscript-operator">++</span><span class="uscript-operator">)</span>
                    <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>BrakeLight<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span> <span class="uscript-operator">!=</span> <span class="uscript-keyword">None</span><span class="uscript-operator">)</span>
                        BrakeLight<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>Destroy<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
            <span class="uscript-operator">}</span>
        <span class="uscript-operator">}</span>
        TurnDamping <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>
<span class="uscript-operator">}</span></pre><dl><dt>KDriverEnter</dt></dl>
<pre class="uscript"><span class="uscript-keyword">function</span> KDriverEnter<span class="uscript-operator">(</span>Pawn P<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
        <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>KDriverEnter<span class="uscript-operator">(</span>P<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>ClientKDriverLeave</dt></dl>
<pre class="uscript"><span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> ClientKDriverLeave<span class="uscript-operator">(</span>PlayerController PC<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>ClientKDriverLeave<span class="uscript-operator">(</span>PC<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    bWeaponIsAltFiring <span class="uscript-operator">=</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
    PC<span class="uscript-operator">.</span>EndZoom<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>SpecialCalcFirstPersonView</dt></dl>
<pre class="uscript"><span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> SpecialCalcFirstPersonView<span class="uscript-operator">(</span>PlayerController PC<span class="uscript-operator">,</span> <span class="uscript-keyword">out</span> actor ViewActor<span class="uscript-operator">,</span> <span class="uscript-keyword">out</span> vector CameraLocation<span class="uscript-operator">,</span> <span class="uscript-keyword">out</span> rotator CameraRotation <span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    ViewActor <span class="uscript-operator">=</span> <span class="uscript-keyword">self</span><span class="uscript-operator">;</span>
    CameraLocation <span class="uscript-operator">=</span> Location <span class="uscript-operator">+</span> <span class="uscript-operator">(</span>FPCamPos <span class="uscript-operator">&gt;&gt;</span> Rotation<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>Fire</dt></dl>
<pre class="uscript"><span class="uscript-keyword">function</span> Fire<span class="uscript-operator">(</span><span class="uscript-keyword">optional</span> <span class="uscript-type">float</span> F<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
       VehicleFire<span class="uscript-operator">(</span><span class="uscript-keyword">False</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>AltFire</dt></dl>
<pre class="uscript"><span class="uscript-keyword">function</span> AltFire<span class="uscript-operator">(</span><span class="uscript-keyword">optional</span> <span class="uscript-type">float</span> F<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>

        VehicleFire<span class="uscript-operator">(</span><span class="uscript-keyword">true</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>VehicleFire</dt></dl>
<pre class="uscript"><span class="uscript-keyword">function</span> VehicleFire<span class="uscript-operator">(</span><span class="uscript-type">bool</span> bWasAltFire<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
         <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bWasAltFire<span class="uscript-operator">)</span>
         <span class="uscript-operator">{</span>
                 bGearUp <span class="uscript-operator">=</span> <span class="uscript-number">1</span><span class="uscript-operator">;</span>
                 ChangeGear<span class="uscript-operator">(</span>bGearUp<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
         <span class="uscript-operator">}</span>

         <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bWasAltFire<span class="uscript-operator">)</span>
         <span class="uscript-operator">{</span>
                 bGearDown <span class="uscript-operator">=</span> <span class="uscript-operator">-</span><span class="uscript-number">1</span><span class="uscript-operator">;</span>
                 ChangeGear<span class="uscript-operator">(</span>bGearDown<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
         <span class="uscript-operator">}</span>
<span class="uscript-operator">}</span></pre><dl><dt>VehicleCeaseFire</dt></dl>
<pre class="uscript"><span class="uscript-keyword">function</span> VehicleCeaseFire<span class="uscript-operator">(</span><span class="uscript-type">bool</span> bWasAltFire<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
         <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bWasAltFire<span class="uscript-operator">)</span>
         <span class="uscript-operator">{</span>
                 bGearUp <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
                 ChangeGear<span class="uscript-operator">(</span>bGearUp<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
         <span class="uscript-operator">}</span>
         <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bWasAltFire<span class="uscript-operator">)</span>
         <span class="uscript-operator">{</span>
                 bGearDown <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
                 ChangeGear<span class="uscript-operator">(</span>bGearDown<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
         <span class="uscript-operator">}</span>
    <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>VehicleCeaseFire<span class="uscript-operator">(</span>bWasAltFire<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>ClientVehicleCeaseFire</dt></dl>
<pre class="uscript"><span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> ClientVehicleCeaseFire<span class="uscript-operator">(</span><span class="uscript-type">bool</span> bWasAltFire<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>ClientVehicleCeaseFire<span class="uscript-operator">(</span>bWasAltFire<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>Tick</dt></dl>
<pre class="uscript"><span class="uscript-keyword">function</span> Tick<span class="uscript-operator">(</span><span class="uscript-type">float</span> DT<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">local</span> <span class="uscript-type">int</span>               i<span class="uscript-operator">,</span> x<span class="uscript-operator">;</span>
    <span class="uscript-keyword">local</span> <span class="uscript-type">bool</span>              lostTraction<span class="uscript-operator">;</span>
    <span class="uscript-keyword">local</span> KarmaParams       KP<span class="uscript-operator">;</span>
    <span class="uscript-keyword">local</span> KRigidBodyState   BodyState<span class="uscript-operator">;</span>

    TheDeltaTime <span class="uscript-operator">=</span> DT<span class="uscript-operator">;</span>
    <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>Tick<span class="uscript-operator">(</span>DT<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    VRate <span class="uscript-operator">=</span> VSize<span class="uscript-operator">(</span>Velocity<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    KP <span class="uscript-operator">=</span> KarmaParams<span class="uscript-operator">(</span>KParams<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    KGetRigidBodyState<span class="uscript-operator">(</span>BodyState<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    SteerBoneAxis <span class="uscript-operator">=</span> AXIS_Z<span class="uscript-operator">;</span>
    KWake<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Role <span class="uscript-operator">==</span> ROLE_Authority<span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bDriving<span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-comment">// Update ForwardVel, CarMPH and bIsInverted on both server and client.</span>
            GetAxes<span class="uscript-operator">(</span>Rotation<span class="uscript-operator">,</span> worldForward<span class="uscript-operator">,</span> worldRight<span class="uscript-operator">,</span> worldUp<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

        ForwardVel <span class="uscript-operator">=</span> Velocity <span class="uscript-operator">dot</span> worldForward<span class="uscript-operator">;</span>
        CarMPH <span class="uscript-operator">=</span> Abs<span class="uscript-operator">(</span><span class="uscript-operator">(</span>ForwardVel <span class="uscript-operator">*</span> <span class="uscript-number">3600.0</span><span class="uscript-operator">)</span> <span class="uscript-operator">/</span> <span class="uscript-number">140800.0</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span> <span class="uscript-comment">// Convert from units per sec to miles per hour.</span>

        bIsInverted <span class="uscript-operator">=</span> worldUp<span class="uscript-operator">.</span>Z <span class="uscript-operator">&lt;</span> <span class="uscript-number">0.2</span><span class="uscript-operator">;</span>

        <span class="uscript-comment">// Update engine sound pitch</span>
        EnginePitch <span class="uscript-operator">=</span> <span class="uscript-number">255.0</span> <span class="uscript-operator">*</span> <span class="uscript-operator">(</span><span class="uscript-operator">(</span>EngineRPM<span class="uscript-operator">+</span>IdleRPM<span class="uscript-operator">)</span><span class="uscript-operator">/</span>EngineRPMSoundRange<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        EnginePitch <span class="uscript-operator">=</span> Clamp<span class="uscript-operator">(</span>EnginePitch<span class="uscript-operator">,</span> <span class="uscript-number">0.0</span><span class="uscript-operator">,</span> <span class="uscript-number">255.0</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        SoundPitch <span class="uscript-operator">=</span> EnginePitch<span class="uscript-operator">;</span>

            SteerBoneAngle <span class="uscript-operator">=</span> <span class="uscript-operator">(</span>ActualSteering<span class="uscript-operator">/</span>InterpCurveEval<span class="uscript-operator">(</span>MaxSteerAngleCurve<span class="uscript-operator">,</span> VRate<span class="uscript-operator">)</span><span class="uscript-operator">)</span> <span class="uscript-operator">*</span> SteerBoneMaxAngle <span class="uscript-operator">*</span> <span class="uscript-operator">(</span><span class="uscript-number">65535.0</span><span class="uscript-operator">/</span><span class="uscript-number">360.0</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

            one<span class="uscript-operator">.</span>X <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
            one<span class="uscript-operator">.</span>Y <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
            one<span class="uscript-operator">.</span>Z <span class="uscript-operator">=</span> SteerBoneAngle<span class="uscript-operator">;</span>

            two<span class="uscript-operator">.</span>X <span class="uscript-operator">=</span> SteerBoneAngle<span class="uscript-operator">;</span>
            two<span class="uscript-operator">.</span>Y <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
            two<span class="uscript-operator">.</span>Z <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>

            three<span class="uscript-operator">.</span>X <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
            three<span class="uscript-operator">.</span>Y <span class="uscript-operator">=</span> SteerBoneAngle<span class="uscript-operator">;</span>
            three<span class="uscript-operator">.</span>Z <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>


            <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>SteerBoneAxis <span class="uscript-operator">==</span> AXIS_X<span class="uscript-operator">)</span>
                 <span class="uscript-comment">//SteerRot = Rotator(0, 0, SteerBoneAngle);</span>
                 SteerRot <span class="uscript-operator">=</span> Rotator<span class="uscript-operator">(</span>one<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

            <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>SteerBoneAxis <span class="uscript-operator">==</span> AXIS_Y<span class="uscript-operator">)</span>
                 <span class="uscript-comment">//SteerRot = Rotator(SteerBoneAngle, 0, 0);</span>
                 SteerRot <span class="uscript-operator">=</span> Rotator<span class="uscript-operator">(</span>two<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

            <span class="uscript-keyword">else</span>
                 <span class="uscript-comment">//SteerRot = Rotator(0, SteerBoneAngle, 0);</span>
                 SteerRot <span class="uscript-operator">=</span> Rotator<span class="uscript-operator">(</span>three<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

            SetBoneDirection<span class="uscript-operator">(</span>SteerBoneName<span class="uscript-operator">,</span> SteerRot<span class="uscript-operator">,</span> WForce<span class="uscript-operator">,</span> <span class="uscript-number">1</span><span class="uscript-operator">,</span> <span class="uscript-number">0</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>
    <span class="uscript-operator">}</span>
        <span class="uscript-comment">// Update any stunt variables.</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bDoStuntInfo<span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        ForwardsInOldPlane <span class="uscript-operator">=</span> Coords<span class="uscript-operator">.</span>XAxis <span class="uscript-operator">-</span> <span class="uscript-operator">(</span>Coords<span class="uscript-operator">.</span>XAxis <span class="uscript-operator">dot</span> OldCoords<span class="uscript-operator">.</span>ZAxis<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> OldCoords<span class="uscript-operator">.</span>ZAxis<span class="uscript-operator">;</span>
        <span class="uscript-comment">//ForwardsInOldPlane = SafeNormal(ForwardsInOldPlane);</span>
        DeltaHeading <span class="uscript-operator">=</span> Acos<span class="uscript-operator">(</span> Clamp<span class="uscript-operator">(</span> ForwardsInOldPlane <span class="uscript-operator">dot</span> OldCoords<span class="uscript-operator">.</span>XAxis<span class="uscript-operator">,</span> <span class="uscript-operator">-</span><span class="uscript-number">1.0</span><span class="uscript-operator">,</span> <span class="uscript-number">1.0</span> <span class="uscript-operator">)</span> <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span> <span class="uscript-operator">(</span>ForwardsInOldPlane <span class="uscript-operator">dot</span> OldCoords<span class="uscript-operator">.</span>YAxis<span class="uscript-operator">)</span> <span class="uscript-operator">&lt;</span> <span class="uscript-number">0.0</span><span class="uscript-operator">)</span>
            DeltaHeading <span class="uscript-operator">*=</span> <span class="uscript-operator">-</span><span class="uscript-number">1.0</span><span class="uscript-operator">;</span>
        DeltaPitch <span class="uscript-operator">=</span> Asin<span class="uscript-operator">(</span> Clamp<span class="uscript-operator">(</span>Coords<span class="uscript-operator">.</span>XAxis <span class="uscript-operator">dot</span> OldCoords<span class="uscript-operator">.</span>ZAxis<span class="uscript-operator">,</span> <span class="uscript-operator">-</span><span class="uscript-number">1</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">,</span> <span class="uscript-number">1.0</span><span class="uscript-operator">)</span> <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        DeltaRoll <span class="uscript-operator">=</span> Asin<span class="uscript-operator">(</span> Clamp<span class="uscript-operator">(</span>Coords<span class="uscript-operator">.</span>YAxis <span class="uscript-operator">dot</span> OldCoords<span class="uscript-operator">.</span>ZAxis<span class="uscript-operator">,</span> <span class="uscript-operator">-</span><span class="uscript-number">1</span><span class="uscript-operator">.</span>0f<span class="uscript-operator">,</span> <span class="uscript-number">1.0</span><span class="uscript-operator">)</span> <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        <span class="uscript-comment">//debugf( TEXT("DR:%f DP:%f"), DeltaRoll, DeltaPitch );</span>

        bCurrentOnGround <span class="uscript-operator">=</span> <span class="uscript-operator">(</span>bVehicleOnGround <span class="uscript-operator">||</span> KP<span class="uscript-operator">.</span>bContactingLevel<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        DaredevilPoints <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>

        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bCurrentOnGround<span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
            <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bOldVehicleOnGround<span class="uscript-operator">)</span>
            <span class="uscript-operator">{</span>
                <span class="uscript-comment">// We just landed - see if we should display Daredevil 'message'</span>
                InAirTime <span class="uscript-operator">=</span> Level<span class="uscript-operator">.</span>TimeSeconds <span class="uscript-operator">-</span> LastOnGroundTime<span class="uscript-operator">;</span>

                                Dist1 <span class="uscript-operator">=</span> Location<span class="uscript-operator">;</span>
                                Dist2 <span class="uscript-operator">=</span> LastOnGroundLocation<span class="uscript-operator">;</span>
                                <span class="uscript-keyword">Vect</span>  <span class="uscript-operator">=</span> Dist1 <span class="uscript-operator">-</span> Dist2<span class="uscript-operator">;</span>
                                Dist3 <span class="uscript-operator">=</span> <span class="uscript-keyword">Vect</span><span class="uscript-operator">.</span>X <span class="uscript-operator">*</span> <span class="uscript-keyword">Vect</span><span class="uscript-operator">.</span>X <span class="uscript-operator">-</span> <span class="uscript-keyword">Vect</span><span class="uscript-operator">.</span>Y <span class="uscript-operator">*</span> <span class="uscript-keyword">Vect</span><span class="uscript-operator">.</span>Y<span class="uscript-operator">;</span>
                                Dist3 <span class="uscript-operator">=</span> Sqrt<span class="uscript-operator">(</span>Dist3<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

                DaredevilPoints <span class="uscript-operator">+=</span> Max<span class="uscript-operator">(</span> Ceil<span class="uscript-operator">(</span> Abs<span class="uscript-operator">(</span>InAirSpin<span class="uscript-operator">)</span><span class="uscript-operator">/</span><span class="uscript-operator">(</span><span class="uscript-number">0.5</span><span class="uscript-operator">*</span>DaredevilThreshInAirSpin<span class="uscript-operator">)</span> <span class="uscript-operator">)</span> <span class="uscript-operator">-</span> <span class="uscript-number">1</span><span class="uscript-operator">,</span> <span class="uscript-number">0</span> <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                DaredevilPoints <span class="uscript-operator">+=</span> Max<span class="uscript-operator">(</span> Ceil<span class="uscript-operator">(</span> Abs<span class="uscript-operator">(</span>InAirPitch<span class="uscript-operator">)</span><span class="uscript-operator">/</span><span class="uscript-operator">(</span><span class="uscript-number">0.5</span><span class="uscript-operator">*</span>DaredevilThreshInAirPitch<span class="uscript-operator">)</span> <span class="uscript-operator">)</span> <span class="uscript-operator">-</span> <span class="uscript-number">1</span><span class="uscript-operator">,</span> <span class="uscript-number">0</span> <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                DaredevilPoints <span class="uscript-operator">+=</span> Max<span class="uscript-operator">(</span> Ceil<span class="uscript-operator">(</span> Abs<span class="uscript-operator">(</span>InAirRoll<span class="uscript-operator">)</span><span class="uscript-operator">/</span><span class="uscript-operator">(</span><span class="uscript-number">0.5</span><span class="uscript-operator">*</span>DaredevilThreshInAirRoll<span class="uscript-operator">)</span> <span class="uscript-operator">)</span> <span class="uscript-operator">-</span> <span class="uscript-number">1</span><span class="uscript-operator">,</span> <span class="uscript-number">0</span> <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                DaredevilPoints <span class="uscript-operator">+=</span> Max<span class="uscript-operator">(</span> Ceil<span class="uscript-operator">(</span> InAirTime<span class="uscript-operator">/</span><span class="uscript-operator">(</span><span class="uscript-number">0.5</span><span class="uscript-operator">*</span>DaredevilThreshInAirTime<span class="uscript-operator">)</span> <span class="uscript-operator">)</span> <span class="uscript-operator">-</span> <span class="uscript-number">1</span><span class="uscript-operator">,</span> <span class="uscript-number">0</span> <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                DaredevilPoints <span class="uscript-operator">+=</span> Max<span class="uscript-operator">(</span> Ceil<span class="uscript-operator">(</span> InAirDistance<span class="uscript-operator">/</span><span class="uscript-operator">(</span><span class="uscript-number">0</span><span class="uscript-operator">.</span>5f<span class="uscript-operator">*</span>DaredevilThreshInAirDistance<span class="uscript-operator">)</span> <span class="uscript-operator">)</span> <span class="uscript-operator">-</span> <span class="uscript-number">1</span><span class="uscript-operator">,</span> <span class="uscript-number">0</span> <span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                DaredevilPoints <span class="uscript-operator">*=</span> <span class="uscript-number">10</span><span class="uscript-operator">;</span>

                <span class="uscript-comment">// A wheel must be touching the ground on landing to get a daredevil</span>
                <span class="uscript-keyword">if</span><span class="uscript-operator">(</span> bVehicleOnGround <span class="uscript-operator">&amp;&amp;</span> DaredevilPoints <span class="uscript-operator">&gt;</span> <span class="uscript-number">0</span> <span class="uscript-operator">)</span>
                <span class="uscript-operator">{</span>
                    OnDaredevil<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                <span class="uscript-operator">}</span>
            <span class="uscript-operator">}</span>


            LastOnGroundLocation <span class="uscript-operator">=</span> Location<span class="uscript-operator">;</span>
            LastOnGroundTime <span class="uscript-operator">=</span> Level<span class="uscript-operator">.</span>TimeSeconds<span class="uscript-operator">;</span>
            InAirSpin <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
            InAirPitch <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
            InAirRoll <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>
        <span class="uscript-keyword">else</span>
        <span class="uscript-operator">{</span>
            InAirSpin <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span><span class="uscript-number">180.0</span><span class="uscript-operator">/</span>PI<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> DeltaHeading<span class="uscript-operator">;</span>
            InAirPitch <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span><span class="uscript-number">180.0</span><span class="uscript-operator">/</span>PI<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> DeltaPitch<span class="uscript-operator">;</span>
            InAirRoll <span class="uscript-operator">+=</span> <span class="uscript-operator">(</span><span class="uscript-number">180.0</span><span class="uscript-operator">/</span>PI<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> DeltaRoll<span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>

        OldRotation <span class="uscript-operator">=</span> Rotation<span class="uscript-operator">;</span>
        bOldVehicleOnGround <span class="uscript-operator">=</span> bCurrentOnGround<span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>

    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bDriving<span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        bOldVehicleOnGround <span class="uscript-operator">=</span> <span class="uscript-keyword">true</span><span class="uscript-operator">;</span> <span class="uscript-comment">// If no-one is in the vehicle, dont consider it for daredevil status.</span>
    <span class="uscript-operator">}</span>

    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bAllowChargingJump<span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-comment">// Check if all wheels are on the ground.</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bAllWheelsOnGround <span class="uscript-operator">==</span> <span class="uscript-keyword">true</span><span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
             <span class="uscript-keyword">for</span><span class="uscript-operator">(</span>x <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span> x<span class="uscript-operator">&lt;</span>Wheels<span class="uscript-operator">.</span><span class="uscript-keyword">Length</span><span class="uscript-operator">;</span> x<span class="uscript-operator">++</span><span class="uscript-operator">)</span>
             <span class="uscript-operator">{</span>
             <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>x<span class="uscript-operator">]</span><span class="uscript-operator">.</span>bWheelOnGround <span class="uscript-operator">!=</span> <span class="uscript-keyword">false</span><span class="uscript-operator">)</span>
                bAllWheelsOnGround <span class="uscript-operator">=</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
             <span class="uscript-operator">}</span>
        <span class="uscript-operator">}</span>
        <span class="uscript-keyword">else</span>
        <span class="uscript-operator">{</span>
             <span class="uscript-comment">// If any wheels are off the ground - we can just reset everything.</span>
             <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bVehicleOnGround<span class="uscript-operator">)</span>
             <span class="uscript-operator">{</span>
                  JumpForce <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                  JumpSpin <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
<span class="uscript-comment">//                          bPushDown = false;</span>
             <span class="uscript-operator">}</span>

        <span class="uscript-operator">}</span>
    <span class="uscript-operator">}</span>
      <span class="uscript-comment">//Engine(Throttle);</span>
     <span class="uscript-comment">// If on the server - we work out OutputGas, OutputBrake etc, and pack them to be sent to the client.</span>
     <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bClutching<span class="uscript-operator">)</span>
           Gas2 <span class="uscript-operator">=</span> InterpCurveEval<span class="uscript-operator">(</span>RPMtoGas<span class="uscript-operator">,</span> EngineRPM<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
     ProcessCarInput<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
     PackState<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>ProcessCarInput</dt></dl>
<pre class="uscript"><span class="uscript-keyword">function</span> ProcessCarInput<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
        <span class="uscript-keyword">local</span> <span class="uscript-type">bool</span>     bReverse<span class="uscript-operator">;</span>

    bReverse <span class="uscript-operator">=</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Driver <span class="uscript-operator">==</span> <span class="uscript-keyword">none</span><span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        OutputBrake <span class="uscript-operator">=</span> <span class="uscript-number">1.0</span><span class="uscript-operator">;</span>
        OutputGas <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>
    <span class="uscript-keyword">else</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Throttle <span class="uscript-operator">&gt;=</span> <span class="uscript-number">0</span><span class="uscript-operator">)</span> <span class="uscript-comment">// pressing forwards</span>
        <span class="uscript-operator">{</span>
                        OutputGas <span class="uscript-operator">=</span> Abs<span class="uscript-operator">(</span>Throttle<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
                        OutputBrake <span class="uscript-operator">=</span> <span class="uscript-number">0.0</span><span class="uscript-operator">;</span>
                        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bClutching<span class="uscript-operator">)</span>
                        <span class="uscript-operator">{</span>
                             <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Throttle <span class="uscript-operator">==</span> <span class="uscript-number">0</span><span class="uscript-operator">)</span>
                             <span class="uscript-operator">{</span>
                                  <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Gas2<span class="uscript-operator">&lt;=</span><span class="uscript-number">21</span> <span class="uscript-operator">&amp;&amp;</span> Gas2<span class="uscript-operator">&gt;=</span><span class="uscript-number">0</span><span class="uscript-operator">)</span>
                                  <span class="uscript-operator">{</span>
                                        Gas2 <span class="uscript-operator">-=</span> <span class="uscript-number">0.5</span><span class="uscript-operator">;</span>
                                  <span class="uscript-operator">}</span>
                                  <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Gas2<span class="uscript-operator">&lt;</span><span class="uscript-number">0</span><span class="uscript-operator">)</span>
                                        Gas2 <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
                             <span class="uscript-operator">}</span>
                             <span class="uscript-keyword">else</span>
                             <span class="uscript-operator">{</span>
                                  <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Gas2<span class="uscript-operator">&lt;=</span><span class="uscript-number">21</span> <span class="uscript-operator">&amp;&amp;</span> Gas2<span class="uscript-operator">&gt;=</span><span class="uscript-number">0</span><span class="uscript-operator">)</span>
                                  <span class="uscript-operator">{</span>
                                         Gas2 <span class="uscript-operator">+=</span> <span class="uscript-number">0.5</span><span class="uscript-operator">;</span>
                                  <span class="uscript-operator">}</span>
                                  <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Gas2<span class="uscript-operator">&gt;</span><span class="uscript-number">21</span><span class="uscript-operator">)</span>
                                         Gas2 <span class="uscript-operator">=</span> <span class="uscript-number">21</span><span class="uscript-operator">;</span>
                             <span class="uscript-operator">}</span>
                             <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Gas2 <span class="uscript-operator">&gt;=</span><span class="uscript-number">21</span><span class="uscript-operator">)</span>
                                  Gas2 <span class="uscript-operator">=</span> <span class="uscript-number">21</span><span class="uscript-operator">;</span>
                         <span class="uscript-operator">}</span>
                         <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bClutching<span class="uscript-operator">)</span>

                 <span class="uscript-operator">}</span>

       StoptheCar<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
       OutputBrake <span class="uscript-operator">=</span> Abs<span class="uscript-operator">(</span>InterpCurveEval<span class="uscript-operator">(</span>BrakeCurve<span class="uscript-operator">,</span> hBrake<span class="uscript-operator">)</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    OutputPitch <span class="uscript-operator">=</span> Rise<span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>
    Engine<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    KWake<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>Clutch</dt></dl>
<pre class="uscript"><span class="uscript-keyword">exec</span> <span class="uscript-keyword">function</span> Clutch<span class="uscript-operator">(</span><span class="uscript-type">bool</span> bEnabled<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
       <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bEnabled<span class="uscript-operator">)</span>
       <span class="uscript-operator">{</span>
           bClutching <span class="uscript-operator">=</span> <span class="uscript-keyword">False</span><span class="uscript-operator">;</span>
           bInGear <span class="uscript-operator">=</span> <span class="uscript-keyword">False</span><span class="uscript-operator">;</span>
       <span class="uscript-operator">}</span>

       <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bEnabled<span class="uscript-operator">)</span>
       <span class="uscript-operator">{</span>
           bClutching <span class="uscript-operator">=</span> <span class="uscript-keyword">True</span><span class="uscript-operator">;</span>

           RPM <span class="uscript-operator">=</span> EngineRPM<span class="uscript-operator">;</span>
       <span class="uscript-operator">}</span>
<span class="uscript-operator">}</span></pre><dl><dt>Brake</dt></dl>
<pre class="uscript"><span class="uscript-keyword">exec</span> <span class="uscript-keyword">function</span> Brake<span class="uscript-operator">(</span><span class="uscript-type">bool</span> bEnabled<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bEnabled<span class="uscript-operator">)</span>
      <span class="uscript-operator">{</span>
           bBraking <span class="uscript-operator">=</span> <span class="uscript-keyword">True</span><span class="uscript-operator">;</span>
           OutputHandbrake <span class="uscript-operator">=</span> <span class="uscript-keyword">true</span><span class="uscript-operator">;</span>
      <span class="uscript-operator">}</span>
      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>bEnabled<span class="uscript-operator">)</span>
      <span class="uscript-operator">{</span>
           bBraking <span class="uscript-operator">=</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
           OutputHandbrake <span class="uscript-operator">=</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
      <span class="uscript-operator">}</span>
<span class="uscript-operator">}</span></pre><dl><dt>ChangeGear</dt></dl>
<pre class="uscript"><span class="uscript-keyword">function</span> ChangeGear<span class="uscript-operator">(</span><span class="uscript-type">int</span> GearChoice<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
      <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bClutching<span class="uscript-operator">)</span><span class="uscript-operator">{</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Gear <span class="uscript-operator">&gt;=</span> <span class="uscript-number">1</span> <span class="uscript-operator">&amp;&amp;</span> Gear <span class="uscript-operator">&lt;=</span> <span class="uscript-number">7</span><span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
             <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>GearChoice <span class="uscript-operator">==</span> <span class="uscript-number">1</span><span class="uscript-operator">)</span>
             <span class="uscript-operator">{</span>
                  Gear<span class="uscript-operator">++</span><span class="uscript-operator">;</span>
                  bGearUp <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
             <span class="uscript-operator">}</span>
             <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>GearChoice <span class="uscript-operator">==</span> <span class="uscript-operator">-</span><span class="uscript-number">1</span><span class="uscript-operator">)</span>
             <span class="uscript-operator">{</span>
                  Gear<span class="uscript-operator">--</span><span class="uscript-operator">;</span>
                  bGearDown <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
             <span class="uscript-operator">}</span>
             <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>GearChoice <span class="uscript-operator">==</span> <span class="uscript-number">0</span><span class="uscript-operator">)</span>
             <span class="uscript-operator">{</span>

             <span class="uscript-operator">}</span>
        <span class="uscript-operator">}</span>
        <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Gear <span class="uscript-operator">==</span> <span class="uscript-number">0</span> <span class="uscript-operator">&amp;&amp;</span> GearChoice <span class="uscript-operator">==</span> <span class="uscript-number">1</span><span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
              Gear<span class="uscript-operator">++</span><span class="uscript-operator">;</span>
              bGearUp <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>
        <span class="uscript-keyword">else</span> <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Gear <span class="uscript-operator">==</span> <span class="uscript-number">8</span> <span class="uscript-operator">&amp;&amp;</span> GearChoice <span class="uscript-operator">==</span> <span class="uscript-operator">-</span><span class="uscript-number">1</span><span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
              Gear<span class="uscript-operator">--</span><span class="uscript-operator">;</span>
              bGearDown <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>
        <span class="uscript-keyword">else</span>
        <span class="uscript-operator">{</span>
             bGearUp <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
             bGearDown <span class="uscript-operator">=</span> <span class="uscript-number">0</span><span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>
      <span class="uscript-operator">}</span>
<span class="uscript-operator">}</span></pre><dl><dt>PackState</dt></dl>
<pre class="uscript"><span class="uscript-keyword">function</span> PackState<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">local</span> KRigidBodyState   RBState<span class="uscript-operator">;</span>
    <span class="uscript-keyword">local</span> rotator           ViewRot<span class="uscript-operator">;</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span><span class="uscript-operator">!</span>KIsAwake<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">)</span>
        <span class="uscript-keyword">return</span><span class="uscript-operator">;</span>
    KGetRigidBodyState<span class="uscript-operator">(</span>RBState<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        CActiveWeapon<span class="uscript-operator">=</span>SActiveWeapon<span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ChassisPosition<span class="uscript-operator">.</span>X <span class="uscript-operator">=</span> RBState<span class="uscript-operator">.</span>Position<span class="uscript-operator">.</span>X<span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ChassisPosition<span class="uscript-operator">.</span>Y <span class="uscript-operator">=</span> RBState<span class="uscript-operator">.</span>Position<span class="uscript-operator">.</span>Y<span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ChassisPosition<span class="uscript-operator">.</span>Z <span class="uscript-operator">=</span> RBState<span class="uscript-operator">.</span>Position<span class="uscript-operator">.</span>Z<span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ChassisQuaternion <span class="uscript-operator">=</span> RBState<span class="uscript-operator">.</span>Quaternion<span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ChassisLinVel<span class="uscript-operator">.</span>X <span class="uscript-operator">=</span> <span class="uscript-number">10.0</span> <span class="uscript-operator">*</span> RBState<span class="uscript-operator">.</span>LinVel<span class="uscript-operator">.</span>X<span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ChassisLinVel<span class="uscript-operator">.</span>Y <span class="uscript-operator">=</span> <span class="uscript-number">10.0</span> <span class="uscript-operator">*</span> RBState<span class="uscript-operator">.</span>LinVel<span class="uscript-operator">.</span>Y<span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ChassisLinVel<span class="uscript-operator">.</span>Z <span class="uscript-operator">=</span> <span class="uscript-number">10.0</span> <span class="uscript-operator">*</span> RBState<span class="uscript-operator">.</span>LinVel<span class="uscript-operator">.</span>Z<span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ChassisAngVel<span class="uscript-operator">.</span>X <span class="uscript-operator">=</span> <span class="uscript-number">1000.0</span> <span class="uscript-operator">*</span> RBState<span class="uscript-operator">.</span>AngVel<span class="uscript-operator">.</span>X<span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ChassisAngVel<span class="uscript-operator">.</span>Y <span class="uscript-operator">=</span> <span class="uscript-number">1000.0</span> <span class="uscript-operator">*</span> RBState<span class="uscript-operator">.</span>AngVel<span class="uscript-operator">.</span>Y<span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ChassisAngVel<span class="uscript-operator">.</span>Z <span class="uscript-operator">=</span> <span class="uscript-number">1000.0</span> <span class="uscript-operator">*</span> RBState<span class="uscript-operator">.</span>AngVel<span class="uscript-operator">.</span>Z<span class="uscript-operator">;</span>
        CarState<span class="uscript-operator">.</span>ServerHandbrake <span class="uscript-operator">=</span> FloatToRangeByte<span class="uscript-operator">(</span>OutputPitch<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ServerBrake <span class="uscript-operator">=</span> FloatToRangeByte<span class="uscript-operator">(</span>OutputBrake<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ServerGas <span class="uscript-operator">=</span> FloatToRangeByte<span class="uscript-operator">(</span>OutputGas<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ServerGear <span class="uscript-operator">=</span> Gear<span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ServerSteering <span class="uscript-operator">=</span> FloatToRangeByte<span class="uscript-operator">(</span>Steering<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>Controller <span class="uscript-operator">!=</span> <span class="uscript-keyword">None</span><span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        <span class="uscript-keyword">if</span><span class="uscript-operator">(</span>IsHumanControlled<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">)</span>
        <span class="uscript-operator">{</span>
            DriverViewPitch <span class="uscript-operator">=</span> Controller<span class="uscript-operator">.</span>Rotation<span class="uscript-operator">.</span>Pitch<span class="uscript-operator">;</span>
            DriverViewYaw <span class="uscript-operator">=</span> Controller<span class="uscript-operator">.</span>Rotation<span class="uscript-operator">.</span>Yaw<span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>
        <span class="uscript-keyword">else</span>
        <span class="uscript-operator">{</span>
            ViewRot <span class="uscript-operator">=</span> rotator<span class="uscript-operator">(</span>Controller<span class="uscript-operator">.</span>FocalPoint <span class="uscript-operator">-</span> Location<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
            DriverViewPitch <span class="uscript-operator">=</span> ViewRot<span class="uscript-operator">.</span>Pitch<span class="uscript-operator">;</span>
            DriverViewYaw <span class="uscript-operator">=</span> ViewRot<span class="uscript-operator">.</span>Yaw<span class="uscript-operator">;</span>
        <span class="uscript-operator">}</span>
    <span class="uscript-operator">}</span>
    <span class="uscript-keyword">else</span>
    <span class="uscript-operator">{</span>
        DriverViewPitch <span class="uscript-operator">=</span> Rotation<span class="uscript-operator">.</span>Pitch<span class="uscript-operator">;</span>
        DriverViewYaw <span class="uscript-operator">=</span> Rotation<span class="uscript-operator">.</span>Yaw<span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>
    CarState<span class="uscript-operator">.</span>ServerViewPitch <span class="uscript-operator">=</span> DriverViewPitch<span class="uscript-operator">;</span>
    CarState<span class="uscript-operator">.</span>ServerViewYaw <span class="uscript-operator">=</span> DriverViewYaw<span class="uscript-operator">;</span>
    FudgeByte<span class="uscript-operator">++</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>Motion Blur (still in the works)</dt></dl>
<pre class="uscript"><span class="uscript-keyword">function</span> addblur<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
      <span class="uscript-keyword">local</span> PlayerController PC<span class="uscript-operator">;</span>
      
      PC <span class="uscript-operator">=</span> PlayerController<span class="uscript-operator">(</span>Controller<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
      
      PC<span class="uscript-operator">.</span>AddCameraEffect<span class="uscript-operator">(</span><span class="uscript-keyword">new</span> myBlur<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>LimitPitch</dt></dl>
<pre class="uscript"><span class="uscript-keyword">function</span> <span class="uscript-type">int</span> LimitPitch<span class="uscript-operator">(</span><span class="uscript-type">int</span> pitch<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>bAllowAirControl <span class="uscript-operator">&amp;&amp;</span> <span class="uscript-operator">!</span>bVehicleOnGround<span class="uscript-operator">)</span>
        <span class="uscript-keyword">return</span> pitch<span class="uscript-operator">;</span>
    <span class="uscript-keyword">return</span> <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>LimitPitch<span class="uscript-operator">(</span>pitch<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>Destroyed</dt></dl>
<pre class="uscript"><span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> Destroyed<span class="uscript-operator">(</span><span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>LeftTrail <span class="uscript-operator">!=</span> <span class="uscript-keyword">None</span><span class="uscript-operator">)</span>
        LeftTrail<span class="uscript-operator">.</span>Destroy<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>RightTrail <span class="uscript-operator">!=</span> <span class="uscript-keyword">None</span><span class="uscript-operator">)</span>
        RightTrail<span class="uscript-operator">.</span>Destroy<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>Destroyed<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>TakeImpactDamage</dt></dl>
<pre class="uscript"><span class="uscript-keyword">event</span> TakeImpactDamage<span class="uscript-operator">(</span><span class="uscript-type">float</span> AccelMag<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">local</span> <span class="uscript-type">int</span> Damage<span class="uscript-operator">;</span>
        Damage <span class="uscript-operator">=</span> <span class="uscript-type">int</span><span class="uscript-operator">(</span>VSize<span class="uscript-operator">(</span>ImpactInfo<span class="uscript-operator">.</span>Other<span class="uscript-operator">.</span>Velocity<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> <span class="uscript-number">20</span> <span class="uscript-operator">*</span> ImpactDamageModifier<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>Vehicle<span class="uscript-operator">(</span>ImpactInfo<span class="uscript-operator">.</span>Other<span class="uscript-operator">)</span> <span class="uscript-operator">!=</span> <span class="uscript-keyword">None</span><span class="uscript-operator">)</span>
        TakeDamage<span class="uscript-operator">(</span>Damage<span class="uscript-operator">,</span> Vehicle<span class="uscript-operator">(</span>ImpactInfo<span class="uscript-operator">.</span>Other<span class="uscript-operator">)</span><span class="uscript-operator">,</span> ImpactInfo<span class="uscript-operator">.</span>Pos<span class="uscript-operator">,</span> <span class="uscript-keyword">vect</span><span class="uscript-operator">(</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">)</span><span class="uscript-operator">,</span> <span class="uscript-keyword">class</span><span class="uscript-name">'DamType'</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    <span class="uscript-keyword">else</span>
        TakeDamage<span class="uscript-operator">(</span><span class="uscript-type">int</span><span class="uscript-operator">(</span>AccelMag <span class="uscript-operator">*</span> ImpactDamageModifier<span class="uscript-operator">(</span><span class="uscript-operator">)</span><span class="uscript-operator">)</span><span class="uscript-operator">/</span> WallCollisionResistance <span class="uscript-operator">,</span> <span class="uscript-keyword">Self</span><span class="uscript-operator">,</span> ImpactInfo<span class="uscript-operator">.</span>Pos<span class="uscript-operator">,</span> <span class="uscript-keyword">vect</span><span class="uscript-operator">(</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">,</span><span class="uscript-number">0</span><span class="uscript-operator">)</span><span class="uscript-operator">,</span> <span class="uscript-keyword">class</span><span class="uscript-name">'DamType'</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    <span class="uscript-comment">//FIXME - scale sound volume to damage amount</span>
    <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>ImpactDamageSounds<span class="uscript-operator">.</span><span class="uscript-keyword">Length</span> <span class="uscript-operator">&gt;</span> <span class="uscript-number">0</span><span class="uscript-operator">)</span>        PlaySound<span class="uscript-operator">(</span>ImpactDamageSounds<span class="uscript-operator">[</span>Rand<span class="uscript-operator">(</span>ImpactDamageSounds<span class="uscript-operator">.</span><span class="uscript-keyword">Length</span><span class="uscript-number">-1</span><span class="uscript-operator">)</span><span class="uscript-operator">]</span><span class="uscript-operator">,</span><span class="uscript-operator">,</span>TransientSoundVolume<span class="uscript-operator">*</span><span class="uscript-number">2.5</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>Health <span class="uscript-operator">&lt;</span> <span class="uscript-number">0</span> <span class="uscript-operator">&amp;&amp;</span> <span class="uscript-operator">(</span>Level<span class="uscript-operator">.</span>TimeSeconds <span class="uscript-operator">-</span> LastImpactExplosionTime<span class="uscript-operator">)</span> <span class="uscript-operator">&gt;</span> TimeBetweenImpactExplosions<span class="uscript-operator">)</span>
    <span class="uscript-operator">{</span>
        VehicleExplosion<span class="uscript-operator">(</span>Normal<span class="uscript-operator">(</span>ImpactInfo<span class="uscript-operator">.</span>ImpactNorm<span class="uscript-operator">)</span><span class="uscript-operator">,</span> <span class="uscript-number">0.5</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
        LastImpactExplosionTime <span class="uscript-operator">=</span> Level<span class="uscript-operator">.</span>TimeSeconds<span class="uscript-operator">;</span>
    <span class="uscript-operator">}</span>
<span class="uscript-operator">}</span></pre><dl><dt>Died</dt></dl>
<pre class="uscript"><span class="uscript-keyword">function</span> Died<span class="uscript-operator">(</span>Controller Killer<span class="uscript-operator">,</span> <span class="uscript-keyword">class</span><span class="uscript-operator">&lt;</span>DamageType<span class="uscript-operator">&gt;</span> damageType<span class="uscript-operator">,</span> vector HitLocation<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>damageType <span class="uscript-operator">==</span> <span class="uscript-keyword">none</span><span class="uscript-operator">)</span>
       <span class="uscript-keyword">return</span><span class="uscript-operator">;</span>
    <span class="uscript-keyword">if</span> <span class="uscript-operator">(</span>Killer <span class="uscript-operator">!=</span> <span class="uscript-keyword">None</span><span class="uscript-operator">)</span>        PlayerController<span class="uscript-operator">(</span>Killer<span class="uscript-operator">)</span><span class="uscript-operator">.</span>ReceiveLocalizedMessage<span class="uscript-operator">(</span><span class="uscript-keyword">class</span><span class="uscript-name">'VehicleKillMessage'</span><span class="uscript-operator">,</span> <span class="uscript-number">7</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    <span class="uscript-keyword">Super</span><span class="uscript-operator">.</span>Died<span class="uscript-operator">(</span>Killer<span class="uscript-operator">,</span> damageType<span class="uscript-operator">,</span> HitLocation<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>FloatToRangeByte</dt></dl>
<pre class="uscript"><span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> <span class="uscript-type">byte</span> FloatToRangeByte<span class="uscript-operator">(</span><span class="uscript-type">float</span> f<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    f<span class="uscript-operator">=</span> FClamp<span class="uscript-operator">(</span>f<span class="uscript-operator">,</span> <span class="uscript-number">0</span><span class="uscript-operator">,</span> <span class="uscript-number">1</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    f <span class="uscript-operator">=</span> Round<span class="uscript-operator">(</span>f <span class="uscript-operator">*</span> <span class="uscript-number">255</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    <span class="uscript-keyword">return</span> <span class="uscript-type">byte</span><span class="uscript-operator">(</span>f<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><dl><dt>RangeByteToFloat</dt></dl>
<pre class="uscript"><span class="uscript-comment">//The opposite of the above function.</span>
<span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> <span class="uscript-type">float</span> RangeByteToFloat<span class="uscript-operator">(</span><span class="uscript-type">byte</span> b<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">local</span> <span class="uscript-type">float</span> f<span class="uscript-operator">;</span>
    f <span class="uscript-operator">=</span> b<span class="uscript-operator">;</span>
    f <span class="uscript-operator">/=</span> <span class="uscript-number">255</span><span class="uscript-operator">;</span>
    <span class="uscript-keyword">return</span> f<span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><h4><a name="0.2.4.1"></a>Defaults</h4>
<pre class="uscript"><span class="uscript-keyword">defaultproperties</span>
<span class="uscript-operator">{</span>
     myBlur<span class="uscript-operator">=</span><span class="uscript-keyword">Class</span><span class="uscript-name">'WhatEverPackage.myMotionBlur'</span>

     NumForwardGears<span class="uscript-operator">=</span><span class="uscript-number">7</span>

     DustSlipRate<span class="uscript-operator">=</span><span class="uscript-number">2.800000</span>
     DustSlipThresh<span class="uscript-operator">=</span><span class="uscript-number">50.000000</span>
     DaredevilThreshInAirSpin<span class="uscript-operator">=</span><span class="uscript-number">100.000000</span>
     DaredevilThreshInAirPitch<span class="uscript-operator">=</span><span class="uscript-number">300.000000</span>
     DaredevilThreshInAirRoll<span class="uscript-operator">=</span><span class="uscript-number">300.000000</span>
     DaredevilThreshInAirTime<span class="uscript-operator">=</span><span class="uscript-number">1.500000</span>
     DaredevilThreshInAirDistance<span class="uscript-operator">=</span><span class="uscript-number">17.000000</span>
     DaredevilMessageClass<span class="uscript-operator">=</span><span class="uscript-keyword">Class</span><span class="uscript-name">'Onslaught.ONSDaredevilMessage'</span>
     bOldVehicleOnGround<span class="uscript-operator">=</span><span class="uscript-keyword">True</span>
     MaxJumpSpin<span class="uscript-operator">=</span><span class="uscript-number">30000.000000</span>
     JumpChargeTime<span class="uscript-operator">=</span><span class="uscript-number">1.000000</span>
     JumpFeedbackForce<span class="uscript-operator">=</span><span class="uscript-string">"HoverBikeJump"</span>
     JumpSound<span class="uscript-operator">=</span>Sound<span class="uscript-name">'ONSVehicleSounds-S.Hydraulics.Hydraulic10'</span>
     JumpMeterOriginX<span class="uscript-operator">=</span><span class="uscript-number">0.275000</span>
     JumpMeterOriginY<span class="uscript-operator">=</span><span class="uscript-number">0.943000</span>
     JumpMeterWidth<span class="uscript-operator">=</span><span class="uscript-number">0.136000</span>
     JumpMeterHeight<span class="uscript-operator">=</span><span class="uscript-number">0.057000</span>
     JumpMeterSpacing<span class="uscript-operator">=</span><span class="uscript-number">0.010000</span>
     JumpMeterColor<span class="uscript-operator">=</span><span class="uscript-operator">(</span>R<span class="uscript-operator">=</span><span class="uscript-number">215</span><span class="uscript-operator">,</span>A<span class="uscript-operator">=</span><span class="uscript-number">255</span><span class="uscript-operator">)</span>
     SpinMeterColor<span class="uscript-operator">=</span><span class="uscript-operator">(</span>B<span class="uscript-operator">=</span><span class="uscript-number">215</span><span class="uscript-operator">,</span>G<span class="uscript-operator">=</span><span class="uscript-number">100</span><span class="uscript-operator">,</span>A<span class="uscript-operator">=</span><span class="uscript-number">255</span><span class="uscript-operator">)</span>
     JumpMeterTexture<span class="uscript-operator">=</span>Texture<span class="uscript-name">'Engine.WhiteTexture'</span>
     MinAirControlDamping<span class="uscript-operator">=</span><span class="uscript-number">0.100000</span>
     bBrakeFrontWheelsOnly<span class="uscript-operator">=</span><span class="uscript-keyword">False</span>
     ChangeUpPoint<span class="uscript-operator">=</span><span class="uscript-number">2800</span>
     StopThreshold<span class="uscript-operator">=</span><span class="uscript-number">0.2</span>
     CrosshairHitFeedbackTex<span class="uscript-operator">=</span>Texture<span class="uscript-name">'ONSInterface-TX.tankBarrelAligned'</span>
     DefaultCrosshair<span class="uscript-operator">=</span>Material<span class="uscript-name">'InterfaceContent.Hud.fbBombFocus'</span>
     CrosshairScale<span class="uscript-operator">=</span><span class="uscript-number">0.125</span>
     bTeamLocked<span class="uscript-operator">=</span><span class="uscript-keyword">false</span>
     bGearUp<span class="uscript-operator">=</span><span class="uscript-keyword">True</span>
     bInGear<span class="uscript-operator">=</span><span class="uscript-keyword">True</span>
     bEjectPassengersWhenFlipped<span class="uscript-operator">=</span><span class="uscript-keyword">False</span>
     bCanFlip<span class="uscript-operator">=</span><span class="uscript-keyword">true</span>
     DisintegrationHealth<span class="uscript-operator">=</span><span class="uscript-number">0.0</span>
     bShowChargingBar <span class="uscript-operator">=</span> <span class="uscript-keyword">false</span><span class="uscript-operator">;</span>
     <span class="uscript-comment">// Damages</span>
     WallCollisionResistance <span class="uscript-operator">=</span> <span class="uscript-number">5</span> <span class="uscript-comment">// Collision resistance: the bigger it is, the less damage taken</span>
     ExplosionDamage<span class="uscript-operator">=</span><span class="uscript-number">0.0</span>
     DriverDamageMult<span class="uscript-operator">=</span><span class="uscript-number">0</span>
     CenterSpringRangePitch<span class="uscript-operator">=</span><span class="uscript-number">5000</span>
     CenterSpringRangeRoll<span class="uscript-operator">=</span><span class="uscript-number">5000</span>
     StolenAnnouncement<span class="uscript-operator">=</span><span class="uscript-string">"Play"</span>

     bNetNotify<span class="uscript-operator">=</span><span class="uscript-keyword">true</span>
<span class="uscript-operator">}</span></pre><ul><li>Global variables that would need to be added to the above uscript:</li>
</ul>
<pre class="uscript"><span class="uscript-keyword">enum</span> ETextAnchor
<span class="uscript-operator">{</span>
    TA_Left<span class="uscript-operator">,</span>
    TA_Right<span class="uscript-operator">,</span>
    TA_Middle
<span class="uscript-operator">}</span><span class="uscript-operator">;</span>
<span class="uscript-keyword">var</span>   <span class="uscript-type">float</span>                         ScaleX<span class="uscript-operator">,</span> ScaleY<span class="uscript-operator">;</span></pre><p><em class="em2">CIpen:</em>  Here is some simple code you can add to print data on the screen to avoid logging 24/7.  This is what I used to check numbers such as RPM, Gas, EngineRPM, and whatever else I could fit on 1024x768 resolution.  I've found it to be most handy.  I'm sure you can find this elsewhere but I'm saving you the effort of looking.</p>
<ul><li>And here is the DrawHUD function that we must have to draw on the screen when a player has possesion of the vehicle:</li>
</ul>
<pre class="uscript"><span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> DrawHUD<span class="uscript-operator">(</span>Canvas C<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    <span class="uscript-keyword">local</span> PlayerController PC<span class="uscript-operator">;</span>


    PC <span class="uscript-operator">=</span> PlayerController<span class="uscript-operator">(</span>Controller<span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    ScaleX <span class="uscript-operator">=</span> C<span class="uscript-operator">.</span>ClipX<span class="uscript-operator">/</span><span class="uscript-number">1024</span><span class="uscript-operator">;</span>
    ScaleY <span class="uscript-operator">=</span> C<span class="uscript-operator">.</span>ClipY<span class="uscript-operator">/</span><span class="uscript-number">768</span><span class="uscript-operator">;</span>

    C<span class="uscript-operator">.</span>Style <span class="uscript-operator">=</span> ERenderStyle<span class="uscript-operator">.</span>STY_Additive<span class="uscript-operator">;</span>
    C<span class="uscript-operator">.</span>Font <span class="uscript-operator">=</span> PC<span class="uscript-operator">.</span>MyHUD<span class="uscript-operator">.</span>GetFontSizeIndex<span class="uscript-operator">(</span>C<span class="uscript-operator">,</span> <span class="uscript-operator">-</span><span class="uscript-number">2</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    C<span class="uscript-operator">.</span>DrawColor <span class="uscript-operator">=</span> C<span class="uscript-operator">.</span>MakeColor<span class="uscript-operator">(</span><span class="uscript-number">255</span><span class="uscript-operator">,</span><span class="uscript-number">255</span><span class="uscript-operator">,</span><span class="uscript-number">255</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    DrawEngineStuff<span class="uscript-operator">(</span>C<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><ul><li>Here is the DrawEngineStuff(C) which is isn't a required function but is there to organize:</li>
</ul>
<pre class="uscript"><span class="uscript-keyword">simulated</span> <span class="uscript-keyword">function</span> DrawEngineStuff<span class="uscript-operator">(</span>Canvas C<span class="uscript-operator">)</span>
<span class="uscript-operator">{</span>
    C<span class="uscript-operator">.</span>Font <span class="uscript-operator">=</span> C<span class="uscript-operator">.</span>TinyFont<span class="uscript-operator">;</span>

    C<span class="uscript-operator">.</span>SetPos<span class="uscript-operator">(</span><span class="uscript-number">40</span><span class="uscript-operator">*</span>ScaleX<span class="uscript-operator">,</span> <span class="uscript-number">150</span><span class="uscript-operator">*</span>ScaleY<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    C<span class="uscript-operator">.</span>DrawText<span class="uscript-operator">(</span><span class="uscript-string">"Engine stuff"</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>

    C<span class="uscript-operator">.</span>SetPos<span class="uscript-operator">(</span><span class="uscript-number">40</span><span class="uscript-operator">*</span>ScaleX<span class="uscript-operator">,</span> <span class="uscript-number">160</span><span class="uscript-operator">*</span>ScaleY<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
    C<span class="uscript-operator">.</span>DrawText<span class="uscript-operator">(</span><span class="uscript-string">"Engine RPM: "</span> <span class="uscript-operator">@</span> EngineRPM<span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-operator">}</span></pre><p>40*ScaleX sets the vertical starting position, and 150*ScaleY sets the horizontal starting position.</p>
<h4><a name="0.2.4.2"></a>Notes</h4>
<p>If you are to subclass, you need to know that the engine rpm is in radians per min.  This means that if you were to create a torque curve and wanted the rpm range to be from 500 to 7000, you would need to convert all the points from revolutions per min to radians per sec.  Take the rpm(real life engine rpm) of 7000, divide by 60, then multiply by 2 PI.  Like so:</p>
<p>(7000/60)*6.2831853</p>
<p>this yields 733.038285 as the correct rpm</p>
<p>bNetNotify=true is prolly the most critical thing needed for this class to work online/lan</p>
<p>I've got a lot of changes that need to be made to this class, so be patient.  Additions include, properly calculating wheel torque if the wheel is powered or not, better collisions with walls(currently if you hit a wall flat at 300 mph the vehicle just stops and takes no damage), available auto transmision, ...</p>
<h2><a name="0.3"></a>Related Topics</h2>
<ul><li><a href="vehicles.html">Vehicles</a> &ndash; Main topics for Vehicles.</li>
<li><a href="vehicle.html">Vehicle</a> &ndash; Parent class for all vehicles and turrets.<ul><li><a href="svehicle.html">SVehicle</a><ul><li><a href="onsvehicle.html">ONSVehicle</a><ul><li><a href="onswheeledcraft.html">ONSWheeledCraft</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="making-mods.html">Making Mods</a></li>
</ul>
<h2><a name="0.4"></a>Discussion</h2>
<p><em class="em2">Graphik:</em> Very nice idea, but a bit unsuited for an FPS, more for a racing game like UnWheel. It seems to me that Epic made sure that the vehicles were as "dumbed down" as possible to keep the focus on fragging people with a vehicle rather than the minutia of driving one. I recommend sending this in to <a href="http://unwheel.beyondunreal.com/">[UnWheel]</a> when you're done. If they don't actually use it I'm sure they'd at the very least find it interesting.</p>
<p><em class="em2">CIpen:</em> Accually I got a thumbs up on that at the same time I created this page.  The bounds of this script is almost limitless, as it would be easy to have say the tire blow out when shot.  As soon as I get a free day I'll update this page with all the new additions (infact that might be something good to do tonight).  The big change is that I added the option for auto or stick control and the the power is ditributed over the wheels that are powered.</p>
<p><em class="em2">Foxpaw:</em> Why do you divide by 60 when converting rotations per minute to radians per minute? The radians per minute should be greater than the roatations per minute, as there's more than one radian per rotation. Or is that supposed to say, radians per second?</p>
<p><em class="em2">CIpen:</em> Yes, you pointed out a typo <img alt=":D" src="emoticons/biggrin.gif" align="middle">.  Yes, it should say radians per second.  Yet your own message has typos, it's not rotations per minute, but revolutions per minute. <img alt=":)" src="emoticons/smile.gif" align="middle"></p>
<p><em class="em2">Foxpaw:</em> Err, ehm, well, I guess that depends on where you measure it from. I'd measure it from the flywheel which definately rotates. I suppose some parts of the crankshaft do revolve though, so either could be correct.</p>
<hr class="thin"><p><em class="em2">Zxanphorian:</em> WOW, that is a lot of scriptage there! I have an idea, to make it randomly stall :B</p>
<hr class="thin"><p><em class="em2">CIpen:</em>  Ya, there are a lot of cool possibilities with this class.  You could attach a model to the wheel bone, add another bone for disk brakes (to attach a disk brake mesh to that turns when the wheels turn), make the engine blow up if you downgear and the engine rpm goes to high, have an axle break, have more wheel slip functions for different traction of different surfaces...     any number of things....</p>
<p><em class="em2">OlympusMons:</em> I would have to agree CIpen. Has anyone given any thought to making a proper automatic car you know the manual automatic ones. :S Like what mafia did. I havent really had time to look through all this code although I'd like to, I was just wondering if all of this is actually needed to make a manual shift car or if there are other features which have been added through all of this script. Actually another cool thing to do would be to make a proper 4wd manual shift. Hmm!</p>
<p><em class="em2">CIpen:</em>  Good! Lets get to the meat!  The first thing you need to know is that the function UpdateVehicle() is somehow tied to native code.  To see this all you need to do is log the DeltaTime from inside the Tick() function and from inside UpdateVehicle() function.  You should see that UpdateVehicle() always has the same DeltaTime so matter what your FPS is (at least this is what I remember it being when I tested it).</p>
<p>The next serious thing is that, unless you do your own wheel calculations, you'll have to build around the SVehicleWheel variables that are calculated each frame.  It's both good and bad I guess.  Take a minute to thing about this:  below is the line that calculates the GripTorque.</p>
<pre class="uscript">GripTorque <span class="uscript-operator">=</span> FTScale <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>WheelRadius <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>TireLoad <span class="uscript-operator">*</span> WheelLongFrictionScale<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span> <span class="uscript-operator">*</span> InterpCurveEval<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LongFrictionFunc<span class="uscript-operator">,</span> Abs<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SlipVel<span class="uscript-operator">)</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span></pre><p>Now, lets say we want to be the biggest uscript hot shot around, you might change this line to look like this:</p>
<pre class="uscript"><span class="uscript-keyword">if</span><span class="uscript-operator">(</span>bPlayerIsOnHood<span class="uscript-operator">)</span>
     GripTorque <span class="uscript-operator">=</span> FTScale <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>WheelRadius <span class="uscript-operator">*</span> <span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>TireLoad <span class="uscript-operator">+</span> PlayerMass<span class="uscript-operator">)</span> <span class="uscript-operator">*</span> WheelLongFrictionScale<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span> <span class="uscript-operator">*</span> InterpCurveEval<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LongFrictionFunc<span class="uscript-operator">,</span> Abs<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SlipVel<span class="uscript-operator">)</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span>
<span class="uscript-keyword">else</span>
     GripTorque <span class="uscript-operator">=</span> FTScale <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>WheelRadius <span class="uscript-operator">*</span> Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>TireLoad <span class="uscript-operator">*</span> WheelLongFrictionScale<span class="uscript-operator">[</span><span class="uscript-number">0</span><span class="uscript-operator">]</span> <span class="uscript-operator">*</span> InterpCurveEval<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>LongFrictionFunc<span class="uscript-operator">,</span> Abs<span class="uscript-operator">(</span>Wheels<span class="uscript-operator">[</span>i<span class="uscript-operator">]</span><span class="uscript-operator">.</span>SlipVel<span class="uscript-operator">)</span><span class="uscript-operator">)</span><span class="uscript-operator">;</span></pre><p>Thus simulating player weight on the car(more or less).  That is after you do some stuff to get if the player is on the vehicle or not.</p>
<p>btw I just updated it UpdateVehicle() because it was far behind.</p>
<p><em class="em2">Tarquin:</em> I moved this back to its original name, as the class name didn't seem very descriptive.</p>
<p><em class="em2">WinterHummer:</em> Can someong give me a good scorpion subclass of this for me and other lazy people?</p>
<hr class="thin"><p><a href="category-tutorial.html">Category Tutorial</a></p>
<script type="text/javascript"><!--
 menuItemAdd("Breakdown ", "#0.1");
menuItemAdd("The Goods ", "#0.2");
menuItemAdd("<tt>&nbsp;&nbsp;</tt>To start the class off ", "#0.2.1");
menuItemAdd("<tt>&nbsp;&nbsp;</tt>Critical variables ", "#0.2.2");
menuItemAdd("<tt>&nbsp;&nbsp;</tt>Not so critical variables ", "#0.2.3");
menuItemAdd("<tt>&nbsp;&nbsp;&nbsp;&nbsp;</tt>Replication", "#0.2.3.1");
menuItemAdd("<tt>&nbsp;&nbsp;</tt>Functions ", "#0.2.4");
menuItemAdd("<tt>&nbsp;&nbsp;&nbsp;&nbsp;</tt>Defaults", "#0.2.4.1");
menuItemAdd("<tt>&nbsp;&nbsp;&nbsp;&nbsp;</tt>Notes", "#0.2.4.2");
menuItemAdd("Related Topics", "#0.3");
menuItemAdd("Discussion", "#0.4");
 menuWrite() //--></script></div>
</div>

<div id="footer" class="bar">
	<p><form method="post" action="http://wiki.beyondunreal.com/wiki" enctype="application/x-www-form-urlencoded">
<a href="(start).html">Home Page</a> | <a href="recent-changes.html">Recent Changes</a> | <a href="http://wiki.beyondunreal.com/wiki?action=editprefs">Preferences</a><br>
<a href="http://wiki.beyondunreal.com/wiki?action=edit&id=Manual_Shift_Car">Edit text of this page</a> | <a href="http://wiki.beyondunreal.com/wiki?action=history&id=Manual_Shift_Car">View other revisions</a><br>Last edited May 19, 2006 19:18 <a href="http://wiki.beyondunreal.com/wiki?action=browse&diff=1&id=Manual_Shift_Car">(diff)</a><br>Search: <input type="text" name="search"  size="20" /><input type="hidden" name="dosearch" value="1"  /><br><br><small><a href="http://wiki.beyondunreal.com/wiki/Manual_Shift_Car">Original page</a> &#150; copy created Sat, Jun 23, 2007</small><div></div>
</form>
	</p>
	<p>Worst-case scenario: the UEd Goblin wipes the map and burns down your house.
</p>
</div>
</div><!-- close of "scrolling" div -->

<div id="quickbar">
	<div id="logo"><a href="http://wiki.beyondunreal.com/"><img src="shared/wikilogo.jpg" width="143" height="100" border="0"></a>
		</div>
	<div class="qbsitename">
		<p>The Unreal Engine Documentation Site</p>
	</div>
	<div class="qbsection">
<p><a href="metatopics.html">Wiki Community</a></p>
<p><a href="category-category.html">Topic Categories</a></p>
<p><a href="/cgi-bin/imageupload.cgi/wiki-ext/imageupload.htt" target="_blank ">Image Uploads</a></p>
<p><a href="http://wiki.beyondunreal.com/wiki?action=random">Random Page</a></p>
<p><a href="recent-changes.html">Recent Changes</a></p>
<p><a href="offline-wiki.html">Offline Wiki</a></p>
</div><div class="qbsection">
<p><a href="unreal-engine.html">Unreal Engine</a></p>
<p><a href="console-commands.html">Console Commands</a></p>
<p><a href="terminology.html">Terminology</a></p>
<p><a href="category-faq.html">FAQs</a></p>
<p><a href="help-desk.html">Help Desk</a></p>
</div><div class="qbsection">
<p><a href="topics-on-mapping.html">Mapping Topics</a></p>
<p><a href="mapping-lessons.html">Mapping Lessons</a></p>
<p><a href="unrealed-3.html">UnrealEd Interface</a></p>
</div><div class="qbsection">
<p><a href="unrealscript.html">UnrealScript Topics</a></p>
<p><a href="unrealscript-lessons.html">UnrealScript Lessons</a></p>
<p><a href="making-mods.html">Making Mods</a></p>
<p><a href="class-tree.html">Class Tree</a></p>
</div><div class="qbsection">
<p><a href="topics-on-modeling.html">Modeling Topics</a></p>
</div><div class="qbsection">
<p><a href="chongqing-page.html">Chongqing Page</a></p>
<p><a href="log-in.html">Log In</a></p></div>
</div>

</body></html>
